#!/usr/local/bin/perl
# File: epcrToPsl
# Author: Terry Furey
# Date: 7/17/2002
# Description:  Convert an output file from ePCR to a psl file

# $Id: epcrToPsl,v 1.1 2006/09/07 18:56:52 hiram Exp $

# USAGE message
if ($#ARGV < 3) {
  print stderr "USAGE: epcrToPsl [-mouse -rat -clones <sequence.inf>] <epcr file> <primers file> <accession_info.rdb> <fa dir>\n";
  exit(1);
}
$clones = 0;
$rat = 0;
$mouse = 0;
while ($#ARGV > 3) {
  $arg = shift(@ARGV);
  if ($arg eq "-clones") {
    $inf = shift(@ARGV);
    open(INF, "$inf") || die("Could not open $inf");
    $clones = 1;
  } elsif ($arg eq "-rat") {
    $rat = 1;
  } elsif ($arg eq "-mouse") {
    $mouse = 1;
  }
}
$file = shift(@ARGV);
open(FILE, "$file") || die("Could not open $file");
$primers = shift(@ARGV);
open(PRIMERS, "$primers") || die("Could not open $primers");
$info = shift(@ARGV);
open(INFO, "$info") || die("Could not open $info");
$dir = shift(@ARGV);

# Get chrom for each ctg
print stderr "Getting chromosome info\n";
$line = <INFO>;
$line = <INFO>;
while ($line = <INFO>) {
  chomp($line);
  @fields = split("\t",$line);
  ($chr,$random) = split("_",$fields[0]);
  $chr = substr($chr,3);
  $chr{$fields[5]} = $chr;
}

# Get phase for each clone
if ($clones) {
  while ($line=<INF>) {
    chomp($line);
    ($acc,$gi,$size,$phase,@rest) = split("\t",$line);
    $phase{$acc} = $phase;
  }
  close(INF);
}

# Read in the primers file
print stderr "Reading primer info\n";
while ($line = <PRIMERS>) {
  chomp($line);
  ($primerid, $left, $right, $distance, $id) = split(' ',$line);
  $primerleft{$primerid} = substr($left,0,7);
  $primerright{$primerid} = substr($right,0,7);
  @left = split(//,$left);
  $primerleftsize{$primerid}=$#left + 1;
  @right = split(//,$right);
  $primerrightsize{$primerid} = $#right + 1;
  if ($distance =~ /-/) {
    ($start,$end) = split("-",$distance);
     $size{$primerid} = int(($end - $start)/2) + $start;
  } else {
    $size{$primerid} = $distance;
  }
  $rightstart{$primerid} = $size{$primerid} - $primerrightsize{$primerid};
}
close(PRIMERS);

# Read in epcr file and output psl file
print stderr "Creating psl file\n";
open(OUT, ">${file}.psl");
open(ERR, ">${file}.nomatch");
while ($line = <FILE>) {
  chomp($line);
  ($ctg, $place, $dbsts, $ucsc) = split(' ',$line);
  if (($rat) || ($mouse)) {
    $ratname{$ucsc} = $dbsts;
    $dbsts = $ucsc;
  }
    my $chrom = $ctg;
    $chrom =~ s/^chr//;
  ($start, $end) = split(/\.\./,$place);
  $start--;
  $match = $primerleftsize{$dbsts} + $primerrightsize{$dbsts};
  $tsize = $end - $start;
  $tgap = 1;
  $tgapsize = $tsize - $match;
  $qgap = 1;
  $qgapsize = $size{$dbsts} - $match;
  $leftstart = $start;
  $rightstart = $end -  $primerrightsize{$dbsts};

  # Determine strand
  if ($clones) {
    $strand = "+";
  } else {
    $to = $start + 7;
    printf STDERR "/cluster/bin/i386/twoBitToFa $dir/mm8.2bit:${ctg}:$start-$to out.fa\n";
    `/cluster/bin/i386/twoBitToFa $dir/mm8.2bit:${ctg}:$start-$to out.fa`;

    open(FA, "out.fa") || die("out.fa does not exist - $dir/$chr{$chrom}/$ctg.fa");
    $find = <FA>;
    $find = <FA>;
    chomp($find);
    $find =~ tr/a-z/A-Z/;
    if ($find eq $primerleft{$dbsts}) {
      $strand = "+";
    } elsif ($find eq $primerright{$dbsts}) {
      $strand = "-";
    } else {
      @chars = split(//,$find);
      @left = split(//,$primerleft{$dbsts});
      @right = split(//,$primerright{$dbsts});
      $r = 0;
      $l = 0;
      for ($i = 0; $i < 7; $i++) {
	if ($chars[$i] eq $left[$i]) {
	  $l++;
	}
	if ($chars[$i] eq $right[$i]) {
	  $r++;
	}
      }
      if ($l > 5) {
	$strand = "+";
      } elsif ($r > 5) {
	$strand = "-";
      } else {
	$strand = "";
	print ERR "Could not determine strand for $line - $find ($primerleft{$dbsts}-$l,$primerright{$dbsts}-$r)\n";
      }
    }
    close(FA);
    `rm out.fa`;
  }
  # Print out record
  if ($strand) {
    print OUT "$match\t0\t0\t0\t$qgap\t$qgapsize\t$tgap\t$tgapsize\t$strand\t";
    if (($rat) || ($mouse)) {
      print OUT "$ratname{$dbsts}\t$size{$dbsts}\t0\t$size{$dbsts}\t$ctg\t0\t$start\t$end\t";
    } else {
      print OUT "dbSTS_$dbsts\t$size{$dbsts}\t0\t$size{$dbsts}\t$ctg\t0\t$start\t$end\t";
    }
    print OUT "2\t$primerleftsize{$dbsts},$primerrightsize{$dbsts},\t0,$rightstart{$dbsts},\t";
    print OUT "$leftstart,$rightstart,\n";
  }
}
close(FILE);
close(OUT);
