#!/usr/bin/perl -W

$rs=$b1=$b2=$seq5=$seq3=$valid=$seq5rc=$seq3rc="";
$het=$hetSE=$triallelic=0;

while (<>) 
{
    if (/<NSE-rs>/) 
    {
        RS: while (<>) 
	{
	    if (/<\/NSE-rs>/)
	    {
		if ((length($seq5)==0)||(length($seq3)==0)) {$seq5=$seq3=$seq5."nnnnnnnn".$seq3;}
		if ($valid eq "") {$valid="no-information;";}
		if ($b1 eq "") {$b1 = "?";}
		if ($b2 eq "") {$b2 = "?";}
		$valid = substr($valid,0,length($valid)-1);
		if (!($b1 =~ /\//) ) # removes triallelic SNPs
		{
		    print "$rs\t$het\t$hetSE\t$valid\t$b1\t$b2\t".substr($seq5,-20)."\t".substr($seq3,0,20)."\n";
		}
		else
		{
		    $triallelic++;
		}
		$rs=$b1=$b2=$seq5=$seq3=$valid=$seq5rc=$seq3rc="";
		$het=$hetSE=0.0;
		last RS;
	    }
	    if (/<(NSE-rs_refsnp-id)>(\S+)<\/\1>/)                  { $rs     = $2;           }
	    if (/<(NSE-rs_observed)>(\S+)\/(\S+)<\/\1>/)            { $b1     = $2; $b2 = $3; }
	    if (/<(NSE-rs_seq-5_E)>(\S+)<\/\1>/)                    { $seq5  .= $2;           }
	    if (/<(NSE-rs_seq-3_E)>(\S+)<\/\1>/)                    { $seq3  .= $2;           }
	    if (/<(NSE-rs_het)>(\S+)<\/\1>/)                        { $het   += $2;           }
	    if (/<(NSE-rs_het-SE)>(\S+)<\/\1>/ && ( $2 ne "NaN" ) ) { $hetSE += $2;           }
	    if (/<NSE-rs_validated-(\S+) value=\"true\"\/>/)        { $valid .= "$1;";        }
	}
    }
}

# print "\n$triallelic triallelic SNPs have been removed.\n\n";

# need to read alleles into hash for compatibility with indels,
# multiple alleles, and multinucleotide polymorphisms: there may be
# more than two cases, and they may be of a length greater than one,
# so a static definition or an array would not work as well
