#!/usr/bin/perl
# File: calcFlipSnpPos
# Author: Daryl Thomas
# Date: 3/2002; 5/2002
# Description: Calculate SNP positions in flipped contigs
#              based on :
## File: revCompNcbiCtgFa
## Author: Terry Furey
## Date: 10/2001
## Description: Reverse complement NT_XXXX.fa that need to be
##              based on the NCBI build

# Usage message
if ($#ARGV != 2) {
  print stderr "USAGE: calcFlipSnpPos seq_contig.md gp.ncbi.b29 gp.ncbi.b29.flipped\n";
  exit(1);
}

# Read in and check arguments
$contigFile = shift(@ARGV);
$buildFile = shift(@ARGV);
$flippedBuildFile = shift(@ARGV);
open(CFILE, "<$contigFile")       || die("Could not open $contigFile\n");
open(BFILE, "<$buildFile")        || die("Could not open $buildFile\n");
open(FFILE, ">$flippedBuildFile") || die("Could not open $flippedBuildFile\n");

%contigLen = ();

# Process each line in the seq_contig.md file
# which lists the contigs and orientations in the build
while ($line = <CFILE>) {

  chomp($line);
  ($build, $thischr, $start, $end, $orien, $thisctg, $id, $type, $weight) = split("\t",$line);

  next if ($orien ne "-");

  ($ctg, $vers)  = split(/\./, $thisctg);
  ($chr, $other) = split(/\|/, $thischr);
  $contigLen{$ctg} = $end - $start + 1;
}

while ( $line = <BFILE> ) {
  chomp $line;
  ($rsId, $type, $thisChrCtg, $oldPos) = split("\t",$line);
  ($chr, $thisCtg) = split(/\//, $thisChrCtg);
  ($ctg, $ver) = split(/\./, $thisCtg);
  if ( defined $contigLen{$ctg} ) {
    $newPos = $contigLen{$ctg} - $oldPos + 1;
    print FFILE ("$rsId\t$type\t$thisChrCtg\t$newPos\n");
  } else {
    print FFILE ("$line\n");
  }
}
