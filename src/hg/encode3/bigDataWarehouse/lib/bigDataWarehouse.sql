# bigDataWarehouse.sql was originally generated by the autoSql program, which also 
# generated bigDataWarehouse.c and bigDataWarehouse.h.  This creates the database representation of
# an object which can be loaded and saved from RAM in a fairly 
# automatic way.

#Someone who submits files to or otherwise interacts with big data warehouse
CREATE TABLE bdwUser (
    sid char(64) not null,	# sha512 generated unique user ID.
    access char(64) not null,	# access code
    email varchar(255) not null,	# Email handle, the main identifier.
              #Indices
    PRIMARY KEY(sid)
);

#An external data hub we have collected files from
CREATE TABLE bdwHub (
    id int unsigned not null auto_increment,	# Autoincremented hub id
    url longblob not null,	# Hub url - points to directory containing hub.txt file
    shortLabel varchar(255) not null,	# Hub short label from hub.txt file
    longLabel varchar(255) not null,	# Hub long label
    lastOkTime bigint not null,	# Last time hub was ok in seconds since 1970
    lastNotOkTime bigint not null,	# Last time hub was not ok in seconds since 1970
    firstAdded bigint not null,	# Time hub was first seen
    errorMessage longblob not null,	# If non-empty contains last error message from hub. If empty hub is ok
              #Indices
    PRIMARY KEY(id)
);

#An external host we have collected files from
CREATE TABLE bdwHost (
    id int unsigned not null auto_increment,	# Autoincremented host id
    name varchar(255) not null,	# Name (before DNS lookup)
    lastOkTime bigint not null,	# Last time hub was ok in seconds since 1970
    lastNotOkTime bigint not null,	# Last time hub was not ok in seconds since 1970
    firstAdded bigint not null,	# Time host was first seen
    errorMessage longblob not null,	# If non-empty contains last error message from host. If empty host is ok
              #Indices
    PRIMARY KEY(id)
);

#A data submission, typically containing many files.
CREATE TABLE bdwSubmission (
    id int unsigned not null auto_increment,	# Autoincremented submission id
    startUploadTime bigint not null,	# Time at start of submission
    endUploadTime bigint not null,	# Time at end of upload - 0 if not finished
    userSid char(64) not null,	# Connects to user table sid field
    hubId int unsigned not null,	# Connect to hub table id field
    errorMessage longblob not null,	# If non-empty contains last error message from host. If empty host is ok
              #Indices
    PRIMARY KEY(id)
);

#A file we are tracking that we intend to and maybe have uploaded
CREATE TABLE bdwFile (
    id int unsigned not null auto_increment,	# Autoincrementing host id
    submission int unsigned not null,	# Links to id in submission table
    hubFileName longblob not null,	# File name in hub
    bdwName char(1) not null,	# A abc123 looking license-platish thing
    bdwFileName longblob not null,	# File name in big data warehouse
    startUploadTime bigint not null,	# Time when upload started - 0 if not started
    endUploadTime bigint not null,	# Time when upload finished - 0 if not finished
    updateTime bigint not null,	# Update time (on hub it was downloaded from)
    size bigint not null,	# File size
    md5 char(32) not null,	# md5 sum of file contents
    tags longblob not null,	# CGI encoded name=val pairs from manifest
              #Indices
    PRIMARY KEY(id)
);

#A program that wants to be called when a file arrives or a submission finishes
CREATE TABLE bdwSubscribingProgram (
    id int unsigned not null,	# ID of daemon
    filePattern varchar(255) not null,	# A string with * and ? wildcards to match files we care about
    hubPattern varchar(255) not null,	# A string with * and ? wildcards to match hub URLs we care about
    tagPattern varchar(255) not null,	# A string of cgi encoded name=val pairs where vals have wildcards
    onFileStartUpload varchar(255) not null,	# A unix command string to run with a %u where file id goes
    onFileEndUpload varchar(255) not null,	# A unix command string to run with a %u where file id goes
    onSubmissionStartUpload varchar(255) not null,	# A unix command string to run with %u where submission id goes
    onSubmissionEndUpload varchar(255) not null,	# A unix command string to run with %u where submission id goes
              #Indices
    PRIMARY KEY(id)
);
