#!/bin/csh -f # set emacs mode
exit; # don't actually run this like a script :)

# Ciona Intestinalis V1.0 from JGI

DOWNLOAD SEQUENCE 

    ssh eieio
    mkdir /cluster/store5/squirt
    cd /cluster/store5/squirt
    wget ftp://ftp.jgi-psf.org/pub/JGI_data/Ciona/v1.0/ciona.rm.fasta.gz
    gunzip ciona.rm.fasta

    # translate to nib
    ln -s /cluster/store5/squirt/ci1 ~/ci1
    cd ~/ci1
    mkdir scaffolds

    faSplit byname ciona.rm.fasta scaffolds/

    mkdir nib
    cd nib
    foreach i (../scaffolds/*.fa)
        faToNib $i `basename $i .fa`.nib
    end

CREATE DATABASE
    # Create the database.
    ssh hgwdev
    echo 'create database ci1' | hgsql ''


CREATING GRP TABLE FOR TRACK GROUPING 
    ssh hgwdev
    echo "create table grp (PRIMARY KEY(NAME)) select * from rn1.grp" \
      | hgsql ci1


MAKE HGCENTRALTEST BLATSERVERS ENTRY FOR SC1 (TODO)
    ssh hgwdev
    echo 'insert into blatServers values("ci1", "blat10", "17780", "1"); \
          insert into blatServers values("ci1", "blat10", "17781", "0");' \
      | hgsql -h genome-testdb hgcentraltest

STORING O+O SEQUENCE AND ASSEMBLY INFORMATION
    # Make symbolic links in /gbdb/ci1/nib to the real nibs.
    ssh hgwdev
    mkdir -p /gbdb/ci1/nib
    foreach f (/cluster/store5/squirt/ci1/nib/*.nib)
      ln -s $f /gbdb/ci1/nib
    end
    # Load /gbdb/ci1/nib paths into database 
    hgsql ci1  < ~kent/src/hg/lib/chromInfo.sql
    cd ~/ci1
    hgNibSeq -preMadeNib ci1 /gbdb/ci1/nib scaffolds/*.fa

    # make gcPercent table
    ssh hgwdev
    mkdir -p ~/ci1/bed/gcPercent
    cd ~/ci1/bed/gcPercent
    hgsql ci1  < ~/kent/src/hg/lib/gcPercent.sql
    hgGcPercent ci1 ../../nib

    # Human Blat
    ssh kk                                          
    mkdir ~/ci1/bed/blatHuman                        
    cd ~/ci1/bed/blatHuman                           
    ls -1S /scratch/hg/gs.16/build33/trfFa/*.fa > human.lst
    ls -1S /iscratch/i/squirt/ci1/scaffolds/* > squirt.lst        
    mkdir psl                                       
    cd psl
    foreach i (../../../nib/*.nib)
	mkdir `basename $i .nib`
    end
    gensub2 squirt.lst human.lst gsub spec              

    <para procedure>

    ssh eieio                                       
    cd ~/ci1/bed/blatHuman
    pslCat -dir psl/* | pslSortAcc nohead chrom /tmp stdin

    # FUGU Blat
    ssh kk                                          
    mkdir ~/ci1/bed/blatFugu                        
    cd ~/ci1/bed/blatFugu                           
    ls -1S /iscratch/i/fugu/* > fugu.lst            
    ls -1S /scratch/hg/ci1/nib/* > squirt.lst        
    mkdir psl                                       
    cd psl
    foreach i (../../../nib/*.nib)
	mkdir `basename $i .nib`
    end
    gensub2 squirt.lst fugu.lst gsub spec              

    <para procedure>

    ssh eieio                                       
    cd ~/ci1/bed/blatFugu                           
    pslCat -dir psl/* | pslSortAcc nohead chrom /tmp stdin

    # load into database:
    ssh hgwdev
    cd ~/ci1/bed/blatFugu/chrom
    foreach i (*.psl)
        set r = $i:r
        mv $i ${r}_blatFugu.psl
    end
    hgLoadPsl ci1 *.psl
    mkdir -p /gbdb/ci1/fuguSeq
    cd /gbdb/ci1/fuguSeq
    ln -s /cluster/store3/fuguSeq/fugu_v3_mask.fasta
    cd /tmp
    hgLoadRna addSeq ci1 /gbdb/ci1/fuguSeq/fugu_v3_mask.fasta

    # load cpgIslands
    ssh kkstore
    mkdir -p ~/ci1/bed/cpgIsland
    cd ~/ci1/bed/cpgIsland
    cp ~kent/mm3/bed/cpgIsland/cpg_dist/cpglh.exe .
    foreach f (../../scaffolds/*.fa)
	g=`basename $f .fa`.cpg
	./cpglh.exe $f > $g
    end
    cp ~kent/mm3/bed/cpgIsland/filter.awk .
    awk -f filter.awk *.cpg > cpgIsland.bed
    # Load into db
    ssh hgwdev
    cd ~/ci1/bed/cpgIsland
    hgLoadBed ci1 cpgIsland -tab -noBin \
       -sqlTable=$HOME/kent/src/hg/lib/cpgIsland.sql cpgIsland.bed

    # Load genbank entries
    cd /cluster/store5/genbank
    ./bin/gbDbLoadStep -noPerChrom=ci1 -initialLoad ci1 
    # ./bin/i386/gbLoadRna -drop ci1

