#!/bin/bash -e
##download ensembl or vega mysql tables
[ $# != 3 ] && echo "usage: ensemblDownload species version output-directory" >&2 && echo "   for example: ensemblDownload homo_sapiens core_43_36e /cluster/store8/ensembl/ensembl_core_43_36e" >&2 && exit 1;
organism=$1
version=$2
outdir=$3
input="ftp://ftp.ensembl.org/pub/current_$organism/data/mysql/${organism}_${version}"
sql="$input/${organism}_${version}.sql.gz"
mkdir -p $outdir
cd $outdir
#get sql definition for all tables
wget --timestamping --no-verbose $sql 2>> download.log
#get list of tables excluding big alignment tables and others
zgrep CREATE ${organism}_${version}.sql.gz |awk -F'`' '{print $2}' > tables.tmp
exceptions="dna|dna_align_feature|oligo|protein_align_feature|repeat_feature"
tables=`cat tables.tmp |grep -v -E $exceptions`
#go get them! (if not already downloaded)
echo "Starting download to $outdir from $input. "
echo "Use tail -f download.log to watch progress"
for i in $tables; do wget --timestamping --no-verbose $input/${i}.txt.table.gz; done  2>> download.log
zcat seq_region.txt.table.gz | sed -e 's/GeneScaffold/scaffold/'  > seq_region.txt.table
gzip -f seq_region.txt.table
