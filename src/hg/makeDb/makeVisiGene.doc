# CREATE EMPTY DATABASE AND TABLES.
hgsql -e "create database visiGeneNew" mysql
hgsql visiGeneNew < ~/kent/src/hg/visiGene/visiGene.sql
makeTableDescriptions visiGeneNew ~/kent/src/hg/visiGene/visiGene.as

# LOAD PAUL GRAY/MAHONEY LAB DATA.
# Transferred images from Paul Gray's Mac to mine and converted
# his spreadsheet to a tab-separated file, cloning.tab.
cd ~/kent/src/hg/visiGene/vgLoadMahoney
vgLoadMahoney /gbdb/visiGene mm5 cloning.tab clonePcr.bed outDir
cd outDir
visiGeneLoad whole.ra whole.tab /dev/null -database=visiGeneNew
visiGeneLoad slices.ra slices.tab /dev/null -database=visiGeneNew

# LOAD JACKSON LABS DATA.
# First ask Galt to create a local copy of the Jackson labs
# database.  I'm not sure how he did it.
cd ~/kent/src/hg/visiGene/vgLoadJax
vgLoadJax /gbdb/visiGene jackson visiGene
./loadNew

# Update the privateUser fields where we don't have permissions by entering
# this at the mysql prompt.
update submissionSet,journal set submissionSet.privateUser=-1 
   where (journal.name like 'Nat %' or journal.name = 'Nature')  
   and submissionSet.journal = journal.id and submissionSet.name like 'jax%'

# LOAD NIBB IMAGES
# Do this after creating the nibbImageProbe.fa file as described
# in makeXenTro1.doc, and after creating the nibbImageProbes table
# in hg17 as describe in makeHg17.doc.  The image files are
# loaded in /cluster/store11/visiGene/offline/nibbFrog.
ssh kolossus
cd /cluster/store11/visiGene/offline
nibbParseImageDir nibbFrog nibFrog.tab bad.tab
nibbPrepImages nibbFrog nibFrog.tab \
	/cluster/store11/visiGene/gbdb/200/inSitu/XenopusLaevis/nibb \
	/cluster/store11/visiGene/gbdb/full/inSitu/XenopusLaevis/nibb
# Note the nibbPrepImages step is a 2 day process, next time may
# want to run it on the kki cluster.  It does need to be run on a 64
# bit machine because of bugs in the 32 bit image magick convert program.

ssh hgwdev
cd ~/kent/src/hg/visiGene/vgLoadNibb
hgMapToGene hg17 nibbImageProbes knownGene knownToNibbImage

# Now go into the gene sorter on hg17, configure it to just show
# the name, genbank, and NIBB Xenopus columns.  Filter on * in the
# NIBB Xenopus column (which will get rid of rows with no data in that
# column).  Save the text output to names.raw.  Then get rid of names
# that are no more than genbank accessions as so:
awk '$1 != $2 {printf("%s\t%s\n", $1, $3);}' names.raw > names.txt

# Now create the .tab and .ra files as so:
vgLoadNibb /cluster/store11/visiGene/offline/nibbFrog \
	/cluster/store11/visiGene/offline/nibbFrog.tab \
	/cluster/data/xenTro1/bed/nibbPics/nibbImageProbes.fa \
	names.tab stage.tab outDir
visiGeneLoad outDir/nibb.ra outDir/nibb.tab /dev/null -database=visiGeneNew


# LOAD GENSAT IMAGES
# This was done with the assistance of Mike Dicuccio at NCBI, 
# dicuccio@ncbi.nlm.nih.gov.  If updating probably it's best to
# get in touch with him and make sure that the ftp site is up to
# date.   

# Download data from NCBI into /cluster/store11/visiGene/offline/gensat
cd /cluster/store11/visiGene/offline
mkdir gensat
cd gensat
mkdir RawData
cd RawData
wget --timeStamping ftp://ftp.ncbi.nih.gov/pub/gensat/RawData/GENSAT-20051120.xml.gz
wget --timeStamping ftp://ftp.ncbi.nih.gov/pub/gensat/RawData/NCBI_Gensat-20051120.dtd

# At this point if the dtd has changed you may need to remake 
# kent/src/hg/visiGene/gensat/lib/gs.c with autoXml.  Once
# this is done then do the download with gensatImageDownload.
# It'll take about 3 days. The results will be in the Institutions dir.
cd /cluster/store11/visiGene/offline/gensat
zcat RawData/GENSAT-20051120.xml.gz | gensatImageDownload . download.log

# Create parasol directory and a list of the jpg files.
ssh kki
cd /cluster/store11/visiGene/offline/gensat
mkdir prepImageRun
find Institutions -name '*.jpg' -print | sed 's/Institutions\//' > prepImageRun/jpg.lst
cd prepImageRun

# Create parasol batch
cat << '_EOF_' > gsub
#LOOP
vgPrepImage /cluster/store11/visiGene/offline/gensat/Institutions /cluster/store11/
visiGene/gbdb/200/inSitu/Mouse/gensat /cluster/store11/visiGene/gbdb/full/inSitu/Mo
use/gensat $(path1)
#ENDLOOP
'_EOF_'
# << this line makes emacs coloring happy
gensub2 jpg.lst single gsub spec
para make spec

# Note the above procedure would take about 3 days.  I ended up copying the
# data over to /san/sanvol1, and doing it on the pita cluster.  The job
# there just took two hours, with just 100 cpus available.  It took
# an hour to copy the data over, and eight hours to copy it back though,
# and some tweaking.

# MAKE FULL TEXT INDEX
cd /cluster/store11/visiGene/gbdb
vgGetText visiGene.text mm7 hg17
ixIxx visiGene.text visiGene.ix visiGene.ixx


# (Galt 2006-02)
# RSYNC'd from /cluster/store11/visiGene to /san/sanvol1/visiGene
# and moved the /gbdb/visiGene symlink to point to the new location.
# I also had to manually run a script to find symlinks pointing from full/ over to 
# /cluster/store11/offline and remake them to point correctly to /san/sanvol1/visiGene/offline.

# Allen Brain Atlas jp2 image prep (Galt 2006-02-12)
# Create parasol directory and a list of the jpg files.
ssh pk
cd /san/sanvol1/visiGene/offline/allenBrain
mkdir prepImageRun
find imageDisk -name '*.jp2' -print | sed 's/imageDisk\///' > prepImageRun/jpg.lst
cd prepImageRun
# Create parasol batch
cat << '_EOF_' > gsub
#LOOP
vgPrepImage /san/sanvol1/visiGene/offline/allenBrain/imageDisk /san/sanvol1/visiGene/gbdb/200/inSitu/Mouse/allenBrain /san/sanvol1/visiGene/gbdb/full/inSitu/Mouse/allenBrain $(path1)
#ENDLOOP
'_EOF_'
# << this line makes emacs coloring happy
gensub2 jpg.lst single gsub spec
para make spec -maxNode=50

[pk:/san/sanvol1/visiGene/offline/allenBrain/prepImageRun> /parasol/bin/para time
11748 jobs in batch
4291 jobs (including everybody's) in Parasol queue.
Checking finished jobs
Completed: 11748 of 11748 jobs
CPU time in finished jobs:     474919s    7915.32m   131.92h    5.50d  0.015 y
IO & Wait Time:               5029116s   83818.60m  1396.98h   58.21d  0.159 y
Average job time:                 469s       7.81m     0.13h    0.01d
Longest running job:                0s       0.00m     0.00h    0.00d
Longest finished job:           41811s     696.85m    11.61h    0.48d
Submission to last job:        172301s    2871.68m    47.86h    1.99d


# -maxNode=50 was needed. 
# Note that because it opens up to 40 output files at the same time, it overwhelms NFS
# when a lot of nodes are running, it can bring down the SAN.  Because I was nearly
# done when it came back up, I just re-pushed with -maxNode=50 to keep it under control.
# However in the future, something like this should be done to keep the file access local
# as much as possible.
# Here is the proposed new way:
# -----------------------
cat << '_EOF_' > gsub
#LOOP
./vgPrep.csh $(path1) $(root1) $(file1)
#ENDLOOP
'_EOF_'
# << this line makes emacs coloring happy

cat << '_EOF_' > vgPrep.csh
#!/bin/tcsh
mkdir -p /san/sanvol1/visiGene/gbdb/200/inSitu/Mouse/allenBrain/$1
mkdir -p /san/sanvol1/visiGene/gbdb/full/inSitu/Mouse/allenBrain/$1
cp /san/sanvol1/visiGene/offline/allenBrain/imageDisk/$1 /scratch/tmp/$3
vgPrepImage /san/sanvol1/visiGene/offline/allenBrain/imageDisk /scratch/tmp/vg200$2 /scratch/tmp/vgfull$2 $1
set err = $status
if (! $err ) then
    cp -r /scratch/tmp/vg200$2/* /san/sanvol1/visiGene/gbdb/200/inSitu/Mouse/allenBrain
    cp -r /scratch/tmp/vgfull$2/* /san/sanvol1/visiGene/gbdb/full/inSitu/Mouse/allenBrain
endif
rm -f  /scratch/tmp/$3
rm -fr /scratch/tmp/vg200$2
rm -fr /scratch/tmp/vgfull$2
if ( $err ) then
    exit 1
endif
'_EOF_'
# << this line makes emacs coloring happy

# -----------------------

# ADDED TWO ADDITIONAL ZOOM-OUT LEVELS 5 AND 6:
# Ran /san/sanvol1/offline/level56Run/ cluster jog on a list of all files dumped
#  from the visiGene.imageFile table so that we made new zoom out levels 5 and 6
#  for all pictures.  Since it was a special one-time deal, I just used ImageMagick.
# vgPrepImage.c has been modified to do the 2 new zoomout levels so that they
#  will be built automatically in future.

# Ran several checks to make sure no files were missing, fixed any errors.
# Found embedded space in some nibb filenames, found a couple of gensat 
# images which had previously failed to download and redownloaded them ok.
# Found a few missing things and 0 bytes jpgs and re-ran them.  
# It should be pretty clean right now.

# LOAD ALLEN BRAIN DATA
vgLoadAllen \
 /san/sanvol1/visiGene/gbdb/full/inSitu/Mouse/allenBrain \
 /san/sanvol1/visiGene/offline/allenBrain/probesAndData/allen20051021.tab \
 /cluster/data/mm7/bed/allenBrain/allProbes.fa \
 /cluster/data/mm7/bed/allenBrain/allProbes.tab \
 output
#backed-up data in case of trouble:
mkdir /san/sanvol1/visiGene/dump/visiGene.20060220
hgsqldump visiGene -T /san/sanvol1/visiGene/dump/visiGene.20060220
#load into visiGene db
visiGeneLoad -database=visiGene output/aba.ra output/aba.tab /dev/null

# Manually added several researchers names to the contributor and submissionContributor tables
# at the request of Susan Sunkin as well as updating the text for contributor, copyright, acknowledgements.
# I manually also updated aba.ra and vgLoadAllen.c to reflect her changes.  The manual mods
# to contributor which work great in the visiGene search are not currently automatically
# supported, and would thus be lost if we ever nuke it and start fresh.
# At some point, we will probably add an additional field to the .ra structure
# and have visiGeneLoad support it.

# RE-MAKE FULL TEXT INDEX
cd hg/visiGene/vgGetText
make alpha
# basically does this, but puts it in cgi-bin/visiGeneData/:
#vgGetText visiGene.text mm7 hg17
#ixIxx visiGene.text visiGene.ix visiGene.ixx
# (hgVisiGene cgi v128 now knows about this new location)

############################

# REBUILD WITH NEW vgProbeTrack PROGRAM - AFTER ADDING ALLEN BRAIN (DONE galt 2006-03-15)

# (make a backup of visiGene db and these tables: {mm6,mm7,...}.vgProbes and {hg17,hg18,...}.vgAllProbes
cd /san/sanvol1/visiGene/dump
# (this backup shown is really an example template for the next person who needs to do this)
mkdir visiGene20060315
cd visiGene20060315
hgsqdump visiGene -T .
mkdir mm6
hgsqdump visiGene vgProbes -T mm6
mkdir mm7
hgsqdump visiGene vgProbes -T mm7
mkdir mm8
hgsqdump visiGene vgProbes -T mm8
mkdir hg17
hgsqdump visiGene vgAllProbes -T hg17
mkdir hg18
hgsqdump visiGene vgAllProbes -T hg18
#(do any others needed that might not be listed here)
#(document the reason for making the backup)
echo 'vgLoadAllenBrain has been run, so making backup of visiGene db and probe tracks before updating, ' > README

# OK, NOW USE vgProbeTrack TO UPDATE

cd ~/kent/src/hg/visiGene/vgProbeTrack

# -sqlPath must be included whenever the vgProbes or vgAllProbes track tables do not yet exist for the db
# so it can find the .sql script to create vgProbes or vgAllProbes tables as needed.
# I happen to know that only AllenBrain was updated since last time, and that is mouse only

# populate vgPrb with any new stuff in visiGene.probe (works for all taxons at once).
vgProbeTrack POP

# find sequence using various methods - given probe seq, primers, bacs, refseq, etc.
#  must specify a specific assembly to use, so just using mm7 since mm8 still in qa.
#  this finds any stuff for the mouse taxon
vgProbeTrack SEQ working mm7  

# create alignments using either refSeqAli or all_mrna or bacEnds or blat.  Took 1.5 hours.  
# alignments are individually tracked per assembly here
# alignment successes go in $db.vgProbes psl track, and whether succeeded or failed,
# it only looks for things that have not already attempted alignment
# the status goes into visiGene.vgPrbAli with .db="mm7"
# because mm7.vgProbes is a new table, to create it we include the -sqlPath so
# it can find the vgProbes.sql script
vgProbeTrack ALI working mm7 -sqlPath=..

# this finds any seq required for mm7.vgProbes track not already in mm7.seq 
# adds the new .fa file in /cluster/data/mm7/bed/visiGene/
# adds a symlink to it in /gbdb/mm7/visiGene/
# and runs hgLoadSeq mm6 /gbdb/mm7/visiGene/vgPrbExt_??????.fa to add it to mm7.seq
vgProbeTrack EXT working mm7

# mm6.vgProbes was already complete from previous probe track creation, 
#  it just needed to catch the new Allen Brain probes and align them.  About 1.5 hours.
vgProbeTrack ALI working mm6
vgProbeTrack EXT working mm6

# hg17.vgAllProbes was pre-existing with all probes, just need to add new allenBrain mouse
# this internally uses pslMap against the mm7 to hg17 liftover chain.gz
# Because it is "Xeno" (from mouse to human), it creates track vgAllProbes,
# and maintains the list of processed alignments in visiGene.vgPrbAliAll.
vgProbeTrack PSLMAP working hg17 mm7  
# updates hg17.seq/extFile similarly to the EXT command, but for All probes.
# just like with EXT, EXTALL puts .fa in /cluster/data/hg17/visiGene
# and symlink in /gbdb/hg17/visiGene and updates using hgLoadSeq.
# if a sequence has already been loaded it will not be loaded again.
vgProbeTrack EXTALL working hg17

# hg18.vgAllProbes never existed before
vgProbeTrack PSLMAP working hg18 mm7  -sqlPath=..
# because the nibb blatz probe track hg18.nibbImageProbes was never done on hg18 
# until just now (see makeHg18.doc), we have to add it for the first time.
# "nibb" is not really a db here, so I manually put in a taxon mapping for it, 
# so it appears as Xenopus laevis 8355, see the source code.
vgProbeTrack REMAP working hg18 nibb nibbImageProbes /gbdb/hg18/nibbImageProbes.fa  
vgProbeTrack EXTALL working hg18

# mm8 is in qa and so it is basically ready to use now.  About 1.5 hours.
vgProbeTrack ALI working mm8  -sqlPath=..
vgProbeTrack EXT working mm8


# RE-MAKE knownToVisiGene tables (see respective makedocs for these)
#knownToVisiGene mm6
#knownToVisiGene mm7
#knownToVisiGene mm8
#knownToVisiGene hg17 -fromProbePsl=vgAllProbes
#knownToVisiGene hg18 -fromProbePsl=vgAllProbes

############################

###  JACKSON UPDATE CONTINUED (done 2006-04-01 galt)  #############

# updated jackson20060328 db on kkr3u00 (see hg/visiGene/jackson/makeJackson.doc)

# Dropped old visiGeneOld db, asked Heather to clone visiGene db to visiGene db,
# and then ran this query to remove the old previous JAX info:
# MULTI-TABLE DELETE:
delete submissionSource, submissionSet, submissionContributor, image,
imageProbe, expressionLevel, imageFile from
submissionSource so,
submissionSet ss,
submissionContributor sc,
image i,
imageProbe ip,
expressionLevel el,
imageFile f
where so.id = 2
and ss.submissionSource = so.id
and sc.submissionSet = ss.id
and i.submissionSet = ss.id
and ip.image = i.id
and el.imageProbe = ip.id
and f.submissionSet = ss.id;

#delete query (get rid of all submissionSource.id=2)
#Query OK, 164717 rows affected (48 min 16.07 sec)

# Workaround for uniProt access from kkr3u00
ssh hgwdev
setenv jdb jackson20060328
cd ~/kent/src/hg/visiGene/vgLoadJax
hgsqldump uniProt taxon commonName -T .
ssh kkr3u00
setenv jdb jackson20060328
cd ~/kent/src/hg/visiGene/vgLoadJax
hgsql mysql -e "create database uniProt"
hgsql uniProt < taxon.sql
hgsql uniProt < commonName.sql
# hgsql uniProt -e 'show tables'
hgsql uniProt -e "load data local infile 'taxon.txt' into table taxon"
hgsql uniProt -e "load data local infile 'commonName.txt' into table commonName"
# hgsql uniProt -e 'show table status\G'
# cleanup
rm taxon.*
rm commonName.*

#run vgLoadJax to create .ra .tab .txt for each submissionSet
ssh kkr3u00
setenv jdb jackson20060328
cd ~/kent/src/hg/visiGene/vgLoadJax
#remove any old data dir
rm -fr visiGene/
#compiled vgLoadJax on dev
# visiGene in line below is just an output dir for the .ra/.tab/.txt files
~/bin/i386/vgLoadJax /san/sanvol1/visiGene/gbdb jackson20060328 visiGene
#ref 32185: missing title from BIB_Refs, ref skipped
#Calculating age from postnatal
#ref 67768: missing title from BIB_Refs, ref skipped
#Calculating age from postnatal month 3
#Calculating age from postnatal
#Calculating age from postnatal
#Calculating age from postnatal month 4
#Calculating age from postnatal month 4
#Calculating age from Not Specified 12.5
#refCount=2970


#ran loadAll to load the updated jax .ra .tab .txt into visiGene db
ssh hgwdev
cd ~/kent/src/hg/visiGene/vgLoadJax
loadAll
#loadAll.output has 1112 lines like
#visiGene/100423.ra

# ran vgGetText to update cgi-bin-galt/visiGeneData/ using visiGene db
cd ~/kent/src/hg/visiGene/vgGetText
make alpha
# output:
#vgGetText /usr/local/apache/cgi-bin/visiGeneData/visiGene.text mm7 hg17
#probe has 19276 rows
#gene has 15173 rows
#imageProbe has 115500 rows


# recompiled hgVisiGene 


