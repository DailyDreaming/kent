# for emacs: -*- mode: sh; -*-
#
#	the above keeps emacs happy while working with this text document

# This file describes how we made the browser database on the
#	Melopsittacus undulatus - budgerigar
#	WashU St. Louis - http://genome.wustl.edu/

#	http://www.ncbi.nlm.nih.gov/bioproject/72527
#	http://www.ncbi.nlm.nih.gov/genome/10765
#	http://www.ncbi.nlm.nih.gov/genome/assembly/325078/
#	http://www.ncbi.nlm.nih.gov/Traces/wgs/?val=AGAI01
#	Genome Coverage : 16x 454; 7x Illumina

#	http://www.ncbi.nlm.nih.gov/bioproject/19105 - chrMt
#	chrMt NC_009134.1 - EF450826.1

#	DATE:	13-Sep-2011
#	ORGANISM:	Melopsittacus undulatus
#	TAXID:	13146
#	ASSEMBLY LONG NAME:	Melopsittacus undulatus Budgerigar Version 6.3
#	ASSEMBLY SHORT NAME:	Melopsittacus_undulatus_6.3
#	ASSEMBLY SUBMITTER:	Washington University School of Medicine
#	ASSEMBLY TYPE:	Haploid
#	NUMBER OF ASSEMBLY-UNITS:	1
#	ASSEMBLY ACCESSION:	GCA_000238935.1
#	FTP-RELEASE DATE: 02-Jan-2012

#	Eukaryota; Opisthokonta; Metazoa; Eumetazoa; Bilateria; Coelomata;
#	Deuterostomia; Chordata; Craniata; Vertebrata; Gnathostomata;
#	Teleostomi; Euteleostomi; Sarcopterygii; Tetrapoda; Amniota;
#	Sauropsida; Sauria; Archosauria; Dinosauria; Saurischia; Theropoda;
#	Coelurosauria; Aves; Neognathae; Psittaciformes; Psittacidae;
#	Melopsittacus


#########################################################################
## Download sequence (DONE - 2012-03-26 - Hiram)
    mkdir /hive/data/genomes/melUnd1
    mkdir /hive/data/genomes/melUnd1/genbank
    cd /hive/data/genomes/melUnd1/genbank

    time rsync -a -P \
rsync://ftp.ncbi.nlm.nih.gov/genbank/genomes/Eukaryotes/vertebrates_other/Melopsittacus_undulatus/Melopsittacus_undulatus_6.3/ ./
    #	real    4m16.584s

    faSize Primary_Assembly/unplaced_scaffolds/FASTA/unplaced.scaf.fa.gz
# 1117355426 bases (30758804 N's 1086596622 real 1086596622 upper 0 lower)
#	in 25211 sequences in 1 files
# Total size: mean 44320.2 sd 774121.2 min 228 (gi|366922013|gb|JH533144.1|)
#	max 39887635 (gi|366898540|gb|JH556617.1|) median 1201

    faCount Primary_Assembly/unplaced_scaffolds/FASTA/unplaced.scaf.fa.gz \
	> faCount.txt
     egrep -v "^#seq|^total" faCount.txt \
	| awk '{printf "%s\t%d\n", $1, $2}' \
	| sed -e 's/^gi.*gb|//; s/|//' | sort -k2,2nr > chrom.sizes

    n50.pl chrom.sizes
#       reading: chrom.sizes
#       contig count: 25211, total size: 1117355426, one half size: 558677713
# cumulative    N50 count       contig  contig size
549534897       27      JH556592.1      11405270
558677713 one half size
560149280       28      JH556573.1      10614383

#########################################################################
# process into UCSC naming scheme (DONE - 2012-03-27 - Hiram)
    mkdir /hive/data/genomes/melUnd1/ucsc
    cd /hive/data/genomes/melUnd1/ucsc

    # verify we don't have any .acc numbers different from .1
    zcat \
    ../genbank/Primary_Assembly/unplaced_scaffolds/AGP/unplaced.scaf.agp.gz \
	| cut -f1 | egrep "^JH|AGAI" \
	| sed -e 's/^JH[0-9][0-9]*//; s/^AGAI[0-9][0-9]*//' | sort | uniq -c
    #	116513 .1

    # this is like the unplaced.pl script in other assemblies except it
    #	does not add chrUn_ to the names since they are all just scaffolds

    cat << '_EOF_' > unplaced.pl
#!/bin/env perl

use strict;
use warnings;

my $agpFile =  "../genbank/Primary_Assembly/unplaced_scaffolds/AGP/unplaced.scaf.agp.gz";
my $fastaFile =  "../genbank/Primary_Assembly/unplaced_scaffolds/FASTA/unplaced.scaf.fa.gz";
open (FH, "zcat $agpFile|") or die "can not read $agpFile";
open (UC, "|gzip -c > unplaced.agp.gz") or die "can not write to unplaced.agp.gz";
while (my $line = <FH>) {
    if ($line =~ m/^#/) {
        print UC $line;
    } else {
        $line =~ s/\.1//;    
        printf UC "%s", $line;
    }
}
close (FH);
close (UC);

open (FH, "zcat $fastaFile|") or die "can not read $fastaFile";
open (UC, "|gzip -c > unplaced.fa.gz") or die "can not write to unplaced.fa.gz";
while (my $line = <FH>) {
    if ($line =~ m/^>/) {
        chomp $line;
        $line =~ s/.*gb\|//;
        $line =~ s/\.1\|.*//;
        printf UC ">$line\n";
    } else {
        print UC $line;
    }
}
close (FH);
close (UC);
'_EOF_'
    # << happy emacs
    chmod +x unplaced.pl

    time ./unplaced.pl
    #	real    5m23.124s
# -rw-rw-r-- 1   1483871 Mar 27 12:29 unplaced.agp.gz
# -rw-rw-r-- 1 332029817 Mar 27 12:34 unplaced.fa.gz

    # verify nothing lost in the translation, should be the same as above
    #	except for the name translations
    faSize *.fa.gz
# 1117355426 bases (30758804 N's 1086596622 real 1086596622 upper 0 lower)
#	in 25211 sequences in 1 files
# Total size: mean 44320.2 sd 774121.2 min 228 (JH533144)
#	max 39887635 (JH556617) median 1201

#############################################################################
#  Initial database build (DONE - 2012-03-27 - Hiram)
    cd /hive/data/genomes/melUnd1
    cat << '_EOF_' > melUnd1.config.ra
# Config parameters for makeGenomeDb.pl:
db melUnd1
clade vertebrate
genomeCladePriority 60
scientificName Melopsittacus undulatus
commonName Budgerigar
assemblyDate Sep. 2011
assemblyLabel WUSTL Melopsittacus undulatus Budgerigar Version 6.3 (GCA_000238935.1)
assemblyShortLabel WUSTL v6.3
ncbiAssemblyName Melopsittacus_undulatus_6.3
ncbiAssemblyId 325078
orderKey 4375
mitoAcc NC_009134
fastaFiles /hive/data/genomes/melUnd1/ucsc/unplaced.fa.gz
agpFiles /hive/data/genomes/melUnd1/ucsc/unplaced.agp.gz
dbDbSpeciesDir birds
taxId   13146
'_EOF_'
    # << happy emacs

    # first verify the sequence and AGP files are OK
    time makeGenomeDb.pl -stop=agp -workhorse=hgwdev melUnd1.config.ra \
	> agp.log 2>&1
    #	real    1m24.027s
    # verify that was OK, look at the agp.log file
    time makeGenomeDb.pl -continue=db -workhorse=hgwdev melUnd1.config.ra \
	> db.log 2>&1
    #	real    8m11.569s
    # verify that was OK, look at the do.log file
    # copy the trackDb business to the source tree, check it in and add
    #	to the trackDb/makefile

#############################################################################
