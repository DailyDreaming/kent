# for emacs: -*- mode: sh; -*-

# Saccharomyces cerevisiae
# Saccharomyces Genome Database, Stanford

#######################################################################
# Download data  (DONE - 2011-08-24 - Hiram)
    mkdir -p /hive/data/genomes/sacCer3/genbank
    cd /hive/data/genomes/sacCer3/genbank
    wget --timestamping -r --cut-dirs=7 --level=0 -nH -x \
	--no-remove-listing -np \
"ftp://ftp.ncbi.nlm.nih.gov/genbank/genomes/Eukaryotes/fungi/Saccharomyces_cerevisiae/SacCer_Apr2011/*"

    mkdir ucsc

ls assembled_chromosomes/AGP | sed -e "s#.comp.agp.gz##" | while read F
do
    name=`zcat assembled_chromosomes/AGP/${F}.comp.agp.gz | grep -v "^#"
\
        | awk -F'\t' '{print $1}'`
    echo $name
    zcat assembled_chromosomes/AGP/${F}.comp.agp.gz \
        | sed -e "s/^${name}/${F}/" > ucsc/${F}.agp
done

ls assembled_chromosomes/AGP | sed -e "s#.comp.agp.gz##" | while read F
do
    echo ">${F}" > ucsc/${F}.fa
    zcat assembled_chromosomes/FASTA/${F}.fa.gz | grep -v "^>" >>
ucsc/${F}.fa
    gzip ucsc/${F}.fa
    ls -ld ucsc/${F}.fa.gz
done

    faSize ucsc/*.fa.gz
    #	12071326 bases (0 N's 12071326 real 12071326 upper 0 lower) in 16
    #	sequences in 16 files
    faSize assembled_chromosomes/FASTA/*.fa.gz
    #	12071326 bases (0 N's 12071326 real 12071326 upper 0 lower) in 16
    #	sequences in 16 files

#######################################################################
# Initial genome build (DONE - 2011-08-24 - Hiram)
    cd /hive/data/genomes/sacCer3]
    cat << '_EOF_' > sacCer3.config.ra
# Config parameters for makeGenomeDb.pl:
db sacCer3
scientificName Saccharomyces cerevisiae
commonName S. cerevisiae
assemblyDate Apr. 2011
assemblyShortLabel SacCer_Apr2011
assemblyLabel Saccharomyces cerevisiae S288c assembly from Saccharomyces Genome Database (GCA_000146055.2)
orderKey 998
mitoAcc NC_001224
#       override the check for max size of 25,000
mitoSize        90000
fastaFiles /hive/data/genomes/sacCer3/genbank/ucsc/*.fa.gz
agpFiles /hive/data/genomes/sacCer3/genbank/ucsc/*.agp
# qualFiles /dev/null
dbDbSpeciesDir sacCer
taxId   559292
'_EOF_'
    # << happy emacs

    time makeGenomeDb.pl -stop=agp sacCer3.config.ra > agp.log 2>&1
    #	real    0m14.802s
    tail -3 agp.log
    #	if ( All AGP and FASTA entries agree - both files are valid != All AGP and FASTA entries agree - both files are valid ) then
    #	*** All done!  (through the 'agp' step)

    time makeGenomeDb.pl -continue=db sacCer3.config.ra > db.log 2>&1
    #	real    0m14.088s

    # no need for repeat masking
    ln -s sacCer3.unmasked.2bit sacCer3.2bit
    ln -s `pwd`/sacCer3.2bit /gbdb/sacCer3/sacCer3.2bit 

#######################################################################
# sacCer3 - S. cerevisiae - Ensembl Genes version 63 (DONE - 2011-08-24 - hiram)
    ssh swarm
    # there is now no 2-micron sequence, remove it from the Ensembl GTF file
    cd /hive/data/genomes/sacCer3
    cat << '_EOF_' > sacCer3.ensGene.ra
# required db variable
db sacCer3
# optional nameTranslation, the sed command that will transform
#       Ensemble names to UCSC names.  With quotes just to make sure.
nameTranslation "s/^VIII/chrVIII/; s/^VII/chrVII/; s/^VI/chrVI/; s/^V/chrV/; s/^XIII/chrXIII/; s/^XII/chrXII/; s/^XIV/chrXIV/; s/^XI/chrXI/; s/^XVI/chrXVI/; s/^XV/chrXV/; s/^X/chrX/; s/^III/chrIII/; s/^IV/chrIV/; s/^II/chrII/; s/^IX/chrIX/; s/^I/chrI/; s/^MT/chrM/; s/2-micron/2micron/"
'_EOF_'
#  << happy emacs

    doEnsGeneUpdate.pl -ensVersion=63 sacCer3.ensGene.ra
    ssh hgwdev
    cd /hive/data/genomes/sacCer3/bed/ensGene.63
    featureBits sacCer3 ensGene
    # 8912929 bases of 12157105 (73.315%) in intersection

#########################################################################
# MAKE 11.OOC FILE FOR BLAT (DONE - 2011-08-24 - Hiram)
    #	repMatch = 1024 * sizeof(sacCer3)/sizeof(hg18)
    #	4.32 = 1024 * (12162995/2881515245)
    #	use 10 to be very conservative
    ssh hgwdev
    cd /hive/data/genomes/sacCer3
    blat sacCer3.2bit /dev/null /dev/null -tileSize=11 \
	-makeOoc=jkStuff/sacCer3.11.ooc -repMatch=10
    #	Wrote 3137 overused 11-mers to 11.ooc
    mkdir /hive/data/staging/data/sacCer3
    #	copy this to scratch data
    cp -p jkStuff/sacCer3.11.ooc chrom.sizes sacCer3.2bit \
	/hive/data/staging/data/sacCer3

#########################################################################
# CREATING SGD-BASED KNOWN GENES AND OTHER FEATURES (DONE - 2011-08-29 - Hiram)
    mkdir /hive/data/genomes/sacCer3/bed/sgdAnnotations
    cd /hive/data/genomes/sacCer3/bed/sgdAnnotations
    wget  --timestamping \
http://downloads.yeastgenome.org/chromosomal_feature/saccharomyces_cerevisiae.gff
    #	trim the delivered S.cerevisiae.gff file to get rid of the FASTA section
    #	and fixup the chrM and 2-micron chrom names:
    awk '
BEGIN { keepGoing = 1 }
{
if (match($1, "^##FASTA")) { keepGoing = 0; }
if (keepGoing) print;
}
' saccharomyces_cerevisiae.gff \
        | sed -e "/^2-micron/d; s/^chrmt/chrM/" > S.cerevisiae.gff

    #	wrote this perl script to specifically parse this particular instance
    #	of the sgd gff file.
    # constructs the files: leftOvers.gff, notes.txt, otherFeatures.bed,
    #	and descriptions.txt
    $HOME/kent/src/hg/makeDb/outside/yeast/hgSgdGff3/sgdGffToGtf.pl \
        S.cerevisiae.gff > sacCer3.sgdGene.gtf 2> sacCer3.gtf.stderr

    cat sacCer3.sgdGene.gtf | ./chrName.sh | sed -e "s/_CDS//" \
	> sacCer3.sgdGene.roman.gtf
    # NOTE: if you reload this table, a command below:
    #	hgProtIdToGenePred sacCer3 sgdGene sgdToSwissProt name value
    # needs to be run to add a protein column to the sgdGene tabl3e
    ldHgGene -gtf sacCer3 sgdGene sacCer3.sgdGene.roman.gtf
    #	Read 7063 transcripts in 7450 lines in 1 files
    #	7063 groups 17 seqs 1 sources 3 feature types
    #	6692 gene predictions
    # for table cleaning below, get the names for a reference:
    hgsql -N -e "select name from sgdGene;" sacCer3 | sort -u > name.sgdGene.txt

    #	some of the otherFeatures have start == end, use option:
    cat otherFeatures.bed | ./chrName.sh > otherFeatures.roman.bed
    hgLoadBed -allowStartEqualEnd sacCer3 sgdOther otherFeatures.roman.bed \
        -tab -sqlTable=$HOME/kent/src/hg/lib/sgdOther.sql
    #	Loaded 2476 elements of size 7
# XXX errors here
# chromStart == chromEnd (31228) (zero-length item)
# Use -allowStartEqualEnd if that is legit (e.g. for insertion point).

    # process the peptides into a format that hgSgdPep can handle
    # actually, a few more lines here could perform the hgSgdPep function
    cat << '_EOF_' > pepPred.pl
#!/usr/bin/env perl

use strict;
use warnings;

open (FH, "zcat ../../yeastgenome.org/orf_trans_all.fasta.gz|") or
        die "can not zcat ../../yeastgenome.org/orf_trans_all.fasta.gz";
while (my $line = <FH>) {
    if ($line =~ m/^>/) {
        chomp $line;
        my @a = split('\s+', $line);
        my $name = $a[0];
        $name =~ s/^>//;
        my $orf = $a[1];
        printf ">ORFP:%s\t%s\n", $name, $orf;
    } else {
        printf "%s", $line;
    }
}
close (FH);
'_EOF_'
    # << happy emacs
    chmod +x pepPred.pl
    ./pepPred.pl > sgdPep.fsa

    hgSgdPep sgdPep.fsa sgdPep.fa stdout | sort > symbol.raw.txt
    # the ^I here needs to be two keystrokes: ctrl-v I
    join -t "^I" name.sgdGene.txt symbol.raw.txt > symbol.txt
    wc -l name.sgdGene.txt symbol.raw.txt symbol.txt
    #	6692 name.sgdGene.txt
    #	6717 symbol.raw.txt
    #	6692 symbol.txt
    faToTab -type=protein sgdPep.fa stdout | sort > sgdPep.tab
    # the ^I here needs to be two keystrokes: ctrl-v I
    join -t"^I" name.sgdGene.txt sgdPep.tab > sgdPep.toLoad.tab

    wc -l name.sgdGene.txt sgdPep.tab sgdPep.toLoad.tab
    #	6692 name.sgdGene.txt
    #	6717 sgdPep.tab
    #	6692 sgdPep.toLoad.tab

    hgPepPred sacCer3 tab sgdPep sgdPep.toLoad.tab
    hgsql sacCer3 -e 'create table sgdToName ( \
          name varchar(10) not null, \
	  value varchar(10) not null, \
	  PRIMARY KEY(name), \
	  INDEX (value));'
    hgsql sacCer3 -e 'load data local infile "symbol.txt" \
          into table sgdToName;'

    # the ^I here needs to be two keystrokes: ctrl-v I
    join -t"^I" name.sgdGene.txt descriptions.txt > descriptions.toLoad.txt
    wc -l name.sgdGene.txt descriptions.txt descriptions.toLoad.txt
    #	6692 name.sgdGene.txt
    #	6712 descriptions.txt
    #	6691 descriptions.toLoad.txt

    hgsql sacCer3 < $HOME/kent/src/hg/lib/sgdDescription.sql
    hgsql sacCer3 -e 'load data local infile "descriptions.toLoad.txt" \
          into table sgdDescription;'
    hgsql sacCer3 < $HOME/kent/src/hg/lib/sgdOtherDescription.sql
    hgsql sacCer3 -e 'load data local infile "notes.txt" \
          into table sgdOtherDescription;'

############################################################################
# ADDING SWISSPROT ACCESSION TO KNOWN GENES (DONE - 2011-08-29 - Hiram)
    cd /hive/data/genomes/sacCer3/bed/sgdAnnotations
    wget --timestamping \
http://downloads.yeastgenome.org/chromosomal_feature/dbxref.tab

    grep "UniProt" dbxref.tab \
	| awk '{printf("%s\t%s\n", $5, $1);}' > sgdToSwissProt.txt
    hgsql sacCer3 -e 'create table sgdToSwissProt ( \
          name varchar(10) not null, \
	  value varchar(10) not null, \
	  PRIMARY KEY(name), \
	  INDEX (value));'
    hgsql sacCer3 -e 'load data local infile "sgdToSwissProt.txt" \
          into table sgdToSwissProt;'
    hgProtIdToGenePred sacCer3 sgdGene sgdToSwissProt name value

    # verify all names are valid
    cut -f1 sgdToSwissProt.txt | sort -u > name.sgdToSwissProt.txt
    wc -l name.sgdToSwissProt.txt name.sgdGene.txt
    #	5897 name.sgdToSwissProt.txt
    #	6692 name.sgdGene.txt

    comm -12 name.sgdToSwissProt.txt name.sgdGene.txt | wc -l
    # 5879
    # remove the 18 from sgdToSwissProt that are not in sgdGene:
    comm -23 name.sgdToSwissProt.txt name.sgdGene.txt | wc -l
    #	18
    comm -23 name.sgdToSwissProt.txt name.sgdGene.txt | while read N
do
    hgsql -e "delete from sgdToSwissProt where name=\"${N}\";" sacCer3
done


# interesting to note that sgdTOSwissProt has one accession not
# in sgdGene.name:  KHS1  (BK 2009-07-14)

############################################################################
# AUTO UPDATE GENBANK RUN  (Done - 2011-08-24,29 - Hiram)
    # align with latest genbank process.
    cd ~/kent/src/hg/makeDb/genbank
    cvsup
    # edit etc/genbank.conf to add sacCer3 just before sacCer1

# sacCer3 S. cerevisiae
sacCer3.serverGenome = /hive/data/genomes/sacCer3/sacCer3.2bit
sacCer3.clusterGenome = /scratch/data/sacCer3/sacCer3.2bit
sacCer3.ooc = no
sacCer3.maxIntron = 5000
sacCer3.lift = no
sacCer3.refseq.mrna.native.pslCDnaFilter  = ${lowCover.refseq.mrna.native.pslCDnaFilter}
sacCer3.refseq.mrna.xeno.pslCDnaFilter    = ${lowCover.refseq.mrna.xeno.pslCDnaFilter}
sacCer3.genbank.mrna.native.pslCDnaFilter = ${lowCover.genbank.mrna.native.pslCDnaFilter}
sacCer3.genbank.mrna.xeno.pslCDnaFilter   = ${lowCover.genbank.mrna.xeno.pslCDnaFilter}
sacCer3.genbank.est.native.pslCDnaFilter  = ${lowCover.genbank.est.native.pslCDnaFilter}
#sacCer3.perChromTables = no  # doesn't work in the browser
sacCer3.genbank.mrna.xeno.load = no
sacCer3.refseq.mrna.native.load = no
sacCer3.downloadDir = sacCer3

    git commit -m "adding sacCer3" genbank.conf
    git pull
    git push

    # update /cluster/data/genbank/:
    make etc-update

    ssh genbank
    screen		#	use a screen to manage this job
    cd /cluster/data/genbank
    time nice -n +19 bin/gbAlignStep -initial sacCer3 &
    #	logFile: var/build/logs/2011.08.24-16:16:56.sacCer3.initalign.log
    # the system was slow due to hive loads:
    #	26h 17m == 1577m

    # load database when finished
    ssh hgwdev
    cd /cluster/data/genbank
    time nice -n +19 ./bin/gbDbLoadStep -drop -initialLoad sacCer3
    #	logFile: var/dbload/hgwdev/logs/2011.08.29-14:16:10.dbload.log
    #	real    10m7.094s

    # enable daily alignment and update of hgwdev (DONE - 2009-02-24 - Hiram)
    cd ~/kent/src/hg/makeDb/genbank
    git pull
    cvsup
    # add sacCer3 to:
        etc/align.dbs
        etc/hgwdev.dbs
    git commit -m "Added sacCer3 - S. cerevisiae" \
	etc/align.dbs etc/hgwdev.dbs
    git push
    make etc-update

############################################################################
# CREATE SGD-BASED CLONE TRACK (DONE - 2011-08-31 - Hiram)
    mkdir /hive/data/genomes/sacCer3/bed/sgdClone
    cd /hive/data/genomes/sacCer3/bed/sgdClone
    # since sacCer1, these coordinates have become 0-relative ?
    wget --timestamping \
ftp://genome-ftp.stanford.edu/pub/yeast/data_download/chromosomal_feature/clone.tab

    awk -F '\t' '{printf("%d\t%d\t%d\t%s\t%s\n", $3, $4, $5, $2, $1);}' \
    	clone.tab | sed -e \
"s/^8/chrVIII/; s/^7/chrVII/; s/^6/chrVI/; s/^5/chrV/;
s/^13/chrXIII/; s/^12/chrXII/; s/^14/chrXIV/; s/^11/chrXI/;
s/^16/chrXVI/; s/^15/chrXV/; s/^10/chrX/; s/^3/chrIII/;
s/^4/chrIV/; s/^2/chrII/; s/^9/chrIX/; s/^1/chrI/;" | sort -k1,1 -k2,2n \
	> sgdClone.bed
    hgLoadBed sacCer3 sgdClone  sgdClone.bed -tab \
        -sqlTable=$HOME/kent/src/hg/lib/sgdClone.sql

############################################################################
