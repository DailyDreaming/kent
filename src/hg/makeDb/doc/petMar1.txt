# for emacs: -*- mode: sh; -*-


# This file describes browser build for the Sea Lamprey
# genome, Petromyzon marinus, March 2007, v.3.0 from WUSTL
#
#       "$Id: petMar1.txt,v 1.6 2008/04/16 16:50:16 hiram Exp $"
#

##########################################################################
### Fetch sequence       (DONE - 2008-01-14 - Hiram)
    #	determine estimated disk usage, from example genome like this one,
    #	braFlo1 which used about 3.5 Gb, do not need much space, store04
    #	has 42 Gb, plenty of space on store9
    ssh kkstore04
    mkdir /cluster/store9/petMar1
    ln -s /cluster/store9/petMar1 /cluster/data/petMar1
    mkdir /cluster/data/petMar1/downloads
    cd /cluster/data/petMar1/downloads

    wget --timestamping \
    'ftp://genome.wustl.edu/pub/organism/Other_Vertebrates/Petromyzon_marinus/assembly/Petromyzon_marinus-3.0/output/*'

##########################################################################
#  Fixup the agp file to make a chrUn agp file, add a 1000 base gap
#	between the supercontigs

##########################################################################
#  Run the makeGenomeDb.pl script (DONE - 2008-01-27 - Hiram)
    ssh kkstore04
    cd /cluster/data/petMar1/downloads
    #	eliminate zero-length fragments from the AGP file
    zcat supercontigs.agp.gz | awk '
{
size=$3-$2
if (size >= 0) print
}
' | gzip -c > supers.agp.gz

    cd /cluster/data/petMar1
    cat << '_EOF_' > petMar1.config.ra
# Config parameters for makeGenomeDb.pl:
db petMar1
clade vertebrate
genomeCladePriority 130
scientificName Petromyzon marinus
commonName Lamprey
assemblyDate Mar. 2007
assemblyLabel WUSTL v.3.0 (March 2007)
orderKey 480
mitoAcc 5835065
fastaFiles /cluster/data/petMar1/downloads/supercontigs.fa.gz
agpFiles /cluster/data/petMar1/downloads/supers.agp.gz
# qualFiles none
dbDbSpeciesDir lamprey
'_EOF_'

    #	can stop at db since trackDb and dbDb were created in first
    #	attempt
    makeGenomeDb.pl -stop=db petMar1.config.ra > makeGenome.log 2>&1 &
    twoBitToFa petMar1.unmasked.2bit stdout | faSize stdin
    #	1135497967 bases (303801529 N's 831696438 real 831696438
    #	upper 0 lower) in 2 sequences in 1 files

    #	chrM has a gi:5835065 fragment name, I would rather have NC_001626
    hgsql -e 'update gold set frag="NC_001626" where chrom="chrM";' petMar1

##########################################################################
#  Pick up an image from the EPA, usage rights are free
#	http://www.epa.gov/glnpo/image/restrictions.htm
    mkdir /cluster/data/petMar1/photo
    cd /cluster/data/petMar1/photo
    wget --timestamping 'http://www.epa.gov/glnpo/image/vbig/229.jpg' \
	-O petromyzon_marinus.epa.jpg

##########################################################################
#  Running WindowMasker (DONE - 2008-01-26 - Hiram)
    ssh kolossus
    mkdir /cluster/data/petMar1/bed/WindowMasker
    cd /cluster/data/petMar1/bed/WindowMasker
    /cluster/bin/scripts/doWindowMasker.pl \
	-buildDir /cluster/data/petMar1/bed/WindowMasker \
	-workhorse=kolossus -verbose=2 petMar1 > wm.log 2>&1 &
    twoBitToFa petMar1.wmsk.sdust.2bit stdout | faSize stdin
    #	1027258967 bases (195562529 N's 831696438 real 494032631 upper
    #	337663807 lower) in 108241 sequences in 1 files

    #	%32.87 masked total, %40.60 masked real

    ssh hgwdev
    cd /cluster/data/petMar1/bed/WindowMasker
    hgLoadBed petMar1 windowmaskerSdust windowmasker.sdust.bed.gz
    #	Loaded 4938211 elements of size 3
    featureBits petMar1 windowmaskerSdust
    #	533224658 bases of 831696438 (64.113%) in intersection

    #	WM has a bug where it masks the gaps too, don't like that,
    #	fetch the WM track without the gaps, can do this in the
    #	table browser with an intersection of WMask AND ! gap
    #	or via featureBits:
    featureBits petMar1 -not gap -bed=notGap.bed
    #	hint: also works with the gold table instead of notGap
    time nice -n +19 featureBits petMar1 windowmaskerSdust notGap.bed \
	-bed=stdout | gzip -c > cleanWMask.bed.gz
    #	337663807 bases of 831696438 (40.599%) in intersection
    #	real    182m45.469s
    hgLoadBed petMar1 windowmaskerSdust cleanWMask.bed.gz
    #	Loaded 4919722 elements of size 4
    featureBits petMar1 windowmaskerSdust > fb.petMar1.cleanWMask.txt 2>&1
    #	337663807 bases of 831696438 (40.599%) in intersection
 
##########################################################################
#	Running TRF simple repeats (DONE - 2008-01-26 - Hiram)
    ssh kkstore04
    mkdir /cluster/data/petMar1/bed/simpleRepeat
    cd /cluster/data/petMar1/bed/simpleRepeat
    doSimpleRepeat.pl petMar1 -smallClusterHub=memk \
	-workhorse=kolossus \
	-buildDir=/cluster/data/petMar1/bed/simpleRepeat > do.log 2>&1 &
    #	ran into a bug with the nice difficulty on the featureBits
    featureBits petMar1 simpleRepeat > fb.petMar1.simpleRepeat.txt 2>&1
    #	75844864 bases of 831696438 (9.119%) in intersection
    doSimpleRepeat.pl petMar1 -smallClusterHub=memk \
	-continue=cleanup -workhorse=kolossus \
	-buildDir=/cluster/data/petMar1/bed/simpleRepeat > cleanup.log 2>&1 &

##########################################################################
# Repeat Masker (DONE - 2008-01-26 - Hiram)
    ssh kkstore04
    mkdir /cluster/data/petMar1/bed/RepeatMasker
    cd /cluster/data/petMar1/bed/RepeatMasker
    doRepeatMasker.pl petMar1 -bigClusterHub=kk -workhorse=kolossus \
	-buildDir=/cluster/data/petMar1/bed/RepeatMasker \
	-verbose=2 > do.log 2>&1
##########################################################################
# Add WindowMasker and trfMask masking to the 2bit sequenct
#	(DONE - 2008-01-26 - Hiram)
    ssh kkstore04
    cd /cluster/data/petMar1
    gzip bed/simpleRepeat/trfMask.bed
    zcat bed/WindowMasker/cleanWMask.bed.gz bed/simpleRepeat/trfMask.bed.gz \
	| twoBitMask -type=.bed petMar1.unmasked.2bit stdin petMar1.2bit
    #	ignore the warning about bed file > 13 fields, that is OK
    twoBitToFa petMar1.2bit stdout | faSize stdin
    #	1027258967 bases (195562529 N's 831696438 real 493479824 upper
    #	338216614 lower) in 108241 sequences in 1 files
    #	%32.92 masked total, %40.67 masked real

############################################################################
#  BLATSERVERS ENTRY (DONE - 2008-01-15 - Hiram)
#	After getting a blat server assigned by the Blat Server Gods,
    ssh hgwdev

    hgsql -e 'INSERT INTO blatServers (db, host, port, isTrans, canPcr) \
	VALUES ("petMar1", "blat15", "17788", "1", "0"); \
	INSERT INTO blatServers (db, host, port, isTrans, canPcr) \
	VALUES ("petMar1", "blat15", "17789", "0", "1");' \
	    hgcentraltest
    #	test it with some sequence

############################################################################
## Reset default position to 
#	Where RHO1 protein is found via blat:
#	GEMSLWSLVV LAIERYIVIC KPMGNFRFGS THAYMGVAFT WFMALSCAAP PLVGWSR
    ssh hgwdev
    hgsql -e 'update dbDb set defaultPos="Contig11034:8429-10197"
	where name="petMar1";' hgcentraltest

#########################################################################
# MAKE 11.OOC FILE FOR BLAT (DONE - 2008-01-29 - Hiram)
    # Use -repMatch=200 (based on size -- for human we use 1024, and 
    # medaka size is ~20% of human judging by gapless oryLat1 vs. hg18 
    # genome sizes from featureBits.
    ssh kkstore04
    cd /cluster/data/petMar1
    blat petMar1.2bit /dev/null /dev/null -tileSize=11 \
      -makeOoc=petMar1.11.ooc -repMatch=200
    #	Wrote 49155 overused 11-mers to petMar1.11.ooc

##########################################################################
# GENBANK AUTO UPDATE (DONE - 2008-01-15 - Hiram)
    # align with latest genbank process.
    ssh hgwdev
    cd ~/kent/src/hg/makeDb/genbank
    cvsup
    # edit etc/genbank.conf to add petMar1 just after gasAcu1

# petMar1 (Branchiostoma floridae - Lancelet)
petMar1.serverGenome = /cluster/data/petMar1/petMar1.2bit
petMar1.clusterGenome = /cluster/bluearc/scratch/data/petMar1/petMar1.2bit
petMar1.refseq.mrna.native.pslCDnaFilter  = ${ordered.refseq.mrna.native.pslCDnaFilter}
petMar1.refseq.mrna.xeno.pslCDnaFilter    = ${ordered.refseq.mrna.xeno.pslCDnaFilter}
petMar1.genbank.mrna.native.pslCDnaFilter = ${ordered.genbank.mrna.native.pslCDnaFilter}
petMar1.genbank.mrna.xeno.pslCDnaFilter   = ${ordered.genbank.mrna.xeno.pslCDnaFilter}
petMar1.genbank.est.native.pslCDnaFilter  = ${ordered.genbank.est.native.pslCDnaFilter}
petMar1.ooc = /cluster/data/petMar1/petMar1.11.ooc
petMar1.lift = /cluster/data/petMar1/jkStuff/petMar1.nonBridged.lft
petMar1.refseq.mrna.native.load = yes
petMar1.refseq.mrna.xeno.load = yes
petMar1.genbank.mrna.xeno.load = yes
petMar1.genbank.est.native.load = yes
petMar1.downloadDir = petMar1
petMar1.perChromTables = no

    cvs ci -m "Added petMar1." etc/genbank.conf
    # update /cluster/data/genbank/:
    make etc-update

    # Edit src/lib/gbGenome.c to add new species.
    cvs ci -m "Added Petromyzon marinus (Sea Lamprey)." src/lib/gbGenome.c
    make install-server

    ssh genbank
    screen # control this with a screen so you can get back to it
    cd /cluster/data/genbank
    time nice -n +19 bin/gbAlignStep -initial petMar1 &
    #	logFile: var/build/logs/2008.01.29-11:27:10.petMar1.initalign.log
    #	real    332m36.025s
    #	There was some kind of problem with this alignment, although the
    #	kluster run actually finished:
# Completed: 366520 of 366520 jobs
# CPU time in finished jobs:    6854057s  114234.28m  1903.90h   79.33d  0.217 y
# IO & Wait Time:               2300432s   38340.53m   639.01h   26.63d  0.073 y
# Average job time:                  25s       0.42m     0.01h    0.00d
# Longest finished job:            1292s      21.53m     0.36h    0.01d
# Submission to last job:         21121s     352.02m     5.87h    0.24d
    #	So, continuing:
    time nice -n +19 bin/gbAlignStep -continue=finish -initial petMar1 &
    #	logFile: var/build/logs/2008.01.30-09:18:56.petMar1.initalign.log
    #	real    70m20.669s

    # load database when finished
    ssh hgwdev
    cd /cluster/data/genbank
    time nice -n +19 ./bin/gbDbLoadStep -drop -initialLoad petMar1
    #	logFile: var/dbload/hgwdev/logs/2008.01.15-16:21:10.dbload.log
    #	real    19m34.853s

    # enable daily alignment and update of hgwdev (2008-01-30 - Hiram)
    cd ~/kent/src/hg/makeDb/genbank
    cvsup
    # add petMar1 to:
        etc/align.dbs
        etc/hgwdev.dbs
    cvs ci -m "Added petMar1 - Petromyzon marinus (lamprey)" \
	etc/align.dbs etc/hgwdev.dbs
    make etc-update

#########################################################################
# BLASTZ/CHAIN/NET Medaka oryLat1 (DONE - 2008-01-15 - Hiram)
#	Try 1 failed, run again with contigs
    ssh kkstore04
    screen # use screen to control this job
    mkdir /cluster/data/oryLat1/bed/blastz.petMar1.2008-01-15
    cd /cluster/data/oryLat1/bed/blastz.petMar1.2008-01-15

    cat << '_EOF_' > DEF
# Medaka vs. Lamprey

# using the "close" genome alignment parameters
#	see also: http://genomewiki.ucsc.edu/index.php/Mm9_multiple_alignment
BLASTZ_Y=9400
BLASTZ_L=3000
BLASTZ_K=3000
BLASTZ_M=50

# TARGET: Medaka oryLat1 (40M chunks covers the largest chroms in one gulp)
#       chrUn in Scaffolds for this alignment run
SEQ1_DIR=/san/sanvol1/scratch/oryLat1/oryLat1.sdTrf.2bit
SEQ1_LEN=/cluster/data/oryLat1/chrom.sizes
SEQ1_CHUNK=10000000
SEQ1_LIMIT=30
SEQ1_LAP=10000

# QUERY: Lamprey petMar1
SEQ2_DIR=/cluster/bluearc/scratch/data/petMar1/petMar1.2bit
SEQ2_LEN=/cluster/data/petMar1/chrom.sizes
SEQ2_CHUNK=20000000
SEQ2_LIMIT=30
SEQ2_LAP=0

BASE=/cluster/data/oryLat1/bed/blastz.petMar1.2008-01-15
TMPDIR=/scratch/tmp
'_EOF_'
    # << this line keeps emacs coloring happy

    time doBlastzChainNet.pl -verbose=2 `pwd`/DEF \
	-chainMinScore=3000 -chainLinearGap=medium \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-bigClusterHub=memk > do.log 2>&1 &
XXX - running 2008-01-15 12:50
    #	real    1053m9.027s
    #	netChains failed, during chainStitchId:
    #	q end mismatch 1073742062 vs 1111312799 line 510 of stdin

############################################################################
#  Create contigs-only masked 2bit file for non-bridged gap free blastz runs
#	 (DONE - 2008-01-15 - Hiram)
    ssh kkstore04
    mkdir /cluster/data/petMar1/contigSequence
    cd /cluster/data/petMar1/contigSequence
    cp -p /cluster/data/priPac1/jkStuff/lft2BitToFa.pl ../jkStuff
    ../jkStuff/lft2BitToFa.pl ../petMar1.2bit \
	../jkStuff/petMar1.nonBridged.lft > supercontigs.fa
    #	this took quite a long time, about 6 hours or so
    #	this doesn't have chrM yet
    faSize supercontigs.fa ../M/chrM.fa
    #	1027258967 bases (195562529 N's 831696438 real 493405059 upper
    #	338291379 lower) in 108241 sequences in 2 files
    #	%32.93 masked total, %40.67 masked real
    cat supercontigs.fa ../M/chrM.fa | faToTwoBit stdin petMar1.supers.2bit
    twoBitToFa petMar1.supers.2bit stdout | faSize stdin
    #	1027258967 bases (195562529 N's 831696438 real 493405059 upper
    #	338291379 lower) in 108241 sequences in 1 files
    #	%32.93 masked total, %40.67 masked real
    twoBitInfo petMar1.supers.2bit stdout | sort -k2nr > super.sizes
    cp -p petMar1.supers.2bit /cluster/bluearc/scratch/data/petMar1
    cd ..
    ln -s contigSequence/super.sizes .

#########################################################################
# BLASTZ/CHAIN/NET Medaka oryLat1 (DONE - 2008-01-16 - 2008-01-30 - Hiram)
#	Try 2 with contigs for Lamprey
    ssh kkstore04
    screen # use screen to control this job
    mkdir /cluster/data/oryLat1/bed/blastz.petMar1.2008-01-15
    cd /cluster/data/oryLat1/bed/blastz.petMar1.2008-01-15

    cat << '_EOF_' > DEF
# Medaka vs. Lamprey

# using the "close" genome alignment parameters
#	see also: http://genomewiki.ucsc.edu/index.php/Mm9_multiple_alignment
BLASTZ_Y=9400
BLASTZ_L=3000
BLASTZ_K=3000
BLASTZ_M=50

# TARGET: Medaka oryLat1 (40M chunks covers the largest chroms in one gulp)
#       chrUn in Scaffolds for this alignment run
SEQ1_DIR=/san/sanvol1/scratch/oryLat1/oryLat1.sdTrf.2bit
SEQ1_LEN=/cluster/data/oryLat1/chrom.sizes
SEQ1_CHUNK=10000000
SEQ1_LIMIT=30
SEQ1_LAP=10000

# QUERY: Lamprey petMar1
SEQ2_DIR=/cluster/bluearc/scratch/data/petMar1/petMar1.2bit
SEQ2_LEN=/cluster/data/petMar1/chrom.sizes
SEQ2_CTGDIR=/cluster/bluearc/scratch/data/petMar1/petMar1.supers.2bit
SEQ2_CTGLEN=/cluster/data/petMar1/super.sizes
SEQ2_LIFT=/cluster/data/petMar1/jkStuff/petMar1.nonBridged.lft
SEQ2_CHUNK=10000000
SEQ2_LIMIT=150
SEQ2_LAP=0

BASE=/cluster/data/oryLat1/bed/blastz.petMar1.2008-01-16
TMPDIR=/scratch/tmp
'_EOF_'
    # << this line keeps emacs coloring happy

    time doBlastzChainNet.pl -verbose=2 `pwd`/DEF \
	-chainMinScore=3000 -chainLinearGap=medium \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-bigClusterHub=kk > do.log 2>&1 &
    #	real    218m14.787s
# Completed: 69774 of 70854 jobs
# Crashed: 1080 jobs
# CPU time in finished jobs:    3950133s   65835.55m  1097.26h   45.72d  0.125 y
# IO & Wait Time:               1218716s   20311.93m   338.53h   14.11d  0.039 y
# Average job time:                  74s       1.23m     0.02h    0.00d
# Longest running job:                0s       0.00m     0.00h    0.00d
# Longest finished job:            1629s      27.15m     0.45h    0.02d
# Submission to last job:         12951s     215.85m     3.60h    0.15d
    #	had some parasol bookeeping problems, it actually finished
    #	the kluster run but got confused.  Checked manually with
    #	para recover -> nothing in new job list, and check files in
    #	psl result directory finding the correct number of files for the
    #	the job count.  Make the run.time file and continuing:
    time doBlastzChainNet.pl -verbose=2 `pwd`/DEF \
	-continue=cat -chainMinScore=3000 -chainLinearGap=medium \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-bigClusterHub=kk > cat.log 2>&1 &
    #	real    7m47.963s
    #	something failed
    #	had the specification to the lft file incorrect, failed during
    #	chain run.  Fix that, finish the run, now continuing:
    time doBlastzChainNet.pl -verbose=2 `pwd`/DEF \
	-continue=chainMerge -chainMinScore=3000 -chainLinearGap=medium \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-bigClusterHub=kk > chainMerge.log 2>&1 &
    #	had the same failure as the first time test of this alignment.
    #	something is wrong with netChainSubset, needs to be debugged.
    #	ignore the step to create the "over.chain" file, finish the net
    #	step manually, then continuing:
    time doBlastzChainNet.pl -verbose=2 `pwd`/DEF \
	-continue=load -chainMinScore=3000 -chainLinearGap=medium \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-bigClusterHub=kk > load.log 2>&1 &
    #	real    3m53.686s
    cat fb.oryLat1.chainPetMar1Link.txt
    #	24990733 bases of 700386597 (3.568%) in intersection

    #	And, for the swap:
    mkdir /cluster/data/petMar1/bed/blastz.oryLat1.swap
    cd /cluster/data/petMar1/bed/blastz.oryLat1.swap
    time doBlastzChainNet.pl -verbose=2 -swap \
	/cluster/data/oryLat1/bed/blastz.petMar1.2008-01-16/DEF \
	-chainMinScore=3000 -chainLinearGap=medium \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-bigClusterHub=kk > swap.log 2>&1 &
    #	real    1m3.572s
    #	same problem in netChainSubset trying to make the "over.chain" file.
    #	skip that, finish the chains manually:
    #	real    14m35.340s
    #	then continuing:
    time doBlastzChainNet.pl -verbose=2 -swap \
	/cluster/data/oryLat1/bed/blastz.petMar1.2008-01-16/DEF \
	-continue=load -chainMinScore=3000 -chainLinearGap=medium \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-bigClusterHub=kk > load.log 2>&1 &
    cat fb.petMar1.chainOryLat1Link.txt
    #	23358156 bases of 831696438 (2.808%) in intersection

#############################################################################
# BLASTZ SWAP Lamprey - Lanclet (DONE - 2008-04-12 - Hiram)
    ssh kkstore05
    screen	#	control this job with a screen
    #	the original
    cd /cluster/data/braFlo1/bed/blastzPetMar1.2008-04-11
    cat fb.braFlo1.chainPetMar1Link.txt
    #	27418217 bases of 923355587 (2.969%) in intersection

    #	and the swap
    mkdir /cluster/data/petMar1/bed/blastz.braFlo1.swap
    cd /cluster/data/petMar1/bed/blastz.braFlo1.swap
    time nice -n +19 doBlastzChainNet.pl \
	/cluster/data/braFlo1/bed/blastzPetMar1.2008-04-11/DEF \
	-chainMinScore=5000 -chainLinearGap=loose \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-swap -bigClusterHub=kk -verbose=2 > swap.log 2>&1 &
    #	real    194m53.514s
    cat fb.petMar1.chainBraFlo1Link.txt
    #	27373264 bases of 831696438 (3.291%) in intersection

#############################################################################
# BLASTZ SWAP Chicken GalGal3 (DONE - 2008-04-15 - Hiram)
    #	the original
    ssh kkstore03
    cd /cluster/data/galGal3/bed/blastzPetMar1.2008-04-11
    cat fb.galGal3.chainPetMar1Link.txt
    #	20134896 bases of 1042591351 (1.931%) in intersection

    #	and the swap
    mkdir /cluster/data/petMar1/bed/blastz.galGal3.swap
    cd /cluster/data/petMar1/bed/blastz.galGal3.swap
    time nice -n +19 doBlastzChainNet.pl \
	/cluster/data/galGal3/bed/blastzPetMar1.2008-04-11/DEF \
	-chainMinScore=5000 -chainLinearGap=loose \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-swap -bigClusterHub=memk -verbose=2 > swap.log 2>&1 &
    #	real    33m41.587s
    cat fb.petMar1.chainGalGal3Link.txt
    #	22308118 bases of 831696438 (2.682%) in intersection
#############################################################################
