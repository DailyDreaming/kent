# for emacs: -*- mode: sh; -*-

# Dipodomys ordii  Kangaroo rat
#########################################################################
# DOWNLOAD SEQUENCE (DONE braney 2008-10-07)
    ssh kkstore05
    mkdir /cluster/store12/dipOrd1
    ln -s /cluster/store12/dipOrd1 /cluster/data
    mkdir /cluster/data/dipOrd1/broad
    cd /cluster/data/dipOrd1/broad

    wget --timestamping \
ftp://ftp.broad.mit.edu/pub/assemblies/mammals/kangarooRat/Dipord1.0/assembly.agp \
ftp://ftp.broad.mit.edu/pub/assemblies/mammals/kangarooRat/Dipord1.0/assembly.bases.gz \
ftp://ftp.broad.mit.edu/pub/assemblies/mammals/kangarooRat/Dipord1.0/assembly.quals.gz 
    md5sum ass* > assembly.md5sum

    qaToQac assembly.quals.gz stdout | qacAgpLift assembly.agp stdin dipOrd1.qual.qac

   cut -f 1 assembly.agp | uniq -c | wc -l 
   # Number of scaffolds: 210053

#########################################################################
# Create .ra file and run makeGenomeDb.pl (DONE braney 2008-10-07)
    ssh kolossus
    cd /cluster/data/dipOrd1
cat << _EOF_ >dipOrd1.config.ra
# Config parameters for makeGenomeDb.pl:
db dipOrd1
clade mammal
genomeCladePriority 35
scientificName  Dipodomys ordii  
commonName Kangaroo rat
assemblyDate Jul. 2008
assemblyLabel Broad Institute
orderKey 236.5
#mitoAcc AJ222767
mitoAcc none
fastaFiles /cluster/data/dipOrd1/broad/assembly.bases.gz
agpFiles /cluster/data/dipOrd1/broad/assembly.agp
qualFiles /cluster/data/dipOrd1/broad/dipOrd1.qual.qac
dbDbSpeciesDir kangarooRat
_EOF_

# use 'screen' make sure on kkstore05
    makeGenomeDb.pl -workhorse kolossus dipOrd1.config.ra > makeGenomeDb.out 2>&1 &

    cut -f 2 chrom.sizes | ave stdin
# Q1 1417.000000
# median 2509.000000
# Q3 8139.000000
# average 10275.987955
# min 554.000000
# max 11421927.000000
# count 210053
# total 2158502098.000000
# standard deviation 40860.463605

#########################################################################
# REPEATMASKER (not done)
    ssh kkstore05
    screen # use a screen to manage this job
    mkdir /cluster/data/dipOrd1/bed/repeatMasker
    cd /cluster/data/dipOrd1/bed/repeatMasker
    doRepeatMasker.pl -buildDir=/cluster/data/dipOrd1/bed/repeatMasker \
        dipOrd1 > do.log 2>&1 &

    # Note: can run simpleRepeats simultaneously
    #### When done with RM:
    ssh pk
    para time

#   new parasol, cluster a mess

    doRepeatMasker.pl -continue cat -buildDir=/cluster/data/dipOrd1/bed/repeatMasker \
        dipOrd1 > do3.log 2>&1 &

    time nice -n +19 featureBits dipOrd1 rmsk > fb.dipOrd1.rmsk.txt 2>&1 &
    # 440029204 bases of 1844966916 (23.850%) in intersection


#########################################################################
# SIMPLE REPEATS TRF (not done)
    ssh kkstore05
    screen # use a screen to manage this job
    mkdir /cluster/data/dipOrd1/bed/simpleRepeat
    cd /cluster/data/dipOrd1/bed/simpleRepeat
    # 
    doSimpleRepeat.pl -buildDir=/cluster/data/dipOrd1/bed/simpleRepeat \
	dipOrd1 > do.log 2>&1 &

    featureBits dipOrd1 simpleRepeat
    # 203389506 bases of 1844966916 (11.024%) in intersection

    #	after RM run is done, add this mask:
    cd /cluster/data/dipOrd1
    twoBitMask dipOrd1.rmsk.2bit -add bed/simpleRepeat/trfMask.bed dipOrd1.2bit

    twoBitToFa dipOrd1.2bit stdout | faSize stdin
# 2158506683 bases (313539767 N's 1844966916 real 1328458474 upper 516508442
# lower) in 210053 sequences in 1 files
# Total size: mean 10276.0 sd 40860.6 min 600 (scaffold_210052) max 11421927
# (scaffold_0) median 2509
# N count: mean 1492.7 sd 3518.5
# U count: mean 6324.4 sd 30354.6
# L count: mean 2458.9 sd 8794.9
# %23.93 masked total, %28.00 masked real

    twoBitToFa dipOrd1.rmsk.2bit stdout | faSize stdin
# 2158506683 bases (313539767 N's 1844966916 real 1405171780 upper 439795136
# lower) in 210053 sequences in 1 files
# Total size: mean 10276.0 sd 40860.6 min 600 (scaffold_210052) max 11421927
# (scaffold_0) median 2509
# N count: mean 1492.7 sd 3518.5
# U count: mean 6689.6 sd 30353.9
# L count: mean 2093.7 sd 8597.1
# %20.37 masked total, %23.84 masked real

    # Link to it from /gbdb
    ln -s /cluster/data/dipOrd1/dipOrd1.2bit /gbdb/dipOrd1/dipOrd1.2bit

    # mkdir /san/sanvol1/scratch/dipOrd1
    cp /cluster/data/dipOrd1/dipOrd1.2bit /san/sanvol1/scratch/dipOrd1
    cp /cluster/data/dipOrd1/chrom.sizes /san/sanvol1/scratch/dipOrd1


