# for emacs: -*- mode: sh; -*-
#
#	the above keeps emacs happy while working with this text document

# This file describes how we made the browser database on the Rattus 
# Norvegicus genome, March 2008 update (Rnor4.0) from Baylor.

#########################################################################
## Download sequence (DONE - 2008-11-13 - Hiram)
    mkdir /hive/data/genomes/rn5
    mkdir /hive/data/genomes/rn5/baylor
    cd /hive/data/genomes/rn5/baylor

    #	assuming BASH sequence here
    F="ftp://ftp.hgsc.bcm.tmc.edu/pub/data/Rnorvegicus/Rnor4.0/LinearizedChromosomes"
    for S in fa.gz fa.qual.gz
do
    wget --timestamping  ${F}/Rat20080227.${S}
done

    F="ftp://ftp.hgsc.bcm.tmc.edu/pub/data/Rnorvegicus/Rnor4.0"
    for S in htm txt
do
    wget --timestamping ${F}/README_Rnor4.${S}
done

    F="ftp://ftp.hgsc.bcm.tmc.edu/pub/data/Rnorvegicus/Rnor4.0/Contigs"
    for S in .agp _contigs.fa _contigs_fa.qual \
	_contig_scaffold.agp _scaffold_chr.agp _BACS.fa \
	_BACS.fa.qual _accnum.agp _ctg_name.agp _contigs_accnum
do
    wget --timestamping ${F}/Rat20080227${S}.gz
done

#########################################################################
# fixup names to correspond to UCSC syntax (DONE - Hiram - 2008-11-13)
    cd /hive/data/genomes/rn5/baylor
    zcat Rat20080227.fa.gz | sed -e "s/gnl.Rnor4.0.chr0/chr/; s/gnl.Rnor4.0.chr1/chr1/; s/gnl.Rnor4.0.chr2/chr2/; s/gnl.Rnor4.0.chrX/chrX/; s/gnl.Rnor4.0.chrUn/chrUn/;" \
| gzip -c > Rnor4.chroms.fa.gz

    zcat Rat20080227.fa.qual.gz | sed -e "s/gnl.Rnor4.0.chr0/chr/; s/gnl.Rnor4.0.chr1/chr1/; s/gnl.Rnor4.0.chr2/chr2/; s/gnl.Rnor4.0.chrX/chrX/; s/gnl.Rnor4.0.chrUn/chrUn/;" \
| gzip -c > Rnor4.chroms.fa.qual.gz

    zcat Rat20080227_scaffold_chr.agp.gz \
    | sed -e "s/^chr0/chr/; s/chr0\([1-9]*.scaffold\)/chr\1/; s/[\t]*#.*//;" \
	> Rnor4.scaffold_chr.agp

#########################################################################
# Create .ra file and run makeGenomeDb.pl (DONE - Hiram - 2008-11-14)
    cd /hive/data/genomes/rn4
    cat << '_EOF_' >rn5.config.ra
# Config parameters for makeGenomeDb.pl:
db rn5
clade mammal
scientificName Rattus norvegicus
commonName Rat
assemblyDate Mar. 2008
assemblyLabel Baylor BCM-HGSC Rnor4.0 (NCBI project ID: 10621)
orderKey 177
mitoAcc AC_000022
fastaFiles /hive/data/genomes/rn5/baylor/Rnor4.chroms.fa.gz
agpFiles /hive/data/genomes/rn5/baylor/Rnor4.scaffold_chr.agp
qualFiles /hive/data/genomes/rn5/baylor/Rnor4.chroms.fa.qual.gz
dbDbSpeciesDir rat
'_EOF_'
    # << happy emacs

    #	this was run manually step by step, the results were not recorded
    makeGenomeDb.pl rn5.config.ra > makeGenomeDb.log 2>&1
    #	real    41m44.090s

#########################################################################
## Repeat Masker (DONE - 2008-11-14 - Hiram)
    screen	# to manage this several day job
    mkdir /hive/data/genomes/rn5/bed/repeatMasker
    cd /hive/data/genomes/rn5/bed/repeatMasker
    time $HOME/kent/src/hg/utils/automation/doRepeatMasker.pl \
	-workhorse=hgwdev -bigClusterHub=swarm \
	-buildDir=`pwd` rn5 > do.log 2>&1 &
    #	real    475m44.607s
    cat faSize.rmsk.txt 
    #	3613304564 bases (785910941 N's 2827393623 real 1586542816 upper
    #	1240850807 lower) in 23 sequences in 1 files
    #	%34.34 masked total, %43.89 masked real

#########################################################################
# SIMPLE REPEATS TRF (DONE - 2008-11-14,17 - Hiram)
    screen # use a screen to manage this job
    mkdir /hive/data/genomes/rn5/bed/simpleRepeat
    cd /hive/data/genomes/rn5/bed/simpleRepeat
    # 
    time $HOME/kent/src/hg/utils/automation/doSimpleRepeat.pl \
	-buildDir=/cluster/data/rn5/bed/simpleRepeat rn5 > do.log 2>&1 &
    #	real    30m4.231s
    #	having trouble with one of them: chrM - has no result ...
    $HOME/kent/src/hg/utils/automation/doSimpleRepeat.pl \
	-continue=filter -buildDir=/cluster/data/rn5/bed/simpleRepeat \
	rn5 > filter.log 2>&1

    cat fb.simpleRepeat
    #	90043163 bases of 3372561689 (2.670%) in intersection

    #	after RM run is done, add this mask:
    cd /hive/data/genomes/rn5
    rm rn5.2bit
    twoBitMask rn5.rmsk.2bit -add bed/simpleRepeat/trfMask.bed rn5.2bit
    #	can safely ignore warning about >=13 fields in bed file

    twoBitToFa rn5.2bit stdout | faSize stdin > rn5.2bit.faSize.txt
# 3613304564 bases (785910941 N's 2827393623 real 1584580949 upper 1242812674
# lower) in 23 sequences in 1 files
# %34.40 masked total, %43.96 masked real

    #	link to gbdb
    ln -s `pwd`/rn5.2bit /gbdb/rn5

###########################################################################
# prepare for kluster runs (DONE _ 2008-11-17 - Hiram)
    # compare to size of real bases to adjust the repMatch
    #	hg18: 2881421696
    #	rn5: 2827393623
    # thus: 1024 * 2827393623/2881421696 = 1004
    #	rounding up to 1100 for a more conservative masking
    cd /hive/data/genomes/rn5
    time blat rn5.2bit \
	/dev/null /dev/null -tileSize=11 -makeOoc=rn5.11.ooc -repMatch=1100
    #	Wrote 31521 overused 11-mers to rn5.11.ooc
    #	real    2m9.494s

    #	and staging data for push to kluster nodes
    mkdir /hive/data/staging/data/rn5
    cp -p rn5.2bit chrom.sizes rn5.11.ooc \
	/hive/data/staging/data/rn5
    #	request to cluster admin to push this to the kluster nodes
    #	/scratch/data/

###########################################################################
