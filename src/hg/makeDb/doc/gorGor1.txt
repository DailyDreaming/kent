# for emacs: -*- mode: sh; -*-

# Gorilla gorilla
#########################################################################
# DOWNLOAD SEQUENCE (DONE braney 2008-10-07)
    mkdir /hive/data/genomes/gorGor1
    cd /hive/data/genomes/gorGor1
    ln -s `pwd` /cluster/data/gorGor1
    mkdir /hive/data/genomes/gorGor1/sanger
    cd /hive/data/genomes/gorGor1/sanger

    wget --timestamping \
ftp://ftp.sanger.ac.uk/pub/sequences/gorilla/draft_assembly_v0.1/gorilla_draft_genome_31265.agp.gz
    wget --timestamping \
ftp://ftp.sanger.ac.uk/pub/sequences/gorilla/draft_assembly_v0.1/gorilla_draft_genome_31265.fastq.gz
    wget --timestamping \
ftp://ftp.sanger.ac.uk/pub/sequences/gorilla/draft_assembly_v0.1/gorilla_draft_genome_31265.fragments.gz

XXX - working 2008-10-21
    # there are problems with all of these files

    qaToQac assembly.quals.gz stdout | qacAgpLift assembly.agp stdin gorGor1.qual.qac

   cut -f 1 assembly.agp | uniq -c | wc -l 
   # Number of scaffolds: 116467


#########################################################################
# Create .ra file and run makeGenomeDb.pl(DONE braney 2008-10-07)
    ssh kolossus
    cd /cluster/data/gorGor1
cat << '_EOF_' >gorGor1.config.ra
# Config parameters for makeGenomeDb.pl:
db gorGor1
clade mammal
genomeCladePriority 12
scientificName  Gorilla gorilla gorilla
commonName Gorilla
assemblyDate Oct. 2008
assemblyLabel Sanger Institute genome_31265
orderKey 10
mitoAcc NC_011120
fastaFiles /hive/data/genomes/gorGor1/sanger/gorilla_draft_genome_31265.fragments.gz
agpFiles /hive/data/genomes/gorGor1/sanger/gorilla_draft_genome_31265.agp.gz
qualFiles none
dbDbSpeciesDir gorilla
'_EOF_'
    # << happy emacs

    makeGenomeDb.pl -stop=seq -workhorse=hgwdev -verbose=2 gorGor1.config.ra
    #	this fails because the items in the fragments fasta file and
    #	the agp file do not match in sizes

# use 'screen' make sure on kkstore05
    makeGenomeDb.pl -workhorse kolossus -verbose=2 gorGor1.config.ra > makeGenomeDb.out 2>&1 &

    cut -f 2 chrom.sizes | ave stdin
# Q1 1243.000000
# median 1593.000000
# Q3 6511.000000
# average 21628.860415
# min 336.000000
# max 1406907.000000
# count 116467
# total 2519048486.000000
# standard deviation 63795.083568

#########################################################################
## Repeat Masker (DONE - 2008-10-16 - Hiram)
    screen	# to manage this several day job
    mkdir /hive/data/genomes/gorGor1/bed/repeatMasker
    cd /hive/data/genomes/gorGor1/bed/repeatMasker
    time $HOME/kent/src/hg/utils/automation/doRepeatMasker.pl \
	-workhorse=hgwdev -bigClusterHub=swarm \
	-buildDir=`pwd` gorGor1 > do.log 2>&1 &
    #	real    797m7.301s
    twoBitToFa gorGor1.rmsk.2bit stdout | faSize stdin > faSize.rmsk.txt
# 2519048486 bases (220604396 N's 2298444090 real 1290940163 upper 1007503927
# lower) in 116467 sequences in 1 files
# %40.00 masked total, %43.83 masked rea

#########################################################################
# SIMPLE REPEATS TRF (WORKING - 2008-10-15 - Hiram)
    screen # use a screen to manage this job
    mkdir /hive/data/genomes/gorGor1/bed/simpleRepeat
    cd /hive/data/genomes/gorGor1/bed/simpleRepeat
    # 
    time $HOME/kent/src/hg/utils/automation/doSimpleRepeat.pl \
	-buildDir=/cluster/data/gorGor1/bed/simpleRepeat gorGor1 > do.log 2>&1 &
    #	real    74m17.044s
    cat fb.simpleRepeat
    #	36542185 bases of 2298444090 (1.590%) in intersection

    #	after RM run is done, add this mask:
    cd /hive/data/genomes/gorGor1
    rm gorGor1.2bit
    twoBitMask gorGor1.rmsk.2bit -add bed/simpleRepeat/trfMask.bed gorGor1.2bit
    #	can safely ignore warning about >=13 fields in bed file

    twoBitToFa gorGor1.2bit stdout | faSize stdin > gorGor1.2bit.faSize.txt
# 2519048486 bases (220604396 N's 2298444090 real 1290364660 upper 1008079430
# lower) in 116467 sequences in 1 files
# %40.02 masked total, %43.86 masked rea
    #	link to gbdb
    ln -s `pwd`/gorGor1.2bit /gbdb/gorGor1

###########################################################################
# prepare for kluster runs (DONE _ 2008-10-16 - Hiram)
    # compare to size of real bases to adjust the repMatch
    #	hg18: 2881421696
    #	gorGor1: 2298444090
    # thus: 1024 * 2298444090/2881421696 = 816
    #	rounding up to 850 for a more conservative masking
    cd /hive/data/genomes/gorGor1
    time blat gorGor1.2bit \
	/dev/null /dev/null -tileSize=11 -makeOoc=gorGor1.11.ooc -repMatch=850
    #	Wrote 31521 overused 11-mers to gorGor1.11.ooc
    #	real    2m9.494s

    #	and staging data for push to kluster nodes
    mkdir /hive/data/staging/data/gorGor1
    cp -p gorGor1.2bit chrom.sizes gorGor1.11.ooc \
	/hive/data/staging/data/gorGor1
    #	request to cluster admin to push this to the kluster nodes
    #	/scratch/data/


