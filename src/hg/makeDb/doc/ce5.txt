# for emacs: -*- mode: sh; -*-

# Caenorhabditis elegans
# Washington University School of Medicine GSC and Sanger Institute WS180

# We don't have the resources to build a browser on this -- just mask
# the sequence and make ce4 <-> ce5 liftOver files for modENCODE use.

#  $Id: ce5.txt,v 1.1 2007/10/12 00:07:23 angie Exp $

#########################################################################
# DOWNLOAD SEQUENCE (DONE 10/10/07 angie)
    ssh kkstore06
    mkdir /cluster/store3/worm/ce5
    ln -s /cluster/store3/worm/ce5 /cluster/data/ce5
    cd /cluster/data/ce5
    mkdir downloads
    cd downloads
    wget --timestamping -m -np -nd \
      "ftp://ftp.sanger.ac.uk/pub/wormbase/WS180/CHROMOSOMES/"
    # All we really want is the CHR*.agp and CHR*.fa.gz -- clean up a 
    # bit & fetch more selectively next time.
    rm chrom* *_masked.dna.gz *.gff.gz CHROMOSOME_MtDNA.CSHL.gff


#########################################################################
# NORMALIZE SEQUENCE NAMES TO BEGIN WITH chr (DONE 10/10/07 angie)
    ssh kkstore06
    cd /cluster/data/ce5/downloads
    # Fix fasta names:
    zcat CHR*.dna.gz \
    | sed -e '/^$/ d;  s/^>CHROMOSOME_MtDNA/>chrM/;  s/^>CHROMOSOME_/>chr/;' \
    | gzip -c > UCSC.fa.gz
    faSize -detailed UCSC.fa.gz
#chrI    15072421
#chrII   15279316
#chrIII  13783681
#chrIV   17493785
#chrM    13794
#chrV    20919568
#chrX    17718851
    # Make sure we get the same sizes from this command:
    zcat CHR*.dna.gz | sed -e '/^$/ d;' | faSize -detailed stdin

    # Fix AGP names:
    sed -e 's/^/chr/' CHR*.agp \
    > UCSC.agp
    # And add a fake mitochondrial AGP entry for the sake of downstream
    # tools (I made sure the GenBank sequence is identical to given):
    echo "chrM\t1\t13794\t1\tF\tNC_001328.1\t1\t13794\t+" >> UCSC.agp


#########################################################################
# CHECK AGP VS. FA, MAKE UNMASKED 2BIT (DONE 10/10/07 angie)
    ssh kkstore06
    cd /cluster/data/ce5
    cat << '_EOF_' > ce5.config.ra
# Config parameters for makeGenomeDb.pl:
db ce5
clade worm
genomeCladePriority 10
scientificName Caenorhabditis elegans
commonName C. elegans
assemblyDate Aug. 2007
assemblyLabel Washington University School of Medicine GSC and Sanger Institute WS180
orderKey 827
mitoAcc none
fastaFiles /cluster/data/ce5/downloads/UCSC.fa.gz
agpFiles   /cluster/data/ce5/downloads/UCSC.agp
# qualFiles /dev/null
dbDbSpeciesDir worm
'_EOF_'
    # << emacs

    mkdir jkStuff
    nice makeGenomeDb.pl ce5.config.ra -stop agp \
      >& jkStuff/makeGenomeDb.log & tail -f jkStuff/makeGenomeDb.log
    # Note: file date on ce5.unmasked.2bit is 10/11 -- original was moved
    # aside to ce5.unmasked.lowercase.2bit, and then ce5.unmasked.2bit was
    # regenerated to test a slight tweak to makeGenomeDb.pl: use -noMask
    # with faToTwoBit when making .unmasked, in case we get lower-cased
    # sequence as in this case... which looks like all-masked to many progs.


#########################################################################
# REPEATMASKER (DONE 10/10/07 angie)
    ssh kkstore06
    cd /cluster/data/ce5
    doRepeatMasker.pl ce5 -debug
    cd bed/RepeatMasker.2007-10-10
    doRepeatMasker.pl ce5 -stop mask >& do.log & tail -f do.log


#########################################################################
# SIMPLE REPEATS (DONE 10/11/07 angie)
    ssh kkstore06
    cd /cluster/data/ce5
    doSimpleRepeat.pl ce5 -debug -verbose=3
    cd bed/simpleRepeat.2007-10-11
    doSimpleRepeat.pl ce5 -verbose=3 -stop filter >& do.log & tail -f do.log
    # Took less than 1/2 hour (small sequence, just did a single run).
    # Use the suggested commands at the end of do.log below...


#########################################################################
# MASK SEQUENCE WITH RM+TRF (DONE 10/11/07 angie)
    # Since both doRepeatMasker.pl and doSimpleRepeats.pl have completed,
    # now it's time to combine the masking into the final ce5.2bit,
    # following the instructions at the end of doSimpleRepeat's output.
    ssh kolossus
    cd /cluster/data/ce5
    twoBitMask ce5.rmsk.2bit -add bed/simpleRepeat.2007-10-11/trfMask.bed \
      ce5.2bit
    # Ignore warning about extra BED columns.
    

#########################################################################
# INSTALL 2BIT AND 11.OOC FOR BLAT/LIFTOVER (DONE 10/11/07 angie)
    # Use -repMatch=100 (based on size -- for human we use 1024, and 
    # worm size is ~3.4% of human judging by gapless ce4 vs. hg18 genome 
    # size from featureBits. So we would use 34, but that yields a very
    # high number of tiles to ignore, especially for a small more compact 
    # genome.  Bump that up a bit to be more conservative.
    ssh kkstore06
    cd /cluster/data/ce5
    rsync -av ce5.2bit /cluster/bluearc/ce5/
    blat ce5.2bit /dev/null /dev/null -makeOoc=/cluster/bluearc/ce5/11.ooc \
      -repMatch=100
#Wrote 8502 overused 11-mers to /cluster/bluearc/ce5/11.ooc


#########################################################################
# CE5->CE4 LIFTOVER (DONE 10/11/07 angie)
    ssh kkstore06
    cd /cluster/data/ce5
    doSameSpeciesLiftOver.pl ce5 ce4 -debug
    cd bed/blat.ce4.2007-10-11
    doSameSpeciesLiftOver.pl ce5 ce4 -verbose 3 >& do.log &
    tail -f do.log


#########################################################################
# MAKE ACTIVE=0 ENTRY IN DBDB (DONE 10/11/07 angie)
    ssh kkstore06
    cd /cluster/data/ce5
    makeGenomeDb.pl ce5.config.ra -debug -continue dbDb -stop dbDb
    # Edit dbDbInsert.sql so active=0 (and fix the -debug defaultPos
    # that refers to chr1 --> chrI), then execute as in makeGenomeDb's
    # #DEBUG# output:
    ssh -x hgwdev hgsql -h genome-testdb -A -N hgcentraltest \
      < /cluster/data/ce5/dbDbInsert.sql


#########################################################################
