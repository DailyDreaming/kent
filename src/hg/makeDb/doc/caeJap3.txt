# for emacs: -*- mode: sh; -*-

# Caenorhabditis japonica
#	Washington University School of Medicine GSC and Sanger Institute
#	WUSTL version 7.0.1 Sep 2010

##############################################################################
## Fetch sequence (DONE - 2010-09-20 - Hiram)

    mkdir -p /hive/data/genomes/caeJap3/ws210
    cd /hive/data/genomes/caeJap3/ws210

    wget --no-parent --timestamping -m -nH --cut-dirs=5 \
	ftp://ftp.sanger.ac.uk/pub/wormbase/WS210/genomes/m_hapla/

    hgFakeAgp -minContigGap=1 \
	sequences/dna/b_malayi.WS210.dna.fa.gz ucsc.fake.caeJap3.agp

##############################################################################
## Initial browser build (DONE - 2010-09-20 - Hiram)
    cd /hive/data/genomes/caeJap3

    cat << '_EOF_' > caeJap3.config.ra
# Config parameters for makeGenomeDb.pl:
db caeJap3
clade worm
genomeCladePriority 70
scientificName Caenorhabditis japonica
commonName C. japonica
assemblyDate Sep. 2010
assemblyLabel Washington University School of Medicine GSC C. japonica 7.0.1
assemblyShortLabel C. japonica 7.0.1
orderKey 880
mitoAcc none
fastaFiles /hive/data/genomes/caeJap3/able0.3/ABLE000.ucsc.fa.gz
agpFiles /hive/data/genomes/caeJap3/able0.3/contig.ucsc.agp
qualFiles /hive/data/genomes/caeJap3/able0.3/ABLE000.ucsc.qac
dbDbSpeciesDir worm
taxId 281687
'_EOF_'
    # << happy emacs

    time makeGenomeDb.pl -workhorse=hgwdev -verbose=2 \
	caeJap3.config.ra > makeGenomeDb.log 2>&1
    #	real    2m45.252s

##############################################################################
# REPEATMASKER (DONE - 2010-09-21 - Hiram)
    screen 	#	use screen to control the job
    mkdir /hive/data/genomes/caeJap3/bed/repeatMasker
    cd /hive/data/genomes/caeJap3/bed/repeatMasker
    time nice -n +19 doRepeatMasker.pl -noSplit -bigClusterHub=pk \
	-buildDir=`pwd` caeJap3 > do.log 2>&1 &
    #	real    58m59.433s

    #	from the do.log:
    #	RepeatMasker version development-$Id:
    #	RepeatMasker,v 1.25 2010/09/08 21:32:26 angie Exp
    #	CC   RELEASE 20090604;                                            *

#########################################################################
# SIMPLE REPEATS (DONE - 2010-09-21 - Hiram)
    screen 	#	use screen to control the job
    mkdir /hive/data/genomes/caeJap3/bed/simpleRepeat
    cd /hive/data/genomes/caeJap3/bed/simpleRepeat
    time nice -n +19 doSimpleRepeat.pl -workhorse=hgwdev \
	-smallClusterHub=memk -buildDir=`pwd` caeJap3 > do.log 2>&1 &
    #	real    30m8.251s

#########################################################################
# run window masker (DONE - 2010-09-21 - Hiram)
    mkdir /hive/data/genomes/caeJap3/bed/windowMasker
    cd /hive/data/genomes/caeJap3/bed/windowMasker
    time doWindowMasker.pl -verbose=2 -workhorse=kolossus \
	-buildDir=`pwd` caeJap3 > do.log 2>&1 &
    #	real    4m14.628s

    twoBitToFa caeJap3.wmsk.sdust.2bit stdout | faSize stdin
    #	154057934 bases (0 N's 154057934 real 82158768 upper 71899166 lower)
    #	in 35931 sequences in 1 files
    #	%46.67 masked total, %46.67 masked real

    hgLoadBed caeJap3 windowmaskerSdust windowmasker.sdust.bed.gz
    #	Loaded 1023323 elements of size 3
    featureBits caeJap3 windowmaskerSdust
    #	71899166 bases of 154057934 (46.670%) in intersection

    #	this is the mask for the genome
    cd /hive/data/genomes/caeJap3
    zcat bed/windowMasker/windowmasker.sdust.bed.gz \
	| twoBitMask caeJap3.unmasked.2bit stdin \
	    -type=.bed caeJap3.2bit
    twoBitToFa caeJap3.2bit stdout | faSize stdin
    #	154057934 bases (0 N's 154057934 real 82158768 upper 71899166 lower)
    #	in 35931 sequences in 1 files
    #	%46.67 masked total, %46.67 masked real

    ln -s `pwd`/caeJap3.2bit /gbdb/caeJap3/caeJap3.2bit

########################################################################
# MAKE 11.OOC FILE FOR BLAT/GENBANK (DONE - 2010-09-21 - Hiram)
    # numerator is caeJap3 gapless bases "real" as reported by faSize 
    # denominator is hg19 gapless bases as reported by featureBits,
    #	featureBits hg19 gap
    # 1024 is threshold used for human -repMatch:
    calc \( 154057934 / 2897310462 \) \* 1024
    #	( 154057934 / 2897310462 ) * 1024 = 54.448885
    # 54 is way too small, use 100 to keep the number of overused
    #	11-mers to a smaller number

    cd /hive/data/genomes/caeJap3
    blat caeJap3.2bit /dev/null /dev/null -tileSize=11 \
      -makeOoc=caeJap3.11.ooc -repMatch=100
    #	Wrote 21362 overused 11-mers to caeJap3.11.ooc

    mkdir /hive/data/staging/data/caeJap3
    cp -p caeJap3.2bit chrom.sizes caeJap3.11.ooc \
	/hive/data/staging/data/caeJap3

#########################################################################
