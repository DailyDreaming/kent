#########################################################################
# Phylogenetic tree from 160-way (DONE - 2014-10-17 - Hiram)
    mkdir /hive/data/genomes/eboVir3/bed/multiz160way/4d
    cd /hive/data/genomes/eboVir3/bed/multiz160way/4d

    # the annotated maf is:
    ../noDups/multiz160way.maf

    # using ncbiGene for eboVir3
    hgsql -N -e 'select * from ncbiGene;' eboVir3 \
       | cut -f2- > eboVir3.ncbiGene.gp

    genePredSingleCover eboVir3.ncbiGene.gp stdout \
       | sort > eboVir3.ncbiGeneNR.gp
    wc -l *.gp
    #  9 eboVir3.ncbiGene.gp
    #  7 eboVir3.ncbiGeneNR.gp

    sed -e 's/eboVir3.KM034562v1/KM034562v1.KM034562v1/' \
       ../noDups/multiz160way.maf > multiz160way.KM034562v1.maf

    /cluster/bin/phast.build/cornellCVS/phast.2010-12-30/bin/msa_view \
       --4d --features eboVir3.ncbiGeneNR.gp \
         -i MAF multiz160way.KM034562v1.maf -o SS > multiz160way.ss

    /cluster/bin/phast.build/cornellCVS/phast.2010-12-30/bin/msa_view \
        -i SS --tuple-size 1 multiz160way.ss > multiz160way.mfa

    #want comma-less species.list
    /cluster/bin/phast.build/cornellCVS/phast.2010-12-30/bin/msa_view \
	--aggregate "`cat ../species.list`" multiz160way.mfa | sed s/"> "/">"/ \
	    > 4d.all.mfa
    # check they are all in there:
    grep "^>" 4d.all.mfa | sort -u | wc -l
    #  160

    sed 's/[a-z][a-z]*_//g; s/:[0-9\.][0-9\.]*//g; s/;//; /^ *$/d' \
	../160way.nh | xargs echo | sed -e 's/ //g' > tree_commas.nh
    # tree_commas.nh looks like:
    #   (((((eboVir3,panTro4),rheMac3),(mm10,rn5)),canFam3),monDom5)
    # use phyloFit to create tree model (output is phyloFit.mod)
    time nice -n +19 \
	/cluster/bin/phast.build/cornellCVS/phast.2010-12-30/bin/phyloFit \
	    --EM --precision MED --msa-format FASTA --subst-mod REV \
		--tree tree_commas.nh 4d.all.mfa
    #   real    0m6.583s


    mv phyloFit.mod all.mod

#########################################################################
# phastCons 160-way (DONE - 2014-06-04 - Hiram)
    # split 160way mafs into 10M chunks and generate sufficient statistics
    # files for # phastCons
    ssh ku
    mkdir -p /hive/data/genomes/eboVir3/bed/multiz160way/cons/SS
    cd /hive/data/genomes/eboVir3/bed/multiz160way/cons/SS
    /cluster/bin/phast.build/cornellCVS/phast.2010-12-30/bin/msa_split \
  /hive/data/genomes/eboVir3/bed/multiz160way/noDups/multiz160way.maf -i MAF \
    -o SS -r multiz160way -w 10000000,0 -I 1000 -B 5000

    # Run phastCons

export len=45
export cov=0.3
export rho=0.3
export c=eboVir3

sed -e 's/KM034562v1/eboVir3/g' ../4d/all.mod > all.mod

/cluster/bin/phast.build/cornellCVS/phast.2010-12-30/bin/phastCons \
  SS/multiz160way.1-18957.ss all.mod \
    --rho $rho --expected-length $len --target-coverage $cov --quiet \
    --seqname $c --idpref $c --most-conserved $c.bed --score > $c.pp

    /cluster/bin/scripts/lodToBedScore eboVir3.bed > mostConserved.bed


    # create Most Conserved track
    cd /hive/data/genomes/eboVir3/bed/multiz160way/cons/all
    cut -f1 ../../../../chrom.sizes | while read C
do
    ls -d bed/?/${C} 2> /dev/null | while read D
    do
        echo ${D}/${C}*.bed 1>&2
        cat ${D}/${C}*.bed
    done | sort -k1,1 -k2,2n \
    | awk '{printf "%s\t%d\t%d\tlod=%d\t%s\n", "'${C}'", $2, $3, $5, $5;}'
done > tmpMostConserved.bed

    /cluster/bin/scripts/lodToBedScore tmpMostConserved.bed > mostConserved.bed
    #    -rw-rw-r--  1 42636652 Jun  4 10:45 tmpMostConserved.bed
    #    -rw-rw-r--  1 43721828 Jun  4 10:45 mostConserved.bed

    # fixup up chrom name in the .pp file:
    sed -e 's/chrom=eboVir3/chrom=KM034562v1/' eboVir3.pp > KM034562v1.pp
    sed -e 's/^eboVir3/KM034562v1/' mostConserved.bed > KM034562v1.bed
    wigToBigWig -verbose=2 KM034562v1.pp \
      /hive/data/genomes/eboVir3/chrom.sizes KM034562v1.bw
    bigWigInfo KM034562v1.bw
version: 4
isCompressed: yes
isSwapped: 0
primaryDataSize: 21,741
primaryIndexSize: 6,348
zoomLevels: 6
chromCount: 1
basesCovered: 18,957
mean: 0.764529
min: 0.000000
max: 1.000000
std: 0.397315

    wigEncode KM034562v1.pp phastCons160way.wig phastCons160way.wib
    #  Converted KM034562v1.pp, upper limit 1.00, lower limit 0.00

    # load into database
    ssh hgwdev
    cd /hive/data/genomes/eboVir3/bed/multiz160way/cons/all
    hgLoadBed eboVir3 phastConsElements160way KM034562v1.bed
    # Read 129 elements of size 6 from mostConserved.bed
    featureBits eboVir3 phastConsElements160way
    #  14451 bases of 18957 (76.230%) in intersection

    ln -s `pwd`/phastCons160way.wib \
          /gbdb/eboVir3/multiz160way/phastCons160way.wib
    hgLoadWiggle -pathPrefix=/gbdb/eboVir3/multiz160way \
	eboVir3 phastCons160way phastCons160way.wig

    # on human we often try for 5% overall cov, and 70% CDS cov
    # most bets are off here for that goal, these alignments are too few
    #	and too far between
    #	--rho 0.3 --expected-length 45 --target-coverage 0.3
    featureBits eboVir3 -enrichment ncbiGene:cds phastConsElements160way
    # ncbiGene:cds 76.573%, phastConsElements160way 76.230%, both 70.127%,
    #  cover 91.58%, enrich 1.20x


    wigTableStats.sh eboVir3 phastCons160way
# db.table          min max mean       count sumData      stdDev  viewLimits
eboVir3.phastCons160way 0 1 0.764529 18957 14493.2 0.397315 viewLimits=0:1

    #  Create histogram to get an overview of all the data
    hgWiggle -doHistogram -db=eboVir3 \
	-hBinSize=0.001 -hBinCount=1000 -hMinVal=0.0 -verbose=2 \
	    phastCons160way > histogram.data 2>&1
    #	real    2m40.179s

    #	create plot of histogram:

    cat << '_EOF_' | gnuplot > histo.png
set terminal png small x000000 xffffff xc000ff x66ff66 xffff00 x00ffff
set size 1.4, 0.8
set key left box
set grid noxtics
set grid ytics
set title " Ebola eboVir3 Histogram phastCons160way track"
set xlabel " phastCons160way score"
set ylabel " Relative Frequency"
set y2label " Cumulative Relative Frequency (CRF)"
set y2range [0:1]
set y2tics
set yrange [0:0.02]

plot "histogram.data" using 2:5 title " RelFreq" with impulses, \
        "histogram.data" using 2:7 axes x1y2 title " CRF" with lines
'_EOF_'
    #	<< happy emacs

    display histo.png &

#########################################################################

