# $Id: strPur2.txt,v 1.1 2007/06/14 13:27:03 heather Exp $
# $Source: /projects/compbio/cvsroot/kent/src/hg/makeDb/doc/strPur2.txt,v $

# Strongylocentrus purpuratus -- Spur 2.1 assembly September, 2006
#
# ftp://ftp.hgsc.bcm.tmc.edu/pub/data/Spurpuratus/fasta/Spur_v2.1/

###############################################################################
# DOWNLOAD SEQUENCE - DONE 2/12/2007 Kord
# - select store
# - basic directory setup
 ssh kkstore06
 mkdir -p /cluster/store4/strPur2/downloads
 ln -s /cluster/store4/strPur2 /cluster/data/strPur2
 cd /cluster/data/strPur2/downloads
 wget -r -np ftp://ftp.hgsc.bcm.tmc.edu/pub/data/Spurpuratus/fasta/Spur_v2.1/

# decompress contig files
cd /cluster/data/strPur2/downloads/Spur_v2.1/contigs
gunzip *gz

# Move to working directory
mkdir -p /cluster/data/strPur2/fixup
cd /cluster/data/strPur2/fixup
cp /cluster/data/strPur2/downloads/Spur_v2.1/contigs/* .

###############################################################################
# PREP AGP/FASTA/QUAL files - DONE 2/19/2007 Kord

# Remove the "BCM_Spur_v2.1_" from the scaffold name in the AGP file
sed 's/BCM_Spur_v2.1_//g' BCM_Spur_v2.1.agp > strPur2.agp

# trimHeader in fasta and qual files
~/kent/src/hg/snp/snpLoad/trimHeader Spur_v2.1.contigs.fa 
sed 's/>[a-z]*|[0-9]*|[a-z]*|/>/g' trimHeader.out > strPur2.contigs.fa
gzip strPur2.contigs.fa

~/kent/src/hg/snp/snpLoad/trimHeader Spur_v2.1.contigs.fa.qual
mv trimHeader.out strPur2.contigs.fa.qual
gzip strPur2.contigs.fa.qual


###############################################################################
# MAKE GENOME DB - PREP 2/19/2007 Kord


# Obtained the commonName value
$ hgsql hgcentraltest 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 38380828 to server version: 4.0.27-standard-log

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> show tables;
+-------------------------+
| Tables_in_hgcentraltest |
+-------------------------+
| blatServers             |
| clade                   |
| dbDb                    |
| dbDbBak                 |
| dbDbNew                 |
| defaultDb               |
| gdbPdb                  |
| genomeClade             |
| genomeCladeTest         |
| liftOverChain           |
| liftOverChainBackup     |
| namedSessionDb          |
| sessionDb               |
| userDb                  |
| userDbApr12             |
+-------------------------+
15 rows in set (0.00 sec)

mysql> show columns from genomeClade;
+----------+--------------+------+-----+---------+-------+
| Field    | Type         | Null | Key | Default | Extra |
+----------+--------------+------+-----+---------+-------+
| genome   | varchar(255) |      |     |         |       |
| clade    | varchar(255) |      |     |         |       |
| priority | float        |      |     | 0       |       |
+----------+--------------+------+-----+---------+-------+
3 rows in set (0.00 sec)

mysql> select * from genomeClade;   
+-----------------------------------------+--------------+----------+
| genome                                  | clade        | priority |
+-----------------------------------------+--------------+----------+
...
| S. purpuratus                           | deuterostome |       20 |
...
+-----------------------------------------+--------------+----------+
127 rows in set (0.00 sec)

mysql> quit;
Bye


$ cat /cluster/home/kord/urchin/fixup/strPur2.config.ra
# Config parameters for makeGenomeDb.pl:
db strPur2
scientificName Strongylocentrotus purpuratus
assemblyDate Sep. 2006
clade deuterostome
assemblyLabel Baylor release 3 Spur 2.1
orderKey 880
# GenBank:X12631 gi:296545
mitoAcc 296545
fastaFiles /cluster/data/strPur2/fixup/strPur2.contigs.fa.gz
dbDbSpeciesDir urchin
# Optional settings
commonName S. purpuratus
agpFiles /cluster/data/strPur2/fixup/strPur2.agp
qualFiles /cluster/data/strPur2/fixup/strPur2.contigs.fa.qual.gz

# verify config.ra file works
$ /cluster/home/kord/kent/src/hg/utils/automation/makeGenomeDb.pl -workhorse kkstore06 -debug ./strPur2.config.ra

# run it (I did this in a screen)
$ ssh kkstore06
$ ~/kent/src/hg/utils/automation/makeGenomeDb.pl -workhorse kkstore06 ./strPur2.config.ra \
| tee -a makeGenomeDb.pl.log

# This generated an error with output files in /tmp
# There are 2654 sequences in the fasta file not included in the AGP file.
# Use faSomeRecords to create a fasta file of only the sequeces contained in
# the AFP file

$ cp makeGenomeDb.20070220/makeGenomeDb.agpIds.Ay8953 strPur2.AGPlist
$ faSomeRecords strPur2.contigs.fa strPur2.AGPlist strPur2.contigs-AGPlist.fa
$ faSomeRecords strPur2.contigs.fa.qual strPur2.AGPlist strPur2.contigs-AGPlist.fa.qual

# I verified that the diff generated from the original FASTA file and the newly generated
# FASTA file (AGP list) generated the correct sequence number (2654) and id

# compressed the AGP and fasta file
$ gzip strPur2.contigs-AGPlist.fa strPur2.contigs.fa.qual 

# updated the contig.ra file
$ vi strPur2.config.ra 
# Config parameters for makeGenomeDb.pl:
db strPur2
scientificName Strongylocentrotus purpuratus
assemblyDate Sep. 2006
clade deuterostome
assemblyLabel Baylor release 3 Spur 2.1
orderKey 880
# GenBank:X12631 gi:296545
mitoAcc 296545
fastaFiles /cluster/data/strPur2/fixup/strPur2.contigs-AGPlist.fa.gz
dbDbSpeciesDir urchin
# Optional settings
commonName S. purpuratus
agpFiles /cluster/data/strPur2/fixup/strPur2.agp
qualFiles /cluster/data/strPur2/fixup/strPur2.contigs.fa.qual.gz

# run it (I did this in a screen)
$ ssh kkstore06
$ nice ~/kent/src/hg/utils/automation/makeGenomeDb.pl -workhorse kkstore06 ./strPur2.config.ra \
| tee -a makeGenomeDb.pl.log2

# this turned out two errors:
# (1) unexpected coordiantes of fragments: length 1 (one)
# (2) unable to find chromosome size
$ mv strPur2.agp strPur2.agp.scaffoldname
$ agpCondense strPur2.agp.scaffoldname strPur2.agp.condense
$ mv strPur2.agp.condense strPur2.agp

# strPur2.agp:
# Scaffold18963   20393   24883   10      W       AAGJ02000001    944     5434	-
#
# strPur2.contigs.fa
# >AAGJ02000001
# GTTGACATGACCCTAGCTACTGTCCCTACGGACTATAGCTCCATAGCCCAAATGATTCCATTTGCTATCT
# AGTGGATTCAATGGCCATATTAAATGGTACAAGGGCCCACAATCTGGTTCTGTCTTCTTCTTTTTTTAGG
# ...
#
# >AAGJ02000001
# 20 60 60 57 53 60 59 63 63 63 58 58 58 54 54 59 63 54 63 58
# 59 63 53 63 63 63 58 58 57 57 63 63 58 58 63 57 57 59 63 63
# 53 53 53 52 63 59 63 63 58 58 60 58 60 63 63 57 60 57 52 53
# ...

$ gzip strPur2.contigs.fa.qual
$ gzip strPur2.contigs.fa
$ ssh kkstore06
$ nice ~/kent/src/hg/utils/automation/makeGenomeDb.pl -continue db -workhorse kkstore06 \
./strPur2.config.ra | tee -a makeGenomeDb.pl.log3 2>&1

# loading Gold/Gap manually
$ ssh hgwdev
$ time nice hgGoldGapGl -noGl strPur2 strPur2.agp >hgGoldGapGl.log1 2>&1

real    0m6.283s
user    0m0.565s
sys     0m0.070s

# as with strPur1, the indices are not built correctly, so they need to be
# rebuilt
$ time nice hgsql strPur2 -e 'analyze table gold; analyze table gap;'
+--------------+---------+----------+----------+
| Table        | Op      | Msg_type | Msg_text |
+--------------+---------+----------+----------+
| strPur2.gold | analyze | status   | OK       |
+--------------+---------+----------+----------+
+-------------+---------+----------+----------+
| Table       | Op      | Msg_type | Msg_text |
+-------------+---------+----------+----------+
| strPur2.gap | analyze | status   | OK       |
+-------------+---------+----------+----------+

real    0m0.298s
user    0m0.000s
sys     0m0.004s

#
# Starting over, I have renamed the exisitng table so I can re-run
# makeGenomeDB
#
mysql> show tables;
+--------------------+
| Tables_in_strPur2  |
+--------------------+
| chromInfo_20070312 |
| gap_20070312       |
| gc5Base_20070312   |
| gold_20070312      |
| grp_20070312       |
| history_20070312   |
| quality_20070312   |
+--------------------+
7 rows in set (0.00 sec)

# moved previous runs to the side
$ cd /cluster/data/strPur2
$ mv M M_20070223
$ mv chrom.sizes chrom.sizes_20070223

# 
$ ssh kkstore06
$ cd /cluster/data/strPur2/fixup
$ nice ~/kent/src/hg/utils/automation/makeGenomeDb.pl -workhorse kkstore06
./strPur2.config.ra > makeGenomeDb.log4 2>&1
$ nice ~/kent/src/hg/utils/automation/makeGenomeDb.pl -continue db -workhorse kkstore06 
./strPur2.config.ra >> makeGenomeDb.log4

# 2007/Mar/14 - Kord
# Heather and I did a sanity check on the strPur2 database and feel the tables
# have been updated correctly, only the qual table isn't correct
# From here I have removed the qual line from the .ra file and continued the
# rest of the initial setup and will deal with the quality files later on.
$ ssh kkstore06
$ nice ~/kent/src/hg/utils/automation/makeGenomeDb.pl -continue dbDb
-workhorse kkstore06 ./strPur2.config.ra >> makeGenomeDb.log5 2>&1

########################################################################################
# REPEATMASKER (COMLETED 2007/Mar/22 Kord)

# verify the species name
$ /cluster/bluearc/RepeatMasker/util/queryRepeatDatabase.pl -species
Strongylocentrotus -stat

# queryRepeatDatabase
# ===================
# RepeatMasker Database: RepeatMaskerLib.embl
# Version: 20061006
# Species: Strongylocentrotus ( strongylocentrotus )
# >IS1#ARTEFACT/  Length = 768 bp
# >IS2#ARTEFACT/  Length = 1331 bp
# >IS3#ARTEFACT/  Length = 1258 bp
# ...
# >Polinton-4_SP#DNA/Maverick  Length = 15575 bp
# >Polinton-5_SP#DNA/Maverick  Length = 16525 bp
# >CR1-21_SP#LINE/L2  Length = 4603 bp

# 176 ancestral and ubiquitous sequence(s) with a total length of 52708 bp
# 99 lineage specific sequence(s) with a total length of 224080 bp
# --------------------------------------------------------------------------------
# 275 sequence(s) with a total length of 276788 bp

# Run -debug to create the dir structure and preview the scripts:
$ ssh kkstore06
$ ~/kent/src/hg/utils/automation/doRepeatMasker.pl strPur2 -verbose 3 -debug
-fileserver kkstore06

# run it for real
$ nice ~/kent/src/hg/utils/automation/doRepeatMasker.pl strPur2 -verbose 3
-fileserver kkstore06 -workhorse kolossus > RepeatMasker.log1 2>&1

# fixed umask issue and did a chmod g+w on /cluster/data/strPur2 and home
# sub-directories, added ~hiram/.bashrc.hiram content to my .bashrc to make
# sure I had the appropriate environment variables (e.g. $HOST)
# run it for real again
$ nice ~/kent/src/hg/utils/automation/doRepeatMasker.pl strPur2 -verbose 3 >
RepeatMasker.log2 2>&1

# it appears one node in kk is responsible for all the failures:
$ ssh kk
$ cd /cluster/data/strPur2/bed/RepeatMasker.2007-03-16/run.cluster
$  para problems | grep ^host | sort | uniq -c

# 2257 jobs in batch
# 14081 jobs (including everybody's) in Parasol queue.
# Checking finished jobs
#   6555 host: kkr4u02.kilokluster.ucsc.edu

# we removed the node and re-ran the jobs.
$ para push -retries=5


# make some links and files to continue doRepeatMasker
$ ssh kk
$ cd /cluster/data/strPur2/bed/                                    
$ ln -s RepeatMasker.2007-03-16 RepeatMasker.2007-03-22 
$ date > /cluster/data/strPur2/bed/RepeatMasker.2007-03-22/run.cluster/run.time
$ cd /cluster/data/strPur2/fixup
$ nice ~/kent/src/hg/utils/automation/doRepeatMasker.pl -continue cat strPur2
-verbose 3 > RepeatMasker.log3 2>&1 &

# Converage
$ ssh hgwdev
$ featureBits strPur2 rmsk
115258247 bases of 810038660 (14.229%) in intersection


########################################################################################
# SIMPLE REPEATS (TRF)  (DONE 2007/Mar/14 Kord)
$ ssh kkr1u00
$ mkdir /cluster/data/strPur2/bed/simpleRepeat

$ time twoBitToFa ../../strPur2.unmasked.2bit  stdout | trfBig -trf=/cluster/bin/i386/trf stdin /dev/null \
> -bedAt=simpleRepeat.bed -tempDir=/tmp > trf.log 2>&1   
# Complete in approx. 6 hours
# Make a filtered version for sequence masking:
$ awk '{if ($5 <= 12) print;}' simpleRepeat.bed > trfMask.bed
$ splitFileByColumn trfMask.bed trfMaskChrom

# Load unfiltered repeats into the database:
$ hgLoadBed strPur2 simpleRepeat \
> /cluster/data/strPur2/bed/simpleRepeat/simpleRepeat.bed \
> -sqlTable=/cluster/home/kord/kent/src/hg/lib/simpleRepeat.sql

# Coverage
$ featureBits strPur2 simpleRepeat
50692153 bases of 810038660 (6.258%) in intersection


########################################################################################
# MASK SEQUENCE WITH FILTERED TRF IN ADDITION TO RM (DONE 2007/MAR/22 Kord)
$ ssh kolossus
$ cd /cluster/data/strPur2
$ time twoBitMask strPur2.rmsk.2bit -add bed/simpleRepeat/trfMask.bed strPur2.2bit

# Warning: BED file bed/simpleRepeat/trfMask.bed has >=13 fields which means it
# might contain block coordinates, but this program uses
# only the first three fields (the entire span -- no support for blocks).
# real    0m10.698s
# user    0m1.871s
# sys     0m1.678s

# Link to it from /gbdb:
$ ssh hgwdev
$ ln -s /cluster/data/strPur2/strPur2.2bit /gbdb/strPur2/strPur2.2bit


########################################################################################
# BLAT SERVER (STARTED,DONE 2007/MAY/17 Kord)
# Sent request w/2bit paths to cluster-admin.
# Per Victoria:
# strPur2 has been started on blat13
# translated port on: 17780
# untranslated on: 17781 

# Added entries into hgcentraltest db
#
[kord@hgwdev /cluster/data/strPur2] hgsql hgcentraltest
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 40702725 to server version: 4.0.27-standard-log

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql> insert into blatServers (db, host, port, isTrans, canPcr) values
("strPur 2", "blat13", 17780, 1, 0); 
Query OK, 1 row affected (0.00 sec)

mysql> insert into blatServers (db, host, port, isTrans, canPcr) values
("strPur 2", "blat13", 17781, 0, 1); 
Query OK, 1 row affected (0.00 sec)

mysql> select * from blatServers where ( db='strpur2' or db='strpur 2');
+----------+--------+-------+---------+--------+
| db       | host   | port  | isTrans | canPcr |
+----------+--------+-------+---------+--------+
| strPur 2 | blat13 | 17781 |       0 |      1 |
| strPur 2 | blat13 | 17780 |       1 |      0 |
| strPur2  | blat13 | 17781 |       0 |      1 |
| strPur2  | blat13 | 17780 |       1 |      0 |
+----------+--------+-------+---------+--------+
4 rows in set (0.00 sec)

mysql> select * from blatServers where ( db='strpur 2');
+----------+--------+-------+---------+--------+
| db       | host   | port  | isTrans | canPcr |
+----------+--------+-------+---------+--------+
| strPur 2 | blat13 | 17781 |       0 |      1 |
| strPur 2 | blat13 | 17780 |       1 |      0 |
+----------+--------+-------+---------+--------+
2 rows in set (0.00 sec)

mysql> delete from blatServers where ( db='strpur 2');
Query OK, 2 rows affected (0.00 sec)

mysql> select * from blatServers where ( db='strpur2' or db='strpur 2');
+---------+--------+-------+---------+--------+
| db      | host   | port  | isTrans | canPcr |
+---------+--------+-------+---------+--------+
| strPur2 | blat13 | 17781 |       0 |      1 |
| strPur2 | blat13 | 17780 |       1 |      0 |
+---------+--------+-------+---------+--------+
2 rows in set (0.00 sec)


########################################################################################
# MAKE DOWNLOADABLE / GOLDENPATH FILES (STARTED 2007/MAY/17 Kord)
$ cd /cluster/data/strPur2
$ ln -s /cluster/data/strPur2/bed/RepeatMasker.2007-03-22/strPur2.fa.out 
$ ~/kent/src/hg/utils/automation/makeDownloads.pl strPur2 -verbose 2 > jkStuff/downloads.log &

# *** TODO ***
#	Edit these files
#     	/cluster/data/strPur2/goldenPath/database/README.txt
#     	/cluster/data/strPur2/goldenPath/bigZips/README.txt


########################################################################################
# PUT MASKED SEQUENCE OUT FOR CLUSTER RUNS (DONE 2007/MAY/30 Kord)

cp /cluster/data/strPur2/strPur2.2bit /cluster/bluearc/strPur2/
cp /cluster/data/strPur2/chrom.sizes /cluster/bluearc/strPur2/

# pitakluster:
ssh pk
cp /cluster/data/strPur2/strPur2.2bit /san/sanvol1/scratch/strPur2/
cp /cluster/data/strPur2/chrom.sizes /san/sanvol1/scratch/strPur2/
mkdir -p /san/sanvol1/scratch/strPur2/rmsk
cp -p /cluster/data/strPur2/strPur2.fa.out /san/sanvol1/scratch/strPur2/rmsk

# kki:
ssh kkr1u00
mkdir -p /iscratch/i/strPur2 
cp -p /cluster/data/strPur2/strPur2.2bit /iscratch/i/strPur2
cp -p /cluster/data/strPur2/chrom.sizes /iscratch/i/strPur2

# sync small cluster
ssh kkr1u00
cd /iscratch/i/strPur2
for R in 2 3 4 5 6 7 8
do
   rsync -av ./ kkr${R}u00:/iscratch/i/strPur2/ \
	--progress \
	--stats
done 


########################################################################################
# MAKE 11.00C FILE FOR BLAT (DONE 2007/MAY/30 Kord) 

# Using -repMatch=300 (per strPur1)
ssh kolossus
blat /cluster/data/strPur2/strPur2.2bit /dev/null /dev/null -tileSize=11 \
 -makeOoc=/cluster/bluearc/strPur2/11.ooc -repMatch=300
# Wrote 36124 overused 11-mers to /cluster/bluearc/strPur2/11.ooc
ssh kkr1u00
/iscratch/i/strPur2/
cp -p /cluster/bluearc/strPur2/11.ooc .

# sync cluster
ssh kkr1u00
cd /iscratch/i/strPur2
for R in 2 3 4 5 6 7 8
do
   rsync -av ./ kkr${R}u00:/iscratch/i/strPur2/ \
	--progress \
	--stats
done



########################################################################################
# GENBANK AUTO UPDATE 
# (STARTED 2007/MAY/30 Kord)
# (COMPLETED 2007/JUN/01 Kord)

ssh hgwdev
cd ~/kent/src/hg/makeDb/genbank
cvsup

# check data/organism.lst for counts of native mRNA, EST, RegSeq
cd /cluster/data/genbank/data/processed/genbank.159.0/full/
egrep purpuratus mrna.gbidx | egrep Strongylocentrotus | wc -l
#1097
egrep purpuratus est.*gbidx | egrep Strongylocentrotus | wc -l
#141833
cd /cluster/data/genbank/data/processed/refseq.23/full
egrep purpuratus mrna.gbidx | egrep Strongylocentrotus | wc -l 
#260

# edit etc/genbank.conf to add strPur2
cd ~/kent/src/hg/makeDb/genbank/etc/

# strPur2 (S. purpuratus)
strPur2.serverGenome = /cluster/data/strPur2/strPur2.2bit
strPur2.clusterGenome = /cluster/bluearc/strPur2/strPur2.2bit
strPur2.ooc = /cluster/bluearc/strPur2/11.ooc
strPur2.lift = no
strPur2.refseq.mrna.native.pslCDnaFilter  = ${lowCover.refseq.mrna.native.pslCDnaFilter}
strPur2.refseq.mrna.xeno.pslCDnaFilter    = ${lowCover.refseq.mrna.xeno.pslCDnaFilter}
strPur2.genbank.mrna.native.pslCDnaFilter = ${lowCover.genbank.mrna.native.pslCDnaFilter}
strPur2.genbank.mrna.xeno.pslCDnaFilter   = ${lowCover.genbank.mrna.xeno.pslCDnaFilter}
strPur2.genbank.est.native.pslCDnaFilter  = ${lowCover.genbank.est.native.pslCDnaFilter}
strPur2.refseq.mrna.native.load = yes
strPur2.refseq.mrna.xeno.load = yes
strPur2.genbank.mrna.xeno.load = yes
strPur2.genbank.est.native.load = yes
strPur2.downloadDir = strPur2
strPur2.perChromTables = no

cvs commit -m "added strPur2" genbank.conf

# This was already done with strPur1:
# edit src/lib/gbGenome.c
# static char *strPurNames[] = {"Strongylocentrotus purpuratus", NULL};
# static struct dbToSpecies dbToSpeciesMap[] = { 
#	...  {"strPur", strPurNames, NULL}, ...

make install-server

ssh kkstore02
cd /cluster/data/genbank/
nice time bin/gbAlignStep -initial strPur2
tail -f var/build/logs/2007.05.30-18:40:41.strPur2.initalign.log

# The job failed on kk:
# "Out of memory needLargeMem - request size 12 bytes"
# Mark D.: "The batch file end up being particularly large and the para
# command aborted checking the jobs due to our new memory limits.
# I pushed the jobs by hand."

# The job was continued with:
ssh kkstore02
cd /cluster/data/genbank/
nice bin/gbAlignStep -initial -continue=finish strPur2
tail -f var/build/logs/2007.05.31-13:29:15.strPur2.initalign.log

# load database
ssh hgwdev
cd /cluster/data/genbank
nice ./bin/gbDbLoadStep -drop -initalLoad strPur2

# Done by Heather: enable daily alignment and update of hgwdev
cd ~/kent/src/hg/makeDb/genbank
cvsup
# add strPur2 to:
    etc/align.dbs
    etc/hgwdev.dbs
cvs commit
make etc-update 


