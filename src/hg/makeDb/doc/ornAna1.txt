# for emacs: -*- mode: sh; -*-

# Ornithorhynchus anatinus -- WUSTL version 5.0 (Dec. 2006)


#########################################################################
# DOWNLOAD SEQUENCE (DONE 12/15/06 angie - REDONE 2/5/07 angie)
    ssh kkstore05
    mkdir /cluster/store12/ornAna1
    ln -s /cluster/store12/ornAna1 /cluster/data/ornAna1
    mkdir /cluster/data/ornAna1/downloads
    cd /cluster/data/ornAna1/downloads
    set baseUrl = http://genome.wustl.edu/pub/user/lhillier/private/platypus/
    wget --timestamping $baseUrl/platypus.tar.gz
    wget --timestamping $baseUrl/sctgs_hit_by_ESTs.not_yet_submitted.gz
    gunzip sctgs_hit_by_ESTs.not_yet_submitted.gz
    tar xvzf platypus.tar.gz
    faSize *.fa
#2016937414 bases (174725237 N's 1842212177 real 1842212177 upper 0 lower) in 20 sequences in 20 files
#Total size: mean 100846870.7 sd 348736694.0 min 1399469 (chr17) max 1579857390 (chrUn) median 16302927
#N count: mean 8736261.8 sd 32604763.8
#U count: mean 92110608.8 sd 316138018.7
#L count: mean 0.0 sd 0.0
    # Wow, chrUn is 1.5G even with 100bp contig gaps... that won't cause 
    # the browser to die (though it did provoke an integer-overflow -> 
    # infinite loop in faSize!) but it seems like it would be nicer to 
    # have sequence for just the super- and ultra-contigs for this assembly.
    # OK, LaDeana made new chrUn files that contain ultracontigs...
    wget --timestamping $baseUrl/chrUn.agp.gz
    wget --timestamping $baseUrl/chrUn.fa.gz
    mv chrUn.fa chrUn.fa.orig
    mv chrUn.agp chrUn.agp.orig
    gunzip chrUn.fa.gz chrUn.agp.gz
    # checkAgpAndFa found a slight hiccup: chrUn.fa had an empty Ultra673 
    # which was not in any .agp file.  Removed Ultra673 from chrUn.fa -- 
    # LaDeana confirmed that's OK.

    # RELOADING 2/5/07 to pick up slight changes to chr5 and chrUn so we 
    # will be completely in sync with GenBank
    cd /cluster/data/ornAna1
    mv downloads downloads.bak
    mkdir downloads
    cd downloads
    wget --timestamping $baseUrl/platypus.070113.tar.gz
    tar xvzf platypus.070113.tar.gz
    faSize *.fa
#Invalid fasta format: sequence size == 0 for element Ultra673
#1996794193 bases (154575690 N's 1842218503 real 1842218503 upper 0 lower) in 201523 sequences in 20 files
#Total size: mean 9908.5 sd 331992.5 min 0 (Ultra673) max 59581953 (chr3) median 1069
#N count: mean 767.0 sd 20573.1
#U count: mean 9141.5 sd 311758.8
#L count: mean 0.0 sd 0.0
    # I edited out the empty Ultra673 (LaDeana OK'd).


#########################################################################
# MAKE GENOME DB (DONE 12/19/06 angie - REDONE 2/5/07 angie)
    ssh kkstore05
    cd /cluster/data/ornAna1
    cat > ornAna1.config.ra <<EOF
# Config parameters for makeGenomeDb.pl:
db ornAna1
clade vertebrate
genomeCladePriority 335
commonName Platypus
scientificName Ornithorhynchus anatinus
assemblyDate Dec. 2006
assemblyLabel WUSTL version 6.0?
orderKey 365
mitoAcc 5836058
fastaFiles /cluster/data/ornAna1/downloads/chr*.fa
agpFiles /cluster/data/ornAna1/downloads/chr*.agp
dbDbSpeciesDir platypus
EOF

    ~/kent/src/hg/utils/automation/makeGenomeDb.pl ornAna1.config.ra \
      >& makeGenomeDb.log & tail -f makeGenomeDb.log
    # Followed instructions printed out at the end of the script for 
    # editing the template description files and checked them in.


#########################################################################
# RELOAD GOLD/GAP, REBUILD DOWNLOAD AFTER AGP TWEAK (DONE 1/8/07 angie - OBSOLETED BY TOTAL REBUILD)
# LaDeana sent a manual tweak to chr5.agp:  change "p" to "-" for
# this one entry:
# chr5    647409    657392    203    W    Contig2532.3    1    9984    p
# So reload the agp, re-compress for download.
    ssh kkstore05
    cd /cluster/data/ornAna1
    # Make the necessary edits:
    $EDITOR downloads/chr5.agp
    $EDITOR ornAna1.agp
    # Reload the table
    ssh -x hgwdev hgGoldGapGl -noGl ornAna1 /cluster/data/ornAna1/ornAna1.agp
    # Regenerate the download file and update md5sum.txt:
    cd /cluster/data/ornAna1/goldenPath/bigZips
    gzip -c /cluster/data/ornAna1/ornAna1.agp > ornAna1.agp.gz
    md5sum ornAna1.agp.gz
#e8539f496b2343c5e802b2362e61c9a3  ornAna1.agp.gz
    $EDITOR md5sum.txt


#########################################################################
# REPEATMASKER (DONE 12/20/06 angie - REDONE 2/5/07)
    ssh kkstore05
    # Run -debug to create the dir structure and preview the scripts:
    doRepeatMasker.pl ornAna1 -verbose 3 -debug
    # Run it for real and tail the log:
    doRepeatMasker.pl ornAna1 -verbose 3 \
      >& /cluster/data/ornAna1/bed/RepeatMasker.2007-02-05/do.log &
    tail -f /cluster/data/ornAna1/bed/RepeatMasker.2007-02-05/do.log
    # RepeatMasker and lib version from do.log:
#grep version of RepeatMasker$ /cluster/bluearc/RepeatMasker/RepeatMasker
#    October 6 2006 (open-3-1-6) version of RepeatMasker
#grep RELEASE /cluster/bluearc/RepeatMasker/Libraries/RepeatMaskerLib.embl
#CC   RELEASE 20061006;                                            *
    # Coverage:
    featureBits ornAna1 rmsk
#633511004 bases of 1842236818 (34.388%) in intersection


#########################################################################
# SIMPLE REPEATS (TRF) (DONE 12/20/06 angie - REDONE 2/6/07)
    # The first time around I just piped twoBitToFa|trfBig but due to the
    # large number of scaffolds, that took 12.5 hours.  This time, make it
    # a small cluster job.
    ssh kki
    mkdir /cluster/data/ornAna1/bed/simpleRepeat
    cd /cluster/data/ornAna1/bed/simpleRepeat
    # no splitting -- choose a chunk size equal to the largest sequence:
    set chunkSize = `awk '{print $2;}' ../../chrom.sizes | sort -nr | head -1`
    ~/kent/src/hg/utils/automation/simplePartition.pl ../../ornAna1.unmasked.2bit $chunkSize chunks
    cat > gsub <<'_EOF_'
#LOOP
./doTrfBig.csh {check in exists $(path1)} {check out exists $(path1).bed}
#ENDLOOP
'_EOF_'
    # << emacs
    cat > doTrfBig.csh <<'_EOF_'
#!/bin/csh -ef

sed -e 's/^.*://' $1 \
| twoBitToFa ../../ornAna1.unmasked.2bit -seqList=stdin stdout \
| trfBig -trf=/cluster/bin/i386/trf stdin /dev/null \
      -bedAt=$2 -tempDir=/tmp
'_EOF_'
    # << emacs
    chmod a+x doTrfBig.csh
    ls -1S chunks/*/*.lst > chunks.lst
    gensub2 chunks.lst single gsub jobList
    para make jobList
    para time
#Completed: 36 of 36 jobs
#CPU time in finished jobs:      13498s     224.96m     3.75h    0.16d  0.000 y
#IO & Wait Time:                   749s      12.49m     0.21h    0.01d  0.000 y
#Average job time:                 396s       6.60m     0.11h    0.00d
#Longest finished job:            1017s      16.95m     0.28h    0.01d
#Submission to last job:          1017s      16.95m     0.28h    0.01d
    cat chunks/*/*.bed > simpleRepeat.bed

    # Make a filtered version for sequence masking:
    awk '{if ($5 <= 12) print;}' simpleRepeat.bed > trfMask.bed

    # Load unfiltered repeats into the database:
    ssh hgwdev
    hgLoadBed ornAna1 simpleRepeat \
      /cluster/data/ornAna1/bed/simpleRepeat/simpleRepeat.bed \
      -sqlTable=$HOME/kent/src/hg/lib/simpleRepeat.sql
    featureBits ornAna1 simpleRepeat
#38774128 bases of 1842236818 (2.105%) in intersection


#########################################################################
# MASK SEQUENCE WITH FILTERED TRF IN ADDITION TO RM (DONE 12/20/06 angie - REDONE 2/6/07)
    ssh kolossus
    cd /cluster/data/ornAna1
    time twoBitMask ornAna1.rmsk.2bit -add bed/simpleRepeat/trfMask.bed ornAna1.2bit
    # This warning is OK -- the extra fields are not block coordinates.
#Warning: BED file bed/simpleRepeat/trfMask.bed has >=13 fields which means it might contain block coordinates, but this program uses only the first three fields (the entire span -- no support for blocks).
#5.490u 3.275s 0:18.91 46.3%     0+0k 0+0io 4pf+0w
    # Link to it from /gbdb:
    ssh hgwdev
    ln -s /cluster/data/ornAna1/ornAna1.2bit /gbdb/ornAna1/ornAna1.2bit


#########################################################################
# MAKE DOWNLOADABLE / GOLDENPATH FILES (DONE 12/21/06 angie - REDONE 2/6/07)
    cd /cluster/data/ornAna1
    ln -s bed/RepeatMasker.2007-02-05/ornAna1.fa.out .
    makeDownloads.pl ornAna1 -verbose=2 \
      >& jkStuff/downloads.log & tail -f jkStuff/downloads.log
    # Edit README.txt files when done:
# *** Edit each README.txt to resolve any notes marked with "***":
#     /cluster/data/ornAna1/goldenPath/database/README.txt
#     /cluster/data/ornAna1/goldenPath/bigZips/README.txt


#########################################################################
# WINDOWMASKER FOR COMPARISON (IN PROGRESS 1/11/07 angie)
    cd /cluster/data/ornAna1
    ~/kent/src/hg/utils/automation/doWindowMasker.pl -debug ornAna1
    ~/kent/src/hg/utils/automation/doWindowMasker.pl ornAna1 \
      >& bed/WindowMasker.2006-12-22/do.log &
    tail -f bed/WindowMasker.2006-12-22/do.log
    # Needs -workhorse kolossus so it can connect to the NCBI server...
    #     ~/kent/src/hg/utils/automation/doWindowMasker.pl ornAna1 \
    ~/kent/src/hg/utils/automation/doWindowMasker.pl ornAna1 \
      -buildDir /cluster/data/ornAna1/bed/WindowMasker.2006-12-22/do.log \
      -workhorse kolossus -continue mask \
      >& bed/WindowMasker.2006-12-22/do.log &
    tail -f bed/WindowMasker.2006-12-22/do.log
    cd bed/WindowMasker.2006-12-22
    # Compare coverage to rmsk which was 633510998 / 1842236818 = 34.388%
    zcat windowmasker.bed.gz | awk '{print $3 - $2}' | total
#844961729
    # 844961729 / 1842236818 = 45.866%
    zcat windowmasker.sdust.bed.gz | awk '{print $3 - $2}' | total
#1011460283
    # 1011460283 / 1842236818 = 54.904%
    # The coverage is higher, but do we really want to mask 55% of the 
    # assembly before alignment??
#TODO - evaluate!!


#########################################################################
# MAKE 11.OOC FILE FOR BLAT (DONE 12/22/06 angie - REDONE 2/6/07)
# (probably frivolous to redo because the assembly changes were so small, 
# but redo anyway so it's reproduceable later.)
    # Use -repMatch=608 
    # To determine -repMatch for new species, first scale 1024 by size 
    # relative to human (e.g. divide ornAna1 / hg18 gapless bases from 
    # featureBits).  That gives ~607, rounding up to 608.
    ssh kolossus
    blat /cluster/data/ornAna1/ornAna1.2bit /dev/null /dev/null -tileSize=11 \
      -makeOoc=/cluster/bluearc/ornAna1/11.ooc -repMatch=608
#Wrote 35954 overused 11-mers to /cluster/bluearc/ornAna1/11.ooc


#########################################################################
# GENBANK AUTO UPDATE (DONE 1/5/07 angie - REDONE 2/6/07)
    # align with latest genbank process.
    ssh hgwdev
    cd ~/kent/src/hg/makeDb/genbank
    cvsup
    # edit etc/genbank.conf to add ornAna1 just after dm2...

# ornAna1 (Platypus -- O. anatinus)
ornAna1.serverGenome = /cluster/data/ornAna1/ornAna1.2bit
ornAna1.clusterGenome = /iscratch/i/ornAna1/ornAna1.2bit
ornAna1.refseq.mrna.native.pslCDnaFilter  = ${ordered.refseq.mrna.native.pslCDnaFilter}
ornAna1.refseq.mrna.xeno.pslCDnaFilter    = ${ordered.refseq.mrna.xeno.pslCDnaFilter}
ornAna1.genbank.mrna.native.pslCDnaFilter = ${ordered.genbank.mrna.native.pslCDnaFilter}
ornAna1.genbank.mrna.xeno.pslCDnaFilter   = ${ordered.genbank.mrna.xeno.pslCDnaFilter}
ornAna1.genbank.est.native.pslCDnaFilter  = ${ordered.genbank.est.native.pslCDnaFilter}
ornAna1.ooc = /cluster/bluearc/ornAna1/11.ooc
ornAna1.lift = no
ornAna1.genbank.mrna.xeno.load = yes
ornAna1.downloadDir = ornAna1
ornAna1.perChromTables = no

    cvs ci -m "Added ornAna1." etc/genbank.conf
    # update /cluster/data/genbank/:
    make etc-update

    # Edit src/lib/gbGenome.c to add new species.
    cvs ci -m "Added O. anatinus (platypus)." src/lib/gbGenome.c
    make install-server

    ssh kkstore02
    cd /cluster/data/genbank
    nice bin/gbAlignStep -initial ornAna1 &
    # load database when finished
    ssh hgwdev
    cd /cluster/data/genbank
    nice ./bin/gbDbLoadStep -drop -initialLoad ornAna1 &

    # enable daily alignment and update of hgwdev
    cd ~/kent/src/hg/makeDb/genbank
    cvsup
    # add ornAna1 to:
        etc/align.dbs
        etc/hgwdev.dbs
    cvs ci -m "Added ornAna1." etc/align.dbs etc/hgwdev.dbs
    make etc-update


#########################################################################
# SWAP HG18 CHAIN/NET (DONE 4/9/07 angie)
    ssh kkstore05
    mkdir /cluster/data/ornAna1/bed/blastz.hg18.swap
    cd /cluster/data/ornAna1/bed/blastz.hg18.swap
    doBlastzChainNet.pl -swap \
      /cluster/data/hg18/bed/blastz.ornAna1.2007-02-21/DEF >& do.log &
    tail -f do.log
    ln -s blastz.hg18.swap /cluster/data/ornAna1/bed/blastz.hg18


#########################################################################
# SWAP MM8 CHAIN/NET (DONE 3/2/07 angie)
    ssh kkstore05
    mkdir /cluster/data/ornAna1/bed/blastz.mm8.swap
    cd /cluster/data/ornAna1/bed/blastz.mm8.swap
    doBlastzChainNet.pl -swap \
      /cluster/data/mm8/bed/blastz.ornAna1.2007-02-27/DEF >& do.log &
    tail -f do.log
    ln -s blastz.mm8.swap /cluster/data/ornAna1/bed/blastz.mm8


#########################################################################
# SWAP GALGAL3 CHAIN/NET (DONE 4/9/07 angie)
    ssh kkstore05
    mkdir /cluster/data/ornAna1/bed/blastz.galGal3.swap
    cd /cluster/data/ornAna1/bed/blastz.galGal3.swap
    doBlastzChainNet.pl -swap \
      /cluster/data/galGal3/bed/blastz.ornAna1.2007-04-06/DEF >& do.log &
    tail -f do.log
    ln -s blastz.galGal3.swap /cluster/data/ornAna1/bed/blastz.galGal3


#########################################################################
# SWAP MONDOM4 CHAIN/NET (DONE 4/3/07 angie)
    ssh kkstore05
    mkdir /cluster/data/ornAna1/bed/blastz.monDom4.swap
    cd /cluster/data/ornAna1/bed/blastz.monDom4.swap
    doBlastzChainNet.pl -swap -workhorse=kkr3u00 \
      /cluster/data/monDom4/bed/blastz.ornAna1/DEF >& do.log &
    tail -f do.log
    ln -s blastz.monDom4.swap /cluster/data/ornAna1/bed/blastz.monDom4


#######################################################################
# BLASTZ LIZARD ANOCAR1 (DONE 4/18/07 angie)
    ssh kkstore05
    mkdir /cluster/data/ornAna1/bed/blastz.anoCar1.2007-04-03
    cd /cluster/data/ornAna1/bed/blastz.anoCar1.2007-04-03
    cat << '_EOF_' > DEF
# chicken vs. platypus

# Use "human-fish" params.
# If that causes us to get swamped, we can increase L.
BLASTZ_H=2000
BLASTZ_Y=3400
BLASTZ_L=6000
BLASTZ_K=2200
BLASTZ_Q=/cluster/data/blastz/HoxD55.q

# TARGET: Platypus ornAna1
SEQ1_DIR=/san/sanvol1/scratch/ornAna1/ornAna1.2bit
SEQ1_LEN=/san/sanvol1/scratch/ornAna1/chrom.sizes
SEQ1_CHUNK=20000000
SEQ1_LIMIT=100
SEQ1_LAP=10000

# QUERY: Lizard anoCar1
SEQ2_DIR=/san/sanvol1/scratch/anoCar1/anoCar1.2bit
SEQ2_LEN=/san/sanvol1/scratch/anoCar1/chrom.sizes
SEQ2_CHUNK=50000000
SEQ2_LIMIT=500
SEQ2_LAP=0

BASE=/cluster/data/ornAna1/bed/blastz.anoCar1.2007-04-03
TMPDIR=/scratch/tmp
'_EOF_'
    # << emacs
    doBlastzChainNet.pl DEF \
      -bigClusterHub pk -smallClusterHub pk \
      >& do.log & tail -f do.log
    ln -s blastz.anoCar1.2007-04-03 /cluster/data/ornAna1/bed/blastz.anoCar1


#########################################################################
# UPDATE DEFAULT POSITION (DONE 4/18/07 angie)
# This is a fairly well-conserved region of chrX5 with homology to
# chicken chrZ and an intronEst (platypus GenBank seqs are rare!)...
    ssh hgwdev
    hgsql hgcentraltest -e \
      'update dbDb set defaultPos = "chrX5:26260001-26320000" where \
       name = "ornAna1";'


#########################################################################
# REPEATMASKER BETA TEST (DONE 4/19/07 angie)
    ssh kkstore05
    # Run -debug to create the dir structure and preview the scripts:
    doRepeatMasker.pl ornAna1 -verbose 3 -debug
    # Run it for real and tail the log:
    doRepeatMasker.pl ornAna1 -verbose 3 \
      -stop mask \
      >& /cluster/data/ornAna1/bed/RepeatMasker.2007-04-18/do.log &
    tail -f /cluster/data/ornAna1/bed/RepeatMasker.2007-04-18/do.log
    # RepeatMasker and lib version from do.log:
#grep version of RepeatMasker$ /cluster/bluearc/RepeatMasker/RepeatMasker
#    April 17 2007 (open-3-1-7) version of RepeatMasker
#grep RELEASE /cluster/bluearc/RepeatMasker/Libraries/RepeatMaskerLib.embl
#CC   RELEASE 20061006;                                            *
    # Now load the new files as table rmskBeta for comparison:
    ssh hgwdev
    cd /cluster/data/ornAna1/bed/RepeatMasker.2007-04-18
    hgLoadOut -table=rmskBeta -nosplit ornAna1 ornAna1.fa.out
    # Coverage:
    featureBits ornAna1 rmskBeta
#632312336 bases of 1842236818 (34.323%) in intersection
    # a slight drop from the previous version:
#previous version:
#633511004 bases of 1842236818 (34.388%) in intersection
    # Robert Hubley says that's not unexpected -- he and Arian will look 
    # more closely.
    nice featureBits ornAna1 rmsk \!rmskBeta -minSize=200 -bed=stdout | head


#########################################################################
#########################################################################
#########################################################################
