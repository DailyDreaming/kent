# for emacs: -*- mode: sh; -*-

# Pteropus vampyrus

#########################################################################
# DOWNLOAD SEQUENCE 
    ssh kkstore05
    mkdir /cluster/store12/pteVam1
    ln -s /cluster/store12/pteVam1 /cluster/data
    mkdir /cluster/data/pteVam1/broad
    cd /cluster/data/pteVam1/broad

    wget --timestamping \
ftp://ftp.broad.mit.edu/pub/assemblies/mammals/megabat/assembly.agp \
ftp://ftp.broad.mit.edu/pub/assemblies/mammals/megabat/assembly.bases.gz \
ftp://ftp.broad.mit.edu/pub/assemblies/mammals/megabat/assembly.quals.gz 


qaToQac assembly.quals.gz stdout | qacAgpLift assembly.agp stdin pteVam1.qual.qac

    wget --timestamping \
ftp://ftp.broad.mit.edu/pub/assemblies/mammals/megabat/BasicStats.out



# --------------------------------------------------------------------------------
# Sun Jun 08 21:15:46 2008 run (pid=20620) using Wed May 28 18:47:34 EDT 2008
# make
# BasicStats PRE=/seq/assembly_analysis/ DATA=projects/LowCoverage/Vampyrus
#           RUN=run/work SUBDIR=assembly.8_FinalizeAssembly QUAL_STATS=True
#	              OUTFILE=BasicStats.out
#--------------------------------------------------------------------------------
#
#Supercontigs having < 3 reads or < 1kb sequence are
#ignored.
#1669 gaps <= -1000; 0 gaps <= -10000; 0 gaps <= -100000
#fraction of gaps < -10kb or more than 4 deviations below
#zero: 0.417%
#0 gaps > 10kb, 0 gaps > 50kb, 0 gaps > 200kb, 0 gaps >
#1Mb
#92.4% of reads were used in the assembly (92.98% of
#bases, 92.55% of Q20 bases)
#0% of reads were used multiply in the assembly
#355409 contigs, having N50 length 8747
#total contig length: 1802061378, spanning 1947863545
#bases (with 7.49% in gaps)
#63545 supercontigs, having N50 length 121471 (not
#including gaps)
#68.7% of assembly in supers of size < 200000 (1337400469
#bases)
#Assembly base coverage: 3.13X.  Assembly Q20 coverage:
#2.86X.
#100% of bases have q >= 1
#98.07% of bases have q >= 20
#95.57% of bases have q >= 30
#93.01% of bases have q >= 40
#89.77% of bases have q >= 50

   cut -f 1 assembly.agp | uniq -c | wc -l 
   # Number of scaffolds: 96946


#########################################################################
# Create .ra file and run makeGenomeDb.pl
    ssh kkstore05
    cd /cluster/data/pteVam1
cat << _EOF_ >pteVam1.config.ra
# Config parameters for makeGenomeDb.pl:
db pteVam1
clade mammal
genomeCladePriority 35
scientificName Pteropus vampyrus
commonName Megabat
assemblyDate Jul. 2008
assemblyLabel Broad Institute pteVam1 
orderKey 233.5
#mitoAcc AJ222767
mitoAcc none
fastaFiles /cluster/data/pteVam1/broad/assembly.bases.gz
agpFiles /cluster/data/pteVam1/broad/assembly.agp
qualFiles /cluster/data/pteVam1/broad/pteVam1.qual.qac
dbDbSpeciesDir megabat
_EOF_

# use 'screen' make sure on kkstore05
    makeGenomeDb.pl -verbose=2 pteVam1.config.ra > makeGenomeDb.out 2>&1 &

# 'ctl-a ctl -d' returns to previous shell
cut -f 2 chrom.sizes | ave stdin
# Q1 1162.000000
# median 1777.000000
# Q3 9073.500000
# average 20589.606956
# min 601.000000
# max 1019178.000000
# count 96946
# total 1996080036.000000
# standard deviation 54685.357562


#########################################################################
# REPEATMASKER (DONE - 2008-07-28 braney)
    ssh kkstore05
    screen # use a screen to manage this job
    mkdir /cluster/data/pteVam1/bed/repeatMasker
    cd /cluster/data/pteVam1/bed/repeatMasker
    doRepeatMasker.pl -buildDir=/cluster/data/pteVam1/bed/repeatMasker \
        pteVam1 > do.log 2>&1 &

    # Note: can run simpleRepeats simultaneously
    #### When done with RM:
    ssh pk
    para time
    # Completed: 4794 of 4794 jobs
    # CPU time in finished jobs:   17003294s  283388.23m  4723.14h  196.80d
    # 0.539 y
    # IO & Wait Time:                126432s    2107.21m    35.12h    1.46d
    # 0.004 y
    # Average job time:                3573s      59.55m     0.99h    0.04d
    # Longest finished job:           11478s     191.30m     3.19h    0.13d
    # Submission to last job:        132391s    2206.52m    36.78h    1.53d

    time nice -n +19 featureBits pteVam1 rmsk > fb.pteVam1.rmsk.txt 2>&1 &
    # 581029514 bases of 1839440286 (31.587%) in intersection

    # RepeatMasker and lib version from do.log:
    #    Jun 13 2008 (open-3-2-5) version of RepeatMasker
    # CC   RELEASE 20080611; 

#########################################################################
# SIMPLE REPEATS TRF (DONE - 2008-07-28 braney)
    ssh kkstore05
    screen # use a screen to manage this job
    mkdir /cluster/data/pteVam1/bed/simpleRepeat
    cd /cluster/data/pteVam1/bed/simpleRepeat
    # 
    doSimpleRepeat.pl -buildDir=/cluster/data/pteVam1/bed/simpleRepeat \
	pteVam1 > do.log 2>&1 &

    #### When done
    ssh pk
    para time
    # Completed: 40 of 40 jobs
    # CPU time in finished jobs:      19524s     325.40m     5.42h    0.23d
    # 0.001 y
    # IO & Wait Time:                   119s       1.98m     0.03h    0.00d
    # 0.000 y
    # Average job time:                 491s       8.18m     0.14h    0.01d
    # Longest finished job:            4715s      78.58m     1.31h    0.05d
    # Submission to last job:          5306s      88.43m     1.47h    0.06d

    featureBits pteVam1 simpleRepeat
    # 33179383 bases of 1839440286 (1.804%) in intersection

    #	after RM run is done, add this mask:
    cd /cluster/data/pteVam1
    twoBitMask pteVam1.rmsk.2bit -add bed/simpleRepeat/trfMask.bed pteVam1.2bit

    twoBitToFa pteVam1.2bit stdout | faSize stdin
# 1996080036 bases (156639750 N's 1839440286 real 1258682971 upper 580757315
# lower) in 96946 sequences in 1 files
# Total size: mean 20589.6 sd 54685.6 min 601 (scaffold_96945) max 1019178
# (scaffold_0) median 1777
# N count: mean 1615.7 sd 3733.4
# U count: mean 12983.3 sd 35952.8
# L count: mean 5990.5 sd 15976.6
# %29.09 masked total, %31.57 masked real

    twoBitToFa pteVam1.rmsk.2bit stdout | faSize stdin
# 1996080036 bases (156639750 N's 1839440286 real 1259287571 upper 580152715
# lower) in 96946 sequences in 1 files
# Total size: mean 20589.6 sd 54685.6 min 601 (scaffold_96945) max 1019178
# (scaffold_0) median 1777
# N count: mean 1615.7 sd 3733.4
# U count: mean 12989.6 sd 35967.3
# L count: mean 5984.3 sd 15963.0
# %29.06 masked total, %31.54 masked real

    ln -s /cluster/data/pteVam1/pteVam1.2bit /gbdb/pteVam1/pteVam1.2bit

    cp /cluster/data/pteVam1/pteVam1.2bit /san/sanvol1/scratch/pteVam1
    cp /cluster/data/pteVam1/chrom.sizes /san/sanvol1/scratch/pteVam1
