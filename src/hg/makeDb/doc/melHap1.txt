# for emacs: -*- mode: sh; -*-

# Meloidogyne hapla
# The Center for the Biology of Nematode Parasitism, N.C. State
# "Sequence and genetic map of Meloidogyne hapla:
#	A compact nematode genome for plant parasitism"
#	http://www.pnas.org/content/105/39/14802.full
#	PNAS  September 30, 2008   vol. 105  no. 39  14802-14807 

##############################################################################
## Fetch sequence (DONE - 2010-09-20 - Hiram)

    mkdir -p /hive/data/genomes/melHap1/ws210
    cd /hive/data/genomes/melHap1/ws210

    wget --no-parent --timestamping -m -nH --cut-dirs=5 \
	ftp://ftp.sanger.ac.uk/pub/wormbase/WS210/genomes/m_hapla/

    hgFakeAgp -minContigGap=1 \
	sequences/dna/b_malayi.WS210.dna.fa.gz ucsc.fake.melHap1.agp

##############################################################################
## Initial browser build (DONE - 2010-09-20 - Hiram)
    cd /hive/data/genomes/melHap1

    cat << '_EOF_' > melHap1.config.ra
# Config parameters for makeGenomeDb.pl:
db melHap1
clade worm
genomeCladePriority 82
scientificName Meloidogyne hapla
commonName M. hapla
assemblyDate Sep. 2008
assemblyLabel The Center for the Biology of Nematode Parasitism, N.C. State
assemblyShortLabel M. hapla VW9 WS210
orderKey 895
mitoAcc none
fastaFiles /hive/data/genomes/melHap1/ws210/sequences/dna/m_hapla.WS210.dna.fa.gz
agpFiles /hive/data/genomes/melHap1/ws210/ucsc.fake.melHap1.agp
# qualFiles none
dbDbSpeciesDir worm
taxId 6305
'_EOF_'
    # << happy emacs

    time makeGenomeDb.pl -workhorse=hgwdev -verbose=2 \
	melHap1.config.ra > makeGenomeDb.log 2>&1
    #	real    0m42.028s

##############################################################################
# REPEATMASKER (DONE - 2010-09-21 - Hiram)
    screen 	#	use screen to control the job
    mkdir /hive/data/genomes/melHap1/bed/repeatMasker
    cd /hive/data/genomes/melHap1/bed/repeatMasker
    time nice -n +19 doRepeatMasker.pl -noSplit -bigClusterHub=pk \
	-buildDir=`pwd` melHap1 > do.log 2>&1 &
    #	real    23m56.249s

    #	from the do.log:
    #	RepeatMasker version development-$Id:
    #	RepeatMasker,v 1.25 2010/09/08 21:32:26 angie Exp
    #	CC   RELEASE 20090604;                                            *

    cat faSize.rmsk.txt
    #	53017507 bases (0 N's 53017507 real 43261440 upper 9756067 lower)
    #	in 3452 sequences in 1 files
    #	%18.40 masked total, %18.40 masked real

#########################################################################
# SIMPLE REPEATS (DONE - 2010-09-21 - Hiram)
    screen 	#	use screen to control the job
    mkdir /hive/data/genomes/melHap1/bed/simpleRepeat
    cd /hive/data/genomes/melHap1/bed/simpleRepeat
    time nice -n +19 doSimpleRepeat.pl -workhorse=hgwdev \
	-smallClusterHub=memk -buildDir=`pwd` melHap1 > do.log 2>&1 &
    #	real    11m40.808s

    cat fb.simpleRepeat 
    #	2456208 bases of 53017507 (4.633%) in intersection

#########################################################################
# run window masker (DONE - 2010-09-21 - Hiram)
    mkdir /hive/data/genomes/melHap1/bed/windowMasker
    cd /hive/data/genomes/melHap1/bed/windowMasker
    time doWindowMasker.pl -verbose=2 -workhorse=kolossus \
	-buildDir=`pwd` melHap1 > do.log 2>&1 &
    #	real    1m59.029s

    twoBitToFa melHap1.wmsk.sdust.2bit stdout | faSize stdin
    #	53017507 bases (0 N's 53017507 real 24940979 upper 28076528 lower)
    #	in 3452 sequences in 1 files
    #	%52.96 masked total, %52.96 masked real

    hgLoadBed melHap1 windowmaskerSdust windowmasker.sdust.bed.gz
    #	Loaded 477268 elements of size 3
    featureBits melHap1 windowmaskerSdust
    #	28076528 bases of 53017507 (52.957%) in intersection

    #	this is the mask for the genome
    cd /hive/data/genomes/melHap1
    zcat bed/windowMasker/windowmasker.sdust.bed.gz \
	| twoBitMask melHap1.unmasked.2bit stdin \
	    -type=.bed melHap1.2bit
    twoBitToFa melHap1.2bit stdout | faSize stdin
    #	53017507 bases (0 N's 53017507 real 24940979 upper 28076528 lower)
    #	in 3452 sequences in 1 files
    #	%52.96 masked total, %52.96 masked real

    ln -s `pwd`/melHap1.2bit /gbdb/melHap1/melHap1.2bit

########################################################################
# MAKE 11.OOC FILE FOR BLAT/GENBANK (DONE - 2010-09-21 - Hiram)
    # numerator is melHap1 gapless bases "real" as reported by faSize 
    # denominator is hg19 gapless bases as reported by featureBits,
    #	featureBits hg19 gap
    # 1024 is threshold used for human -repMatch:
    calc \( 53017507 / 2897310462 \) \* 1024
    #	( 53017507 / 2897310462 ) * 1024 = 18.738043
    # 18 is way too small, use 100 to keep the number of overused
    #	11-mers to a smaller number

    cd /hive/data/genomes/melHap1
    blat melHap1.2bit /dev/null /dev/null -tileSize=11 \
      -makeOoc=melHap1.11.ooc -repMatch=50
    #	Wrote 6149 overused 11-mers to melHap1.11.ooc

    mkdir /hive/data/staging/data/melHap1
    cp -p melHap1.2bit chrom.sizes melHap1.11.ooc \
	/hive/data/staging/data/melHap1

#########################################################################
# SWAP LASTZ ce9 (DONE - 2010-09-23 - Hiram)
    # original alignment
    cd /hive/data/genomes/ce9/bed/blastzMelHap1.2010-09-22
    cat fb.ce9.chainMelHap1Link.txt 
    #	3933301 bases of 100286004 (3.922%) in intersection

    #	running swap
    mkdir /hive/data/genomes/melHap1/bed/blastz.ce9.swap
    cd /hive/data/genomes/melHap1/bed/blastz.ce9.swap
    time nice -n +19 doBlastzChainNet.pl -verbose=2 \
	/hive/data/genomes/ce9/bed/blastzMelHap1.2010-09-22/DEF \
	-qRepeats=windowmaskerSdust -bigClusterHub=pk \
	-workhorse=hgwdev -smallClusterHub=memk -swap > swap.log 2>&1 &
    #	real    0m23.154s

    cat fb.melHap1.chainCe9Link.txt
    #	3631046 bases of 53017507 (6.849%) in intersection

#########################################################################
# GENBANK AUTO UPDATE (DONE - 2010-09-27 - Hiram)
    # align with latest genbank process.
    ssh hgwdev
    cd ~/kent/src/hg/makeDb/genbank
    git pull
    # edit etc/genbank.conf to add melHap1 just before caeJap2

# melHap1 (Meloidogyne hapla)
melHap1.serverGenome = /hive/data/genomes/melHap1/melHap1.2bit
melHap1.clusterGenome = /scratch/data/melHap1/melHap1.2bit
melHap1.ooc = /scratch/data/melHap1/melHap1.11.ooc
melHap1.lift = no
melHap1.refseq.mrna.native.pslCDnaFilter  = ${lowCover.refseq.mrna.native.pslCDnaFilter}
melHap1.refseq.mrna.xeno.pslCDnaFilter    = ${lowCover.refseq.mrna.xeno.pslCDnaFilter}
melHap1.genbank.mrna.native.pslCDnaFilter = ${lowCover.genbank.mrna.native.pslCDnaFilter}
melHap1.genbank.mrna.xeno.pslCDnaFilter   = ${lowCover.genbank.mrna.xeno.pslCDnaFilter}
melHap1.genbank.est.native.pslCDnaFilter  = ${lowCover.genbank.est.native.pslCDnaFilter} 
melHap1.refseq.mrna.native.load = yes
melHap1.refseq.mrna.xeno.load  = yes
melHap1.refseq.mrna.xeno.loadDesc = yes
melHap1.genbank.mrna.xeno.load = yes
melHap1.genbank.est.native.load = yes
melHap1.genbank.est.native.loadDesc = no
melHap1.downloadDir = melHap1
melHap1.perChromTables = no

    git commit -m "Added melHap1 M. hapla WS210" etc/genbank.conf
    git push
    # update /cluster/data/genbank/:
    make etc-update

    ssh genbank
    screen		#	use a screen to manage this job
    cd /cluster/data/genbank
    time nice -n +19 bin/gbAlignStep -initial melHap1 &
    #	logFile: var/build/logs/2010.09.27-13:30:40.melHap1.initalign.log
    #	real    119m17.816s
    # this had a failure during the fetch:
    # Exception: process signaled 9: "gbAlignGet
    # -workdir=work/initial.melHap1/align -orgCats=xeno,native -polyASizes
    # -fasize=4194304 -noMigrate genbank.179.0 full mrna melHap1"

    #	remove the work/initial.melHap1 directory and start over:
    time nice -n +19 bin/gbAlignStep -initial melHap1 &
    #	logFile: var/build/logs/2010.09.28-10:10:02.melHap1.initalign.log
    #	real    201m42.832s

    # load database when finished
    ssh hgwdev
    cd /cluster/data/genbank
    time nice -n +19 ./bin/gbDbLoadStep -drop -initialLoad melHap1
    #	logFile: var/dbload/hgwdev/logs/2010.09.28-14:33:02.dbload.log
    #	real    20m26.836s

    # enable daily alignment and update of hgwdev
    cd ~/kent/src/hg/makeDb/genbank
    git pull
    # add melHap1 to:
        etc/align.dbs
        etc/hgwdev.dbs
    git commit -m "Added melHap1 - C. elegans WS210" \
	etc/align.dbs etc/hgwdev.dbs
    git push
    make etc-update

############################################################################
