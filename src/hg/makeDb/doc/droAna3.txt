# for emacs: -*- mode: sh; -*-

# Drosophila ananassae -- Agencourt "CAF1" via Eisen's 12-fly site

# THIS IS ONLY TO GET MASKED SEQUENCE -- NOT A BROWSER AT THIS POINT


#########################################################################
# DOWNLOAD SEQUENCE (DONE 9/20/06 angie)
    ssh kkstore05
    mkdir /cluster/store12/droAna3
    ln -s /cluster/store12/droAna3 /cluster/data/droAna3
    mkdir /cluster/data/droAna3/downloads
    cd /cluster/data/droAna3/downloads
    wget http://rana.lbl.gov/drosophila/caf1/dana_caf1.tar.gz
    tar xvzf dana_caf1.tar.gz
    cd dana
    faSize scaffolds.bases
#230993012 bases (17074195 N's 213918817 real 213918817 upper 0 lower) in 13749 sequences in 1 files
#Total size: mean 16800.7 sd 387178.2 min 55 (scaffold_13714) max 23697760 (scaffold_13340) median 1517
#N count: mean 1241.8 sd 9836.0
#U count: mean 15558.9 sd 382128.9
#L count: mean 0.0 sd 0.0


#########################################################################
# MAKE GENOME DB *UP TO DB STEP ONLY* (DONE 9/20/06 angie)
    ssh kkstore05
    cd /cluster/data/droAna3
    cat > droAna3.config.ra <<EOF
# Config parameters for makeGenomeDb.pl:
db droAna3
clade insect
scientificName Drosophila ananassae
assemblyDate Feb. 2006
assemblyLabel Agencourt CAF1
orderKey 54
mitoAcc none
fastaFiles /cluster/data/droAna3/downloads/dana/scaffolds.bases
agpFiles /cluster/data/droAna3/downloads/dana/assembly.agp
dbDbSpeciesDir drosophila
EOF

    # Stop at db step so we can use featureBits, but don't do dbDb and trackDb
    # because we're not building an actual browser for now.
    makeGenomeDb.pl droAna3.config.ra -stop=db \
      >& makeGenomeDb.log & tail -f makeGenomeDb.log


#########################################################################
# REPEATMASKER (DONE 9/20/06 angie)
    ssh kkstore05
    # Run -debug to create the dir structure and preview the scripts:
    doRepeatMasker.pl droAna3 -verbose 3 -debug
    # Run it for real and tail the log:
    doRepeatMasker.pl droAna3 -species drosophila -verbose 3 \
      >& /cluster/data/droAna3/bed/RepeatMasker.2006-09-20/do.log &
    tail -f /cluster/data/droAna3/bed/RepeatMasker.2006-09-20/do.log
    # RepeatMasker and lib version from do.log:
#    March 20 2006 (open-3-1-5) version of RepeatMasker
#CC   RELEASE 20060315;                                            *
    # Compare coverage to previous assembly:
    featureBits -chrom=scaffold_13340 droAna3 rmsk
#688661 bases of 23471240 (2.934%) in intersection
    featureBits -chrom=scaffold_13340 droAna2 rmsk
#682697 bases of 23466339 (2.909%) in intersection


#########################################################################
# SIMPLE REPEATS (TRF) (DONE 9/20/06 angie)
    ssh kolossus
    nice tcsh
    mkdir /cluster/data/droAna3/bed/simpleRepeat
    cd /cluster/data/droAna3/bed/simpleRepeat
    twoBitToFa ../../droAna3.unmasked.2bit stdout \
    | trfBig -trf=/cluster/bin/i386/trf stdin /dev/null \
      -bedAt=simpleRepeat.bed -tempDir=/tmp \
    >& trf.log & tail -f trf.log
    # ~110 minutes (longer than D. mel, must be because of the scaffolds)

    # Make a filtered version for sequence masking:
    awk '{if ($5 <= 12) print;}' simpleRepeat.bed > trfMask.bed

    # Load unfiltered repeats into the database:
    ssh hgwdev
    hgLoadBed droAna3 simpleRepeat \
      /cluster/data/droAna3/bed/simpleRepeat/simpleRepeat.bed \
      -sqlTable=$HOME/kent/src/hg/lib/simpleRepeat.sql
    # Compare coverage to previous assembly:
    featureBits -chrom=scaffold_13340 droAna3 simpleRepeat
#520511 bases of 23471240 (2.218%) in intersection
    featureBits -chrom=scaffold_13340 droAna2 simpleRepeat
#515863 bases of 23466339 (2.198%) in intersection


#########################################################################
# MASK SEQUENCE WITH FILTERED TRF IN ADDITION TO RM (DONE 9/20/06 angie)
    ssh kolossus
    cd /cluster/data/droAna3
    time twoBitMask droAna3.rmsk.2bit -add bed/simpleRepeat/trfMask.bed droAna3.2bit
    # This warning is OK -- the extra fields are not block coordinates.
#Warning: BED file bed/simpleRepeat/trfMask.bed has >=13 fields which means it might contain block coordinates, but this program uses only the first three fields (the entire span -- no support for blocks).
#0.266u 0.341s 0:02.01 29.8%     0+0k 0+0io 0pf+0w

    # Because this is a no-browser build (just masking for alignment)
    # I did not make the usual /gbdb/$db/$db.2bit link.


