# for emacs: -*- mode: sh; -*-

# Caenorhabditis elegans
# Washington University School of Medicine GSC and Sanger Institute WS220

#########################################################################
# DOWNLOAD SEQUENCE (DONE - 2011-05-23 - Hiram)
    mkdir /hive/data/genomes/ce10
    cd /hive/data/genomes/ce10
    mkdir ws220
    cd ws220
    wget --no-parent --timestamping -m -nH --cut-dirs=5 \
        ftp://ftp.sanger.ac.uk/pub/wormbase/WS220/genomes/c_elegans/
    #	about 11 minutes

    mkdir acedb
    cd acedb
    wget --no-parent --timestamping -m -nH --cut-dirs=4 \
	ftp://ftp.sanger.ac.uk/pub/wormbase/WS220/acedb/
    #	Downloaded: 20 files, 5.9G in 1h 9m 36s (1.45 MB/s)
    #	real    69m49.596s

#########################################################################
# NORMALIZE SEQUENCE NAMES TO BEGIN WITH chr (DONE - 2011-05-23 - Hiram)
    mkdir /hive/data/genomes/ce10/sanger
    cd /hive/data/genomes/ce10/sanger
    # Fix fasta names, this file order leaves chrM last as it will be in
    #	the AGP file for checkAgpAndFa to work correctly:
    zcat ../ws220/sequences/dna/CHR*[XVI].dna.gz \
	../ws220/sequences/dna/CHR*A.dna.gz\
    | sed -e '/^$/ d;  s/^>CHROMOSOME_MtDNA/>chrM/;  s/^>CHROMOSOME_/>chr/;' \
    | gzip -c > UCSC.fa.gz
    faCount UCSC.fa.gz 
#seq    len     A       C       G       T       N       cpg
chrI    15072423        4835938 2695881 2692152 4848452 0       503521
chrII   15279345        4878197 2769219 2762213 4869716 0       492147
chrIII  13783700        4444651 2449148 2466334 4423567 0       459670
chrIV   17493793        5711039 3034770 3017014 5730970 0       522373
chrV    20924149        6750394 3712061 3701398 6760296 0       638983
chrX    17718866        5747199 3119708 3117874 5734085 0       514715
chrM    13794   4335    1225    2055    6179    0       110
total   100286070       32371753        17782012        17759040        323732650       3131519

    # Make sure we get the same sizes from this command:
    zcat ../ws220/sequences/dna/CHR*[XVI].dna.gz \
	../ws220/sequences/dna/CHR*A.dna.gz | faCount stdin
#seq    len     A       C       G       T       N       cpg
CHROMOSOME_I    15072423        4835938 2695881 2692152 4848452 0       503521
CHROMOSOME_II   15279345        4878197 2769219 2762213 4869716 0       492147
CHROMOSOME_III  13783700        4444651 2449148 2466334 4423567 0       459670
CHROMOSOME_IV   17493793        5711039 3034770 3017014 5730970 0       522373
CHROMOSOME_V    20924149        6750394 3712061 3701398 6760296 0       638983
CHROMOSOME_X    17718866        5747199 3119708 3117874 5734085 0       514715
CHROMOSOME_MtDNA        13794   4335    1225    2055    6179    0       110
total   100286070       32371753        17782012        17759040        323732650       3131519

    # Fix AGP names:
    sed -e 's/^/chr/' ../ws220/sequences/dna/CHR*.agp > UCSC.agp
    # And add a fake mitochondrial AGP entry for the sake of downstream
    # tools (make sure the GenBank sequence is identical to given):
    echo -e "chrM\t1\t13794\t1\tF\tNC_001328.1\t1\t13794\t+" >> UCSC.agp

    # avoid problems during makeGenomeDb, verify here:
    checkAgpAndFa UCSC.agp UCSC.fa.gz  | tail -3
    #	FASTA sequence entry
    #	Valid Fasta file entry
    #	All AGP and FASTA entries agree - both files are valid

#########################################################################
# run the makeGenomeDb procedure to create the db and unmasked sequence
#	(DONE - 2011-05-23 - Hiram)
    cd /hive/data/genomes/ce10
    cat << '_EOF_' > ce10.config.ra
# Config parameters for makeGenomeDb.pl:
db ce10
# clade worm
# genomeCladePriority 10
scientificName Caenorhabditis elegans
commonName C. elegans
assemblyDate Oct. 2010
assemblyLabel Washington University School of Medicine GSC and Sanger Institute WS220
assemblyShortLabel WS220
orderKey 822
# mito sequence included in fasta and AGP file
mitoAcc none
fastaFiles /hive/data/genomes/ce10/sanger/UCSC.fa.gz
agpFiles   /hive/data/genomes/ce10/sanger/UCSC.agp
# qualFiles /dev/null
dbDbSpeciesDir worm
taxId 6239
'_EOF_'
    # << emacs

    mkdir jkStuff
    #	run just to AGP to make sure things are sane first
    nice -n +19 makeGenomeDb.pl ce10.config.ra -stop=agp \
      > jkStuff/makeGenomeDb.agp.log 2>&1
    #	check that log to verify it has no errors
    #	now, continuing to make the Db and all
    time nice -n +19 makeGenomeDb.pl ce10.config.ra -continue=db \
      > jkStuff/makeGenomeDb.db.log 2>&1
    #	real    1m9.634s
    #	take the trackDb business there and check it into the source tree
    #	fixup the description, gap and gold html page descriptions

#########################################################################
# REPEATMASKER (DONE - 2011-05-23 - Hiram)
    screen 	#	use screen to control the job
    mkdir /hive/data/genomes/ce10/bed/repeatMasker
    cd /hive/data/genomes/ce10/bed/repeatMasker
    time nice -n +19 doRepeatMasker.pl -noSplit -bigClusterHub=swarm \
	-buildDir=/hive/data/genomes/ce10/bed/repeatMasker ce10 > do.log 2>&1 &
    #	real    31m18.330s

    #	from the do.log:
# RepeatMasker version development-$Id: RepeatMasker,v
#	1.25 2010/09/08 21:32:26 angie Exp $
#	CC   RELEASE 20090604; 

    cat faSize.rmsk.txt
# 100286070 bases (0 N's 100286070 real 87035672 upper 13250398 lower) in 7 sequences in 1 files
# %13.21 masked total, %13.21 masked real

#########################################################################
# SIMPLE REPEATS (DONE - 2011-05-23 - Hiram)
    screen 	#	use screen to control the job
    mkdir /hive/data/genomes/ce10/bed/simpleRepeat
    cd /hive/data/genomes/ce10/bed/simpleRepeat
    time nice -n +19 doSimpleRepeat.pl -smallClusterHub=memk \
	-buildDir=/hive/data/genomes/ce10/bed/simpleRepeat ce10 > do.log 2>&1 &
    #	real    18m13.037s
    cat fb.simpleRepeat 
    #	4331094 bases of 100286070 (4.319%) in intersection

#########################################################################
# Window Masker (DONE - 2011-05-23 - Hiram
    screen 	#	use screen to control the job
    mkdir /hive/data/genomes/ce10/bed/windowMasker
    cd /hive/data/genomes/ce10/bed/windowMasker
    time nice -n +19 doWindowMasker.pl -verbose=2 -buildDir=`pwd` \
	-workhorse=hgwdev ce10 > do.log 2>&1 &
    #	real    2m55.355s
    twoBitToFa ce10.wmsk.sdust.2bit stdout | faSize stdin
# 100286070 bases (0 N's 100286070 real 63460952 upper 36825118 lower)
#	in 7 sequences in 1 files
# %36.72 masked total, %36.72 masked real

#########################################################################
# MASK SEQUENCE WITH RM+TRF (DONE - 2011-05-23 - Hiram)
    # Since both doRepeatMasker.pl and doSimpleRepeats.pl have completed,
    # now it's time to combine the masking into the final ce10.2bit,
    # following the instructions at the end of doSimpleRepeat's output.
    cd /hive/data/genomes/ce10
    twoBitMask ce10.rmsk.2bit -add bed/simpleRepeat/trfMask.bed ce10.2bit
    # You can safely ignore the warning about extra BED columns
    twoBitToFa ce10.2bit stdout | faSize stdin
# 100286070 bases (0 N's 100286070 real 86863818 upper 13422252 lower)
#	in 7 sequences in 1 files
# %13.38 masked total, %13.38 masked real

    #	set the symlink on hgwdev to /gbdb/ce10
    cd /gbdb/ce10
    ln -s /hive/data/genomes/ce10/ce10.2bit .

#########################################################################
# MAKE 11.OOC FILE FOR BLAT (DONE - 2011-05-23 - Hiram)
    # Use -repMatch=100 (based on size -- for human we use 1024, and 
    # worm size is ~3.4% of human judging by gapless ce4 vs. hg18 genome 
    # size from featureBits. So we would use 34, but that yields a very
    # high number of tiles to ignore, especially for a small more compact 
    # genome.  Bump that up a bit to be more conservative.
    cd /hive/data/genomes/ce10
    blat ce10.2bit /dev/null /dev/null -tileSize=11 \
      -makeOoc=jkStuff/ce10.11.ooc -repMatch=100
    #	Wrote 8481 overused 11-mers to jkStuff/11.ooc
    mkdir /hive/data/staging/data/ce10
    cd  /hive/data/genomes/ce10
    cp -p ce10.2bit jkStuff/ce10.11.ooc chrom.sizes /hive/data/staging/data/ce10

    #	request rsync to cluster nodes

#########################################################################
# GENBANK AUTO UPDATE (DONE - 2010-09-09 - Hiram)
    # align with latest genbank process.
    ssh hgwdev
    cd ~/kent/src/hg/makeDb/genbank
    git pull
    # edit etc/genbank.conf to add ce10 just before ce6

# ce10 (C. elegans)
ce10.serverGenome = /hive/data/genomes/ce10/ce10.2bit
ce10.clusterGenome = /scratch/data/ce10/ce10.2bit
ce10.ooc = /scratch/data/ce10/ce10.11.ooc
ce10.refseq.mrna.native.pslCDnaFilter  = ${finished.refseq.mrna.native.pslCDnaFilter}
ce10.refseq.mrna.xeno.pslCDnaFilter    = ${finished.refseq.mrna.xeno.pslCDnaFilter}
ce10.genbank.mrna.native.pslCDnaFilter = ${finished.genbank.mrna.native.pslCDnaFilter}
ce10.genbank.mrna.xeno.pslCDnaFilter   = ${finished.genbank.mrna.xeno.pslCDnaFilter}
ce10.genbank.est.native.pslCDnaFilter  = ${finished.genbank.est.native.pslCDnaFilter}
ce10.maxIntron = 100000
ce10.lift = no
ce10.genbank.mrna.xeno.load = yes
ce10.refseq.mrna.xeno.load = yes
ce10.downloadDir = ce10
# ce10.upstreamGeneTbl = refGene
# ce10.upstreamMaf = multiz6way /hive/data/genomes/ce10/bed/multiz6way/species.lst

    git commit -m "Added ce10 C. elegans WS220" etc/genbank.conf
    git push
    # update /cluster/data/genbank/:
    make etc-update

    screen		#	use a screen to manage this job
    cd /cluster/data/genbank
    time nice -n +19 bin/gbAlignStep -initial ce10 &
    #	logFile:  var/build/logs/2011.05.24-09:14:56.ce10.initalign.log
    #	real    311m56.911s

    # load database when finished
    ssh hgwdev
    cd /cluster/data/genbank
    time nice -n +19 ./bin/gbDbLoadStep -drop -initialLoad ce10
    #	logFile: var/dbload/hgwdev/logs/2011.05.24-14:29:17.dbload.log
    #	real    24m52.293s

    # enable daily alignment and update of hgwdev
    cd ~/kent/src/hg/makeDb/genbank
    git pull
    # add ce10 to:
        etc/align.dbs
        etc/hgwdev.dbs
    git commit -m "Added ce10 - C. elegans WS220" \
	etc/align.dbs etc/hgwdev.dbs
    git push
    make etc-update

###############################################################################
# reset default position, same as ce4/ce6/ce9 on the ZC101 / unc-52 locus
#	(DONE - 2011-05-24 - Hiram)
    ssh hgwdev
    hgsql -e 'update dbDb set defaultPos="chrII:14646301-14667800"
	where name="ce10";' hgcentraltest

############################################################################
# set this as the defaultDb (DONE - 2011-05-24 - Hiram)
    hgsql -e 'update defaultDb set name="ce10" where name="ce9";' \
	hgcentraltest

##########################################################################
