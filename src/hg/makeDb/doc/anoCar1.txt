# for emacs: -*- mode: sh; -*-

# Anolis carolinensis - Broad Institute 1.0

#########################################################################
# DOWNLOAD SEQUENCE (DONE - 2007-02-16 - Hiram)
    ssh kkstore05
    mkdir /cluster/store12/anoCar1
    ln -s /cluster/store12/anoCar1 /cluster/data/anoCar1
    mkdir /cluster/data/anoCar1/downloads
    cd /cluster/data/anoCar1/downloads
    foreach f (assembly.agp \
               BasicAssemblyOneLiner.out \
               ForDistribution.command \
               assembly.bases.gz \
               assembly.links \
               assembly.quals.gz \
               source)
      wget --timestamping \
        ftp://ftp.broad.mit.edu/pub/assemblies/reptiles/lizard/AnoCar1.0/$f
    end
    faSize assembly.bases.gz 
# 1741478929 bases (0 N's 1741478929 real 1741478929 upper 0 lower)
#	in 50470 sequences in 1 files
    #	Discovered later that this quals file needs to be lifted
    qaToQac assembly.quals.gz stdout \
	| qacAgpLift assembly.agp stdin scaffold.lifted.qac

    ##	Calculate N50
    #	Find total length in sequence
    sort -k2nr chrom.sizes | awk '{sum+=$2;print NR,sum,$2,$1}' | tail -1
    #	7233 1781602899 340 scaffold_7232
    #	half of 1781602899 is 890801449
    #	run this again, scanning the list until the sum reaches 890801449
    sort -k2nr chrom.sizes | awk '{sum+=$2;print NR,sum,$2,$1}' | less
    #	204 889215106 2440512 scaffold_201
    #	205 891654231 2439125 scaffold_205

#########################################################################
## Create .ra file and run makeGenomeDb.pl
    ssh hgwdev
    cd /cluster/data/anoCar1
    cat << '_EOF_' >anoCar1.config.ra
# Config parameters for makeGenomeDb.pl:
db anoCar1
clade vertebrate
genomeCladePriority 66
scientificName Anolis carolinensis
commonName Lizard
assemblyDate Jan. 2007
assemblyLabel Broad Institute AnoCar (1.0)
orderKey 375
mitoAcc none
fastaFiles /cluster/data/anoCar1/downloads/assembly.bases.gz
agpFiles /cluster/data/anoCar1/downloads/assembly.agp
qualFiles /cluster/data/anoCar1/downloads/scaffold.lifted.qac
dbDbSpeciesDir lizard
'_EOF_'

    time makeGenomeDb.pl -verbose=2 anoCar1.config.ra > makeGenomeDb.out 2>&1
    #	broken down during the quals step since assembly.quals.gz needed
    #	to be lifted.  do the qaToQac | qacAgpLift sequence, fixup the
    #	specification above for qualFiles, and finish off the quals loading:
    ssh kkstore05
    cd /cluster/data/anoCar1/bed/qual
    qacToWig -fixed ../../downloads/scaffold.lifted.qac stdout \
	| wigEncode stdin qual.wig qual.wib
    ssh hgwdev
    cd /cluster/data/anoCar1/bed/qual
    time nice -n +19 hgLoadWiggle \
	-pathPrefix=/gbdb/anoCar1/wib anoCar1 quality qual.wig

    ##	continue
    ssh hgwdev
    cd /cluster/data/anoCar1
    time makeGenomeDb.pl -verbose=2 -continue=dbDb anoCar1.config.ra \
	> makeDbDb.out 2>&1

##########################################################################
## Photograph - permission to use obtained from R. Steven Rainwater
##		(DONE - 2007-02-16 - Hiram)
    ## Fetch photo from:
    wget --timestamping \
	"http://rainwaterreptileranch.org/steve/photos/herps/anole2.jpeg" \
	-O R.Steven.Rainwater.Anole.Lizard.jpg
    convert -quality 80 -sharpen 0 -crop "168x272+264+37" \
	R.Steven.Rainwater.Anole.Lizard.jpg Anolis_carolinensis.jpg

################################################
## WINDOWMASKER (Working - 2007-02-16 - Hiram)
    ssh kkstore05
    cd /cluster/data/anoCar1/bed/
    time nice -n +19 ~/kent/src/hg/utils/automation/doWindowMasker.pl anoCar1 \
      -workhorse=kolossus > wmRun.log 2>&1 &
    #	real    172m58.813s

    # Save the log
    mv wmRun.log WindowMasker.2007-02-16

    # Masking statistics
    cd WindowMasker.2007-02-18
    twoBitToFa anoCar1.wmsk.2bit stdout | faSize stdin
    #	1781602899 bases (40123970 N's 1741478929 real
    #	1009685313 upper 731793616 lower) in 7233 sequences in 1 files
    twoBitToFa anoCar1.wmsk.sdust.2bit stdout | faSize stdin
    #	1781602899 bases (40123970 N's 1741478929 real
    #	1000477327 upper 741001602 lower) in 7233 sequences in 1 files

    ssh hgwdev
    hgLoadBed -strict anoCar1 windowmaskerSdust windowmasker.sdust.bed.gz
    #	Loaded 8354004 elements of size 3

    #	why does featureBits show more bases masked than what faSize
    #	measured as lower case ?  Because this counts the masked sequence
    #	in the gaps, and the faSize doesn't have the gaps.
    time nice -n +19 featureBits anoCar1 windowmaskerSdust
    #	781125572 bases of 1741478929 (44.854%) in intersection

    time nice -n +19 featureBits -countGaps anoCar1 windowmaskerSdust
    #	781125572 bases of 1781602899 (43.844%) in intersection

    #	Curiously, WM overlaps gaps ?
    time nice -n +19 featureBits -countGaps anoCar1 windowmaskerSdust gap
    #	40123970 bases of 1781602899 (2.252%) in intersection
    #	741001602 + 40123970 == 781125572 

#########################################################################
# SIMPLE REPEATS (TRF) (DONE 2007-02-16 - Hiram)
    ssh kolossus
    mkdir /cluster/data/anoCar1/bed/simpleRepeat
    cd /cluster/data/anoCar1/bed/simpleRepeat
    time nice -n 19 twoBitToFa ../../anoCar1.unmasked.2bit stdout \
	| trfBig -trf=/cluster/bin/i386/trf stdin /dev/null \
	    -bedAt=simpleRepeat.bed -tempDir=/tmp > trf.log 2>&1 &
    #	real    164m34.988s
    #	user    159m32.859s
    #	sys     4m31.649s

    ssh kkstore05
    cd /cluster/data/anoCar1/bed/simpleRepeat
    # Make a filtered version for sequence masking:
    awk '{if ($5 <= 12) print;}' simpleRepeat.bed > trfMask.bed
    splitFileByColumn trfMask.bed trfMaskChrom

    # Load unfiltered repeats into the database:
    ssh hgwdev
    nice -n +19 hgLoadBed anoCar1 simpleRepeat \
      /cluster/data/anoCar1/bed/simpleRepeat/simpleRepeat.bed \
      -sqlTable=$HOME/kent/src/hg/lib/simpleRepeat.sql
    #	Loaded 569322 elements of size 16
    nice -n +19 featureBits anoCar1 simpleRepeat
    #	50290171 bases of 1741478929 (2.888%) in intersection

#########################################################################
## Add TRF mask to WindowMasker masked sequence, and fixup the bogus
##	window masked N's  (DONE - 2007-02-17 - Hiram)
    ssh kkstore05
    cd /cluster/data/anoCar1/bed/WindowMasker.2007-02-16
    ##	Curious, twoBitMask would not accept stdout for its output 2bit
    twoBitMask anoCar1.wmsk.sdust.2bit \
      -add ../simpleRepeat/trfMask.bed tmp.2bit
    twoBitToFa tmp.2bit stdout \
	| sed -e "s/n/N/g" | faToTwoBit stdin anoCar1.2bit
    ## check it:
    twoBitToFa anoCar1.2bit stdout | faSize stdin
    #	1781602899 bases (40123970 N's 1741478929 real
    #	1000242640 upper 741236289 lower) in 7233 sequences in 1 files
    ## trfMask contributes:
    awk '{sum+=$3-$2} END{print sum}' ../simpleRepeat/trfMask.bed
    #	16534332
    ## and we measured wmsk.sdust before: 741001602
    16534332 + 741001602

#########################################################################
## BLASTZ Hg18
    time doBlastzChainNet.pl DEF -chainMinScore=2000 -chainLinearGap=loose \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-verbose=2 -bigClusterHub=pk \
	-blastzOutRoot /cluster/bluearc/hg18Fr2 > do.log 2>&1 &
    #	real    414m47.505s

