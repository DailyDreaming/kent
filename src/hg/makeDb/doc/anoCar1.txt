# for emacs: -*- mode: sh; -*-

# Anolis carolinensis - Broad Institute 1.0

#########################################################################
# DOWNLOAD SEQUENCE (DONE - 2007-02-16 - Hiram)
    ssh kkstore05
    mkdir /cluster/store12/anoCar1
    ln -s /cluster/store12/anoCar1 /cluster/data/anoCar1
    mkdir /cluster/data/anoCar1/downloads
    cd /cluster/data/anoCar1/downloads
    foreach f (assembly.agp \
               BasicAssemblyOneLiner.out \
               ForDistribution.command \
               assembly.bases.gz \
               assembly.links \
               assembly.quals.gz \
               source)
      wget --timestamping \
        ftp://ftp.broad.mit.edu/pub/assemblies/reptiles/lizard/AnoCar1.0/$f
    end
    faSize assembly.bases.gz 
# 1741478929 bases (0 N's 1741478929 real 1741478929 upper 0 lower)
#	in 50470 sequences in 1 files
    #	Discovered later that this quals file needs to be lifted
    qaToQac assembly.quals.gz stdout \
	| qacAgpLift assembly.agp stdin scaffold.lifted.qac

    ##	Calculate N50
    #	Find total length in sequence
    sort -k2nr chrom.sizes | awk '{sum+=$2;print NR,sum,$2,$1}' | tail -1
    #	7233 1781602899 340 scaffold_7232
    #	half of 1781602899 is 890801449
    #	run this again, scanning the list until the sum reaches 890801449
    sort -k2nr chrom.sizes | awk '{sum+=$2;print NR,sum,$2,$1}' | less
    #	204 889215106 2440512 scaffold_201
    #	205 891654231 2439125 scaffold_205

#########################################################################
## Create .ra file and run makeGenomeDb.pl
    ssh hgwdev
    cd /cluster/data/anoCar1
    cat << '_EOF_' >anoCar1.config.ra
# Config parameters for makeGenomeDb.pl:
db anoCar1
clade vertebrate
genomeCladePriority 66
scientificName Anolis carolinensis
commonName Lizard
assemblyDate Jan. 2007
assemblyLabel Broad Institute AnoCar (1.0)
orderKey 440
mitoAcc none
fastaFiles /cluster/data/anoCar1/downloads/assembly.bases.gz
agpFiles /cluster/data/anoCar1/downloads/assembly.agp
qualFiles /cluster/data/anoCar1/downloads/scaffold.lifted.qac
dbDbSpeciesDir lizard
'_EOF_'

    time makeGenomeDb.pl -verbose=2 anoCar1.config.ra > makeGenomeDb.out 2>&1
    #	broken down during the quals step since assembly.quals.gz needed
    #	to be lifted.  do the qaToQac | qacAgpLift sequence, fixup the
    #	specification above for qualFiles, and finish off the quals loading:
    ssh kkstore05
    cd /cluster/data/anoCar1/bed/qual
    qacToWig -fixed ../../downloads/scaffold.lifted.qac stdout \
	| wigEncode stdin qual.wig qual.wib
    ssh hgwdev
    cd /cluster/data/anoCar1/bed/qual
    time nice -n +19 hgLoadWiggle \
	-pathPrefix=/gbdb/anoCar1/wib anoCar1 quality qual.wig

    ##	continue
    ssh hgwdev
    cd /cluster/data/anoCar1
    time makeGenomeDb.pl -verbose=2 -continue=dbDb anoCar1.config.ra \
	> makeDbDb.out 2>&1

    ## better orderKey to get Lizard between frog and fish
    hgsql -e 'update dbDb set orderKey="440" where name="anoCar1";' \
	hgcentraltest
    ## fixup that number in the .ra file as mentioned above, was 375
##########################################################################
## Photograph - permission to use obtained from R. Steven Rainwater
##		(DONE - 2007-02-16 - Hiram)
    ## Fetch photo from:
    wget --timestamping \
	"http://rainwaterreptileranch.org/steve/photos/herps/anole2.jpeg" \
	-O R.Steven.Rainwater.Anole.Lizard.jpg
    convert -quality 80 -sharpen 0 -crop "168x272+264+37" \
	R.Steven.Rainwater.Anole.Lizard.jpg Anolis_carolinensis.jpg

################################################
## WINDOWMASKER (Working - 2007-02-16 - Hiram)
    ssh kkstore05
    cd /cluster/data/anoCar1/bed/
    time nice -n +19 ~/kent/src/hg/utils/automation/doWindowMasker.pl anoCar1 \
      -workhorse=kolossus > wmRun.log 2>&1 &
    #	real    172m58.813s

    # Save the log
    mv wmRun.log WindowMasker.2007-02-16

    # Masking statistics
    cd WindowMasker.2007-02-18
    twoBitToFa anoCar1.wmsk.2bit stdout | faSize stdin
    #	1781602899 bases (40123970 N's 1741478929 real
    #	1009685313 upper 731793616 lower) in 7233 sequences in 1 files
    twoBitToFa anoCar1.wmsk.sdust.2bit stdout | faSize stdin
    #	1781602899 bases (40123970 N's 1741478929 real
    #	1000477327 upper 741001602 lower) in 7233 sequences in 1 files

    ssh hgwdev
    hgLoadBed -strict anoCar1 windowmaskerSdust windowmasker.sdust.bed.gz
    #	Loaded 8354004 elements of size 3

    #	why does featureBits show more bases masked than what faSize
    #	measured as lower case ?  Because this counts the masked sequence
    #	in the gaps, and the faSize doesn't have the gaps.
    time nice -n +19 featureBits anoCar1 windowmaskerSdust
    #	781125572 bases of 1741478929 (44.854%) in intersection

    time nice -n +19 featureBits -countGaps anoCar1 windowmaskerSdust
    #	781125572 bases of 1781602899 (43.844%) in intersection

    #	Curiously, WM overlaps gaps ?
    time nice -n +19 featureBits -countGaps anoCar1 windowmaskerSdust gap
    #	40123970 bases of 1781602899 (2.252%) in intersection
    #	741001602 + 40123970 == 781125572 

#########################################################################
# SIMPLE REPEATS (TRF) (DONE 2007-02-16 - Hiram)
    ssh kolossus
    mkdir /cluster/data/anoCar1/bed/simpleRepeat
    cd /cluster/data/anoCar1/bed/simpleRepeat
    time nice -n 19 twoBitToFa ../../anoCar1.unmasked.2bit stdout \
	| trfBig -trf=/cluster/bin/i386/trf stdin /dev/null \
	    -bedAt=simpleRepeat.bed -tempDir=/tmp > trf.log 2>&1 &
    #	real    164m34.988s
    #	user    159m32.859s
    #	sys     4m31.649s

    ssh kkstore05
    cd /cluster/data/anoCar1/bed/simpleRepeat
    # Make a filtered version for sequence masking:
    awk '{if ($5 <= 12) print;}' simpleRepeat.bed > trfMask.bed
    splitFileByColumn trfMask.bed trfMaskChrom

    # Load unfiltered repeats into the database:
    ssh hgwdev
    nice -n +19 hgLoadBed anoCar1 simpleRepeat \
      /cluster/data/anoCar1/bed/simpleRepeat/simpleRepeat.bed \
      -sqlTable=$HOME/kent/src/hg/lib/simpleRepeat.sql
    #	Loaded 569322 elements of size 16
    nice -n +19 featureBits anoCar1 simpleRepeat
    #	50290171 bases of 1741478929 (2.888%) in intersection

#########################################################################
## Add TRF mask to WindowMasker masked sequence, and fixup the bogus
##	window masked N's  (DONE - 2007-02-17 - Hiram)
    ssh kkstore05
    cd /cluster/data/anoCar1/bed/WindowMasker.2007-02-16
    ##	Curious, twoBitMask would not accept stdout for its output 2bit
    twoBitMask anoCar1.wmsk.sdust.2bit \
      -add ../simpleRepeat/trfMask.bed tmp.2bit
    twoBitToFa tmp.2bit stdout \
	| sed -e "s/n/N/g" | faToTwoBit stdin anoCar1.2bit
    ## check it:
    twoBitToFa anoCar1.2bit stdout | faSize stdin
    #	1781602899 bases (40123970 N's 1741478929 real
    #	1000242640 upper 741236289 lower) in 7233 sequences in 1 files
    ## trfMask contributes:
    awk '{sum+=$3-$2} END{print sum}' ../simpleRepeat/trfMask.bed
    #	16534332
    ## and we measured wmsk.sdust before: 741001602
    16534332 + 741001602

#########################################################################
## BLASTZ Hg18 swap (DONE - 2007-02-18 - Hiram)
    ##	the original blastz to hg18 measured
    time nice -n +19 featureBits hg18 chainAnoCar1Link \
	> fb.hg18.chainAnoCar1Link.txt 2>&1
    #	real    2m28.318s
    #	137554843 bases of 2881515245 (4.774%) in intersection

    ssh kkstore05
    mkdir /cluster/data/anoCar1/bed/blastz.hg18.swap
    cd /cluster/data/anoCar1/bed/blastz.hg18.swap
    time doBlastzChainNet.pl \
	/cluster/data/hg18/bed/blastz.anoCar1.2007-02-17/DEF \
	-chainMinScore=5000 -chainLinearGap=loose \
	-tRepeats=windowmaskerSdust -qRepeats=windowmaskerSdust \
	-verbose=2 -bigClusterHub=pk -swap > swap.log 2>&1 &

    time nice -n +19 featureBits anoCar1 chainHg18Link \
	> fb.anoCar1.chainHg18Link.txt 2>&1  
    #	real    3m16.810s
    #	112434396 bases of 1741478929 (6.456%) in intersection

#########################################################################
# GENSCAN PREDICTIONS (DONE - 2006-05-03 - 2006-05-05 - Hiram)
    ssh kkstore05
    #	Create a 2bit file all hard masked
    cd /cluster/data/anoCar1
    time nice -n +10 twoBitToFa anoCar1.2bit stdout \
	| maskOutFa stdin hard stdout \
	    | faToTwoBit stdin anoCar1.hard.2bit
    #	make sure it still has all the unmasked sequence in it:
    nice -n +19 twoBitToFa anoCar1.hard.2bit stdout | faSize stdin
    #	1781602899 bases (781360259 N's 1000242640 real
    #	1000242640 upper 0 lower) in 7233 sequences in 1 files

    nice -n +19 twoBitToFa anoCar1.2bit stdout | faSize stdin
    #	1781602899 bases (40123970 N's 1741478929 real
    #	1000242640 upper 741236289 lower) in 7233 sequences in 1 files
    #	same number of total bases, the lowers have become Ns:
    #	781360259 == 741236289 + 40123970
    #	the lower "reals" disappear from the "real" count:
    #	1000242640 == 1741478929 - 741236289

    #	And, make sure there aren't any sequences in this lot that have
    #	become all N's with no sequence left in them:
    twoBitToFa anoCar1.hard.2bit stdout \
	| faCount stdin > anoCar1.hard.faCount
    #	181 scaffolds end up with less than 100 bases of sequence left
    egrep -v "^#|^total" anoCar1.hard.faCount | awk '{print $1,$2-$7}' \
	| sort -k2nr | awk '{if ($2 < 100) { print }}' | wc -l
    #	181
    #	leaving 7.052 scaffolds with more than 100 bases of seqence left:
    egrep -v "^#|^total" anoCar1.hard.faCount | awk '{print $1,$2-$7}' \
	| sort -k2nr | awk '{if ($2 >= 100) { print }}' | wc -l
    #	7052
    #	make a list of those to extract their sequence:
    egrep -v "^#|^total" anoCar1.hard.faCount | awk '{print $1,$2-$7}' \
	| sort -k2nr | awk '{if ($2 >= 100) { print $1 }}' \
	| sort > hard.genscan.list

    twoBitToFa -seqList=hard.genscan.list anoCar1.hard.2bit genscan.hard.fa
    #	What do we have left to work with:
    faSize genscan.hard.fa
    #	1780575355 bases (780338843 N's 1000236512 real
    #	1000236512 upper 0 lower) in 7052 sequences in 1 files


    #	creating 4,000,000 sized chunks, the largest scaffolds remain
    #	in single pieces, the scaffolds smaller than 4,000,000 are grouped
    #	into 4,000,000 sized fasta files.  You don't want to break these
    #	things up because genscan will be doing its own internal 2.4 million
    #	window on these pieces, and the gene names are going to be
    #	constructed from the sequence name in these fasta files.  The
    #	gene names are much better when they are this simple scaffoldN.M
    #	numbering scheme.
    mkdir genscanSplit
    faSplit about genscan.hard.fa 4000000 genscanSplit/c_

    ssh hgwdev
    mkdir /cluster/data/anoCar1/bed/genscan
    cd /cluster/data/anoCar1/bed/genscan
    # Check out hg3rdParty/genscanlinux to get latest genscan:
    cvs co hg3rdParty/genscanlinux

    # Run on small cluster (more mem than big cluster).
    ssh kki
    cd /cluster/data/anoCar1/bed/genscan
    # Make 3 subdirectories for genscan to put their output files in
    mkdir gtf pep subopt
    # Generate a list file, genome.list, of all the hard-masked contigs that 
    # *do not* consist of all-N's (which would cause genscan to blow up)
    #	Since we split on gaps, we have no chunks like that.  You can
    #	verify with faCount on the chunks.
    ls -1S /cluster/data/anoCar1/genscanSplit/c_*.fa > chunk.list

    # Create template file, gsub, for gensub2.  For example (3-line file):
    cat << '_EOF_' > template
#LOOP
/cluster/bin/x86_64/gsBig {check in line+ $(path1)} {check out line gtf/$(root1).gtf} -trans={check out line pep/$(root1).pep} -subopt={check out line subopt/$(root1).bed} -exe=hg3rdParty/genscanlinux/genscan -par=hg3rdParty/genscanlinux/HumanIso.smat -tmp=/scratch/tmp -window=2400000
#ENDLOOP
'_EOF_'
    # << happy emacs
    gensub2 chunk.list single template jobList
    para create jobList
    para try, check, push, check, ...
# Completed: 319 of 319 jobs
# CPU time in finished jobs:      39037s     650.62m    10.84h    0.45d  0.001 y
# IO & Wait Time:                  1015s      16.91m     0.28h    0.01d  0.000 y
# Average job time:                 126s       2.09m     0.03h    0.00d
# Longest finished job:             459s       7.65m     0.13h    0.01d
# Submission to last job:          3495s      58.25m     0.97h    0.04d

    # cat results into single files
    ssh kkstore05
    cd /cluster/data/anoCar1/bed/genscan
    cat gtf/c_*.gtf > genscan.gtf
    cat subopt/c_*.bed > genscanSubopt.bed
    cat pep/c_*.pep > genscan.pep

    # Load into the database as so:
    ssh hgwdev
    cd /cluster/data/anoCar1/bed/genscan
    ldHgGene anoCar1 -gtf genscan genscan.gtf
    #	Read 28102 transcripts in 184045 lines in 1 files
    #	28102 groups 4190 seqs 1 sources 1 feature types
    #	28102 gene predictions

    hgPepPred anoCar1 generic genscanPep genscan.pep
    hgLoadBed -strict anoCar1 genscanSubopt genscanSubopt.bed
    #	Loaded 286327 elements of size 6

    #	check the numbers
    time nice -n +19 featureBits anoCar1 genscan
    #	31394034 bases of 1741478929 (1.803%) in intersection

###########################################################################
# HUMAN (hg18) PROTEINS TRACK (DONE braney 2007-02-19)
    ssh kkstore05
    bash # if not using bash shell already

    mkdir /cluster/data/anoCar1/blastDb
    cd /cluster/data/anoCar1
    twoBitToFa anoCar1.unmasked.2bit temp.fa
    faSplit sequence temp.fa 500 blastDb/
    rm temp.fa
    cd blastDb
    for i in *.fa
    do
	/cluster/bluearc/blast229/formatdb -i $i -p F
    done
    rm *.fa

    mkdir -p /san/sanvol1/scratch/anoCar1/blastDb
    cd /cluster/data/anoCar1/blastDb
    for i in nhr nin nsq; 
    do 
	echo $i
	cp *.$i /san/sanvol1/scratch/anoCar1/blastDb
    done

    mkdir -p /cluster/data/anoCar1/bed/tblastn.hg18KG
    cd /cluster/data/anoCar1/bed/tblastn.hg18KG
    echo  /san/sanvol1/scratch/anoCar1/blastDb/*.nsq | xargs ls -S | sed "s/\.nsq//"  > query.lst
    wc -l query.lst
# 496 query.lst

   # we want around 200000 jobs
   calc `wc /cluster/data/hg18/bed/blat.hg18KG/hg18KG.psl | awk "{print \\\$1}"`/\(200000/`wc query.lst | awk "{print \\\$1}"`\)
# 36727/(200000/496) = 91.082960

   mkdir -p /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/kgfa
   split -l 90 /cluster/data/hg18/bed/blat.hg18KG/hg18KG.psl  /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/kgfa/kg
   ln -s /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/kgfa kgfa
   cd kgfa
   for i in *; do 
     nice pslxToFa $i $i.fa; 
     rm $i; 
     done
   cd ..
   ls -1S kgfa/*.fa > kg.lst
   mkdir -p /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/blastOut
   ln -s /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/blastOut
   for i in `cat kg.lst`; do  mkdir blastOut/`basename $i .fa`; done
   tcsh
   cd /cluster/data/anoCar1/bed/tblastn.hg18KG
   cat << '_EOF_' > blastGsub
#LOOP
blastSome $(path1) {check in line $(path2)} {check out exists blastOut/$(root2)/q.$(root1).psl }
#ENDLOOP
'_EOF_'

   cat << '_EOF_' > blastSome
#!/bin/sh
BLASTMAT=/cluster/bluearc/blast229/data
export BLASTMAT
g=`basename $2`
f=/tmp/`basename $3`.$g
for eVal in 0.01 0.001 0.0001 0.00001 0.000001 1E-09 1E-11
do
if /cluster/bluearc/blast229/blastall -M BLOSUM80 -m 0 -F no -e $eVal -p tblastn -d $1 -i $2 -o $f.8
then
        mv $f.8 $f.1
        break;
fi
done
if test -f  $f.1
then
    if /cluster/bin/i386/blastToPsl $f.1 $f.2
    then
        liftUp -nosort -type=".psl" -pslQ -nohead $3.tmp /cluster/data/hg18/bed/blat.hg18KG/protein.lft warn $f.2

        if pslCheck -prot $3.tmp                                                  
        then                                                                      
            mv $3.tmp $3                                                          
            rm -f $f.1 $f.2 $f.3 $f.4
        fi
        exit 0                                                                    
    fi                                                                            
fi                                                                                
rm -f $f.1 $f.2 $3.tmp $f.8 $f.3 $f.4
exit 1
'_EOF_'
    # << happy emacs
    chmod +x blastSome
    gensub2 query.lst kg.lst blastGsub blastSpec
    # back to bash
    exit 
    
    ssh pk
    cd /cluster/data/anoCar1/bed/tblastn.hg18KG
    para create blastSpec
#    para try, check, push, check etc.

    para time

# Completed: 202864 of 202864 jobs
# CPU time in finished jobs:   14747966s  245799.43m  4096.66h  170.69d  0.468 y
# IO & Wait Time:               1561940s   26032.34m   433.87h   18.08d  0.050 y
# Average job time:                  80s       1.34m     0.02h    0.00d
# Longest finished job:             722s      12.03m     0.20h    0.01d
# Submission to last job:         93277s    1554.62m    25.91h    1.08d

    ssh kkstore05
    cd /cluster/data/anoCar1/bed/tblastn.hg18KG
    mkdir chainRun
    cd chainRun
    tcsh
    cat << '_EOF_' > chainGsub
#LOOP
chainOne $(path1)
#ENDLOOP
'_EOF_'

    cat << '_EOF_' > chainOne
(cd $1; cat q.*.psl | simpleChain -prot -outPsl -maxGap=150000 stdin /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/blastOut/c.`basename $1`.psl)
'_EOF_'
    exit
    chmod +x chainOne
    ls -1dS /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/blastOut/kg?? > chain.lst
    gensub2 chain.lst single chainGsub chainSpec
    # do the cluster run for chaining
    ssh kk
    cd /cluster/data/anoCar1/bed/tblastn.hg18KG/chainRun
    para create chainSpec
    para maxNode 30
    para try, check, push, check etc.
# Completed: 409 of 409 jobs
# CPU time in finished jobs:       2911s      48.52m     0.81h    0.03d  0.000 y
# IO & Wait Time:                 65231s    1087.18m    18.12h    0.75d  0.002 y
# Average job time:                 167s       2.78m     0.05h    0.00d
# Longest finished job:             287s       4.78m     0.08h    0.00d
# Submission to last job:          2318s      38.63m     0.64h    0.03d

    ssh kkstore05
    cd /cluster/data/anoCar1/bed/tblastn.hg18KG/blastOut
    for i in kg??
    do
       cat c.$i.psl | awk "(\$13 - \$12)/\$11 > 0.6 {print}" > c60.$i.psl
       sort -rn c60.$i.psl | pslUniq stdin u.$i.psl
       awk "((\$1 / \$11) ) > 0.60 { print   }" c60.$i.psl > m60.$i.psl
       echo $i
    done
    sort -T /tmp -k 14,14 -k 16,16n -k 17,17n u.*.psl m60* | uniq > /cluster/data/anoCar1/bed/tblastn.hg18KG/blastHg18KG.psl
    cd ..
    pslCheck blastHg18KG.psl

    # load table 
    ssh hgwdev
    cd /cluster/data/anoCar1/bed/tblastn.hg18KG
    hgLoadPsl anoCar1 blastHg18KG.psl
    # check coverage
    featureBits anoCar1 blastHg18KG 
# 21571582 bases of 1741478929 (1.239%) in intersection
    
    ssh kkstore05
    rm -rf /cluster/data/anoCar1/bed/tblastn.hg18KG/blastOut
    rm -rf /cluster/bluearc/anoCar1/bed/tblastn.hg18KG/blastOut
#end tblastn
