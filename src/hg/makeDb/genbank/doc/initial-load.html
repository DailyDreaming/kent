<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2//EN">

<HTML>
  <HEAD>
    <META name="generator" content=
    "HTML Tidy for Linux/x86 (vers 1st June 2002), see www.w3.org">

    <TITLE>GenBank/RefSeq Genome Setup</TITLE>
  </HEAD>

  <BODY bgcolor="white">
    <H1>GenBank/RefSeq Genome Setup</H1>
    The page describes that process of setting up the GenBank/RefSeq update
    process for a new genome or new assembly. It's assumed that the
    automated download and build already in place and in <CODE>$gbRoot</CODE>.

    <H3>Initial Alignment</H3>
    Building the initial alignments is a long process, involving gigabytes
    of disk space and over a day of cluster time.  Do not be surprised if
    it does not go smoothly.  Manual intervention maybe required to
    correct problems.

    <OL>
      <LI> Make sure <CODE>ssh</CODE> is configure to
           <A HREF="ssh.html">not require a passphase</A>.
      <LI> In this document, <CODE>$db</CODE> refers to the database being aligned.
           Substitute the actual database name (e.g. <CODE>hg15</CODE>).
      <LI> If this is the first time this organism has been aligned:
      <UL>
      <LI> A mapping between the prefix used in the UCSC databases names
           (e.g. <CODE>hg</CODE> of <CODE>hg13</CODE>) and the species names
           used in GenBank needs to be defined.  This is done by editing
           <CODE>lib/gbGenome.c</CODE> and rebuilding the programs.  It maybe
           necessary to define multiple species name mappings.  The list of 
           species used by GenBank can be obtained by using a command in the form:<BR>
           <PRE>
           awk 'BEGIN{FS=&quot;\t&quot;}{print $4}' processed/genbank.135.0/full/*.gbidx |sort -u &gt;species.txt
           </PRE>
           on the latest GenBank release. 
      <LI> Edit <CODE>align/gbBlat</CODE> to add the <EM><CODE>ooc</CODE></EM> file.
           If there is no <EM><CODE>ooc</CODE></EM>, this script still needs to be
           modified to indicate this fact.
      </UL>
      <LI> Edit <A HREF="config.html"><CODE><EM>$gbRoot</EM>/etc/genbank.conf</CODE></A> to 
           configure this databases.  Must set:
           <UL>
           <LI> <CODE>$db.genome</CODE>
           <LI> <CODE>$db.lift</CODE>
           </UL>
           You may want to set some database load options to override the defaults.
           
      <LI><CODE>ssh eieio</CODE><BR>
          <EM>It is important to run on <CODE>eieio</CODE> to avoid creating
             a heavy NFS load</EM> .

      <LI><CODE>cd /cluster/store5/genbank</CODE><BR>
          This directory is <CODE>$gbRoot</CODE>.

      <LI> <CODE>nice bin/gbAlignStep -verbose=1 -initial <EM>$db</EM>&</CODE><BR>
           <P>This will run the entire alignment process.
           The <CODE>-initial</CODE> option defaults several parameters for
           and initial alignment and prevents this alignment from blocking
           the automatic daily alignments.  In particular:
           <UL>
           <LI> Temporary working directory is <CODE>work/initial.$db/align</CODE>.
           <LI> Log file will be in the form <CODE>var/initial/2003.05.23-21:51:12.$db.align.log</CODE>.
           <LI> No semaphore files are created, so this doesn't block the
                daily build.
           </UL>
           <P>
           If you want to use the <EM>bluearc</EM> cluster file system, add
           <UL>
           <LI><CODE>-iserver=no -clusterRootDir=/cluster/bluearc/genbank</CODE> 
           </UL>
           before the <CODE><EM>$db</EM></CODE>.
           <BLOCKQUOTE>
           Warning: <CODE>gbAlignStep</CODE> and other GenBank do not currently accept options after
           the positional arguments.
           </BLOCKQUOTE>

           <P>If you use the <EM>iservers</EM>, <A HREF="config.html"><CODE><EM>$gbRoot</EM>/etc/genbank.conf</CODE></A>
           should already have the list of working servers. 
           <P>
           All output is saved in the log file.
           <P> If this is the first time a databases is built for an organism,
               it's a good idea to start out by aligning and loading just the
               the mRNAs, as this will go much faster.  Two options control
               what is aligned:
               <UL>
               <LI> <CODE>-srcDb=<EM>name</EM></CODE> - Restrict the source
                  database to either <CODE>genbank</CODE> or <CODE>refseq</CODE>.
               <LI> <CODE>-type=<EM>name</EM></CODE> - Restrict the type of sequence
                  processeed to either <CODE>mrna</CODE> or <CODE>est</CODE>.
               </UL>
               Note that since the alignment processs only aligns what neededs
               to be aligned, no option is required when doing the ESTs after
               an initial mRNA alignment.

          <P> If anything fails, a subset of the trasks done by
              <CODE>gbAlignStep</CODE> script can be rerun after correcting
              the problem.  This is done using the
              <CODE>-continue=<EM>subtask</EM></CODE> option with
              <CODE><EM>subtask</EM></CODE> is either
              <UL>
              <LI><CODE>copy</CODE> - continue with coping to the iserver,
              this skips extracting the sequences to align.
              <LI><CODE>run</CODE> - Continue with parasol blat run.
              <LI><CODE>finish</CODE> - finish, alignments, doing
              lifting and filtering.
              </UL>

              If the parasol alignment run fails,  then can be
              continued using parasol directly,
              followed by an <CODE>gbAlignStep</CODE> with
              <CODE>-continue=finish</CODE>.   If parasol loses track of
              the jobs, one can use the <CODE>parasol recover</CODE>
              command to generate a new jobs file with the jobs
              that have not completed.
      <LI> When run with the <CODE>-initial</CODE>, the working directory
           is not deleted.  This is to assist in debugging any problems.
           After doing the initial load of the database anc checking
           the results, <CODE>work/initial.$db</CODE> should be
           removed.  Note that this hierarchy is very large, its good
           remove it on the NFS server for the file system.
    </OL>

    <H3>Initial Database Load</H3>

    <OL>
      <LI><CODE>nice bin/gbDbLoadStep -verbose=1 -drop -initialLoad $db</CODE></LI>
      <UL>
      <LI> The <CODE>-drop</CODE> option drops any existing GenBank or RefSeq
           tables before loading.
      <LI> If an initial load was done using only the mRNAs, it will be
           most likely be <B>much</B> faster to drop all of the GenBank
           tables and load with the <CODE>-initialLoad</CODE> option
           when loading the ESTs.
      </UL>

    </OL>
<!--
FIXME: 
  - mention that build takes place on kk.
  - alignment directory, monitor with list batches
-->

  </BODY>
</HTML>

