#!/usr/bin/env perl

# DO NOT EDIT the /cluster/bin/scripts copy of this file --
# edit ~/kent/src/utils/dumpGenbankGrepIndex instead.

# $Id: dumpGrepIndex,v 1.4 2005/04/12 06:23:26 angie Exp $

use Getopt::Long;
use warnings;
use strict;

# Option variable names:
use vars qw/
    $opt_help
    $opt_debug
    /;

sub usage {
  my ($status) = @_;
  print STDERR "
usage: $0 baseDir db1 [db2 ...]

Dumps out tab-separated files with index and name from gbCdnaInfo-related
tables to be searched by hgFind.
";
  exit $status;
}

sub run {
  my ($cmd) = @_;
  print "# $cmd\n" if ($opt_debug);
  system($cmd) == 0 || die "Command failed:\n$cmd\n";
}

sub tableExists {
  my ($db, $table) = @_;
  my $cmd = 'show tables like \"' . $table . '\"';
  return `echo $cmd | hgsql $db -N | wc -l` > 0;
}

my $ok = GetOptions("help", "debug");
&usage(1) if (! $ok);
&usage(0) if ($opt_help);
&usage(1) if (scalar(@ARGV) < 2);

my ($baseDir, @dbs) = @ARGV;

foreach my $db ( @dbs ) {
  my $rawDir = "$baseDir/$db";
  &run("mkdir -p $rawDir");
  foreach my $table (qw/productName geneName author tissue cell description
		        development/) {
      if (&tableExists($db, $table)) {
	  my $cmd = ("echo select id,name from $table " .
		     "| hgsql -N $db  > $rawDir/$table.idName.tmp");
	  &run($cmd);
	  &run("mv -f $rawDir/$table.idName.tmp $rawDir/$table.idName");
      }
  }
  if (&tableExists($db, 'refLink')) {
      my $cmd = ("echo select mrnaAcc,product from refLink " .
		 "| hgsql -N $db  > $rawDir/refLink.mrnaAccProduct.tmp");
      &run($cmd);
      &run("mv -f $rawDir/refLink.mrnaAccProduct.tmp " .
	   "$rawDir/refLink.mrnaAccProduct");
  }
}

