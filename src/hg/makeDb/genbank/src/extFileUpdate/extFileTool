#!/usr/bin/env tclsh
set usage {extFileTool cmd
    Tool for running various extFile management tools.

    cmd is one of:
       - update - run update and generated extFile dumps
       - dump - generate extFile dumps
}

proc report {stat msg} {
    global host cmd logFh
    set out "$stat $host $cmd: $msg"
    puts $logFh $out
    exec mail -s "$host $cmd" <<$out markd
}

proc loadDbs {dbFile} {
    return [split [exec fgrep -v "#" $dbFile] \n]
}

proc dumpExtFile {db} {
    global host env
    set date [clock format [clock seconds] -format {%Y.%m.%d}]
    set dumpFile "var/dbload/$host/extFile/$date/$db.extFile.txt";
    set dumpTmp $dumpFile.tooltmp
    file mkdir [file dirname $dumpTmp]

    set env(HGDB_CONF) etc/.hg.conf
    exec hgsql -N -e {select * from gbExtFile} $db >$dumpTmp
    file rename -force $dumpTmp $dumpFile
}

proc extFileUpdate {dbs logFh} {
    foreach db $dbs {
        puts $logFh "==== begin $db ===="
        exec bin/x86_64/extFileUpdate $db >&@$logFh
        dumpExtFile $db
        puts $logFh "==== end $db ===="
        flush $logFh
    }
}

proc extFileDump {dbs logFh} {
    foreach db $dbs {
        puts $logFh "==== begin $db ===="
        dumpExtFile $db
        puts $logFh "==== end $db ===="
        flush $logFh
    }
}

if {[llength $argv] != 1} {
    error "wrong number of args: \n$usage"
}
set cmd [lindex $argv 0]
set host [lindex [split [exec hostname] .] 0]
switch -glob $host {
    hgwdev {
        set dbFile etc/hgwdev.dbs
    }
    hgwbeta {
        set dbFile etc/hgwbeta.dbs
    }
    hgw[0-9]* {
        set dbFile etc/rr.dbs
    }
    mgc {
        set dbFile etc/rr.dbs
    }
    error "don't know how to handle $host"
}
if {$host == "hgwdev"} {
    cd /cluster/data/genbank
} else {
    cd /genbank
}

set logFh [open misc/$host.$cmd.log w]
set dbs [split [exec fgrep -v "#"  $dbFile] \n]

if {[catch {
    switch $cmd {
        update {
            extFileUpdate $dbs $logFh
        }
        dump {
            extFileDump $dbs $logFh
        }
        default {
            error "unknown command: $cmd\n$usage"
        }
    }
} msg]} {
    report Error $msg 
    exit 1
}
report Ok complete



