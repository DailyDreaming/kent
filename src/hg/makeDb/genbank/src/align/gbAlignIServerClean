#!/usr/bin/perl
#
# gbAlignIServerClean [options] iserverdir
#
# Remove files from the iserver genbank area.  Use to cleanup after an
# manual alignment.
#
# Options:
#   -iserver=host - Explictly specify an iserver to use.  Maybe repeated.
#    If none are specified, the default list is used.
#   -verbose=n - print details
#
# Arguments:
#   o iserverdir - directory on iservers, must be under /scratch/genbank.
#
# $Id: gbAlignIServerClean,v 1.4 2003/10/08 21:06:18 markd Exp $
#
use strict;
use warnings;
use File::Basename;
use FindBin;
use lib "$FindBin::Bin/../lib";
use gbCommon;

# Entry
setTaskName("gbAlignIServerClean");

# parse into globals used in program
$main::cwd = `pwd`;
chomp($main::cwd);

my @iservers;
while (($#ARGV >= 0) && ($ARGV[0] =~/^-.*/)) {
    my $opt = $ARGV[0];
    shift @ARGV;
    if ($opt =~ /^-iserver($|=)/) {
        push(@iservers, parseOptEq($opt));
    } elsif ($opt eq "-verbose") {
        $gbCommon::verbose = 1;
    } elsif ($opt =~ /^-verbose=/) {
        $gbCommon::verbose = parseOptEq($opt);
    } else {
        gbError("invalid option \"$opt\"");
    }
}
if ($#ARGV != 0) {
    gbError("wrong # args: gbAlignIServerClean [options] iserverdir");
}
if ($#iservers < 0) {
    @iservers = splitSpaceList(getConfNo("cluster.iservers"));
}

my $iserverdir = $ARGV[0];

if ($gbCommon::verbose) {
    prMsg("start iserver clean");
}
foreach my $iserver (@iservers) {
    my @cmd = ("ssh", $iserver, "rm", "-rf", $iserverdir);
    backgroundStart("$iserver cleanup", @cmd);
}
if ($gbCommon::verbose) {
    prMsg("wait for processes");
}
while (backgroundWait() > 0) {
}
   
if ($gbCommon::verbose) {
    prMsg("iserver clean complete");
}
