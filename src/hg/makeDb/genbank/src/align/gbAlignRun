#!/usr/bin/perl
#
# gbAlignRun [-workdir=work/align] [-parahost=kk] [-verbose]
#
# Run the BLAT alignments with parasol.  
#
# Options:
#   -workdir=work/align - Must be the same as specified for gbAlignSetup.
#   -parahost=kk - Run parasol on this host. Must be able to rsh
#    to the host with .rhost auth.  If localhost is specified, the rsh will
#    not be used.
#  -verbose=n - print details.
#
# FIXME: rsh does not return the exit code of the remove process, it would
# be nice to use ssh, but that means enabling .rhosts auth
#
use strict;
use warnings;
use File::Basename;
use FindBin;
use lib "$FindBin::Bin/../lib";
use gbCommon;

# Limit the number of jobs pushed by para shove on each pass to this
# amount.  This will cause para shove to exit sooner if the jobs are
# failing.
my $PARA_MAX_PUSH = 20000;

# Entry
setTaskName("gbAlignRun");

# parse into globals used in program
$main::verbose = 0;
$main::cwd = `pwd`;
chomp($main::cwd);
$main::workDir = "work/align";
$main::paraHost = "kk";

while (($#ARGV >= 0) && ($ARGV[0] =~/^-.*/)) {
    my $opt = $ARGV[0];
    shift @ARGV;
    if ($opt =~ /^-workdir($|=)/) {
        $main::workDir = parseOptEq($opt);
    } elsif ($opt =~ /^-parahost=/) {
        $main::paraHost = parseOptEq($opt);
    } elsif ($opt =~ /^-verbose($|=)/) {
        # don't use level
        $main::verbose = 1;
        $gbCommon::verbose = 1;
    } else {
        gbError("invalid option \"$opt\"");
    }
}
if ($#ARGV >= 0) {
    gbError("wrong # args: gbAlignRun [-workdir=work/align] [-parahost=kk] [-verbose]");
}
my $alignJobs = "$main::workDir/align.jobs";

if (! -e "$alignJobs") {
    gbError("parasol jobs file not found: $alignJobs");
}
my $doneFlag = "$main::workDir/align.done";
if (-e $doneFlag) {
    gbError("alignment appears to have completed, $doneFlag exists");
}

# make absolute path to directory
my $absWorkDir;
if ($main::workDir =~ /^\//) {
    $absWorkDir = $main::workDir;
} else {
    $absWorkDir = "$main::cwd/$main::workDir";
}
my $rshCmd = "";
if ($main::paraHost ne "localhost") {
    $rshCmd = "rsh $main::paraHost cd $absWorkDir\\;";
}

# cd to work dir, need for local runs, but alway done to simplify
chdir $main::workDir || dir("can't chdir to $main::workDir");

# this runs to completion
runProg("$rshCmd para make -maxPush=$PARA_MAX_PUSH align.jobs </dev/null");

# Check results
my $paraCheck = callProg("$rshCmd para check </dev/null");
if ($paraCheck =~ /running:/) {
    gbError("alignment parasol jobs appear be running, should have completed in $main::workDir");
}
if (($paraCheck =~ /crashed:/) || ($paraCheck =~ /failed:/)) {
    gbError("alignment parasol jobs crashed in $main::workDir");
}

# Get time for logs
runProg("$rshCmd para time </dev/null");

open(DONE, ">", "align.done") || gbError("can't create $doneFlag");
close(DONE);
