#!/bin/bash -e

# Script load the MGC server. This polls to determine if a new build has been
# done and the result download to the gbdb server.  Expects the $gbRoot
# to be NFS exported from the gbdb server.

# errors terminate with message
set -e
trap "echo Error: genbank-mgc-load failed on `hostname` >&2; exit 1" ERR

# initialize
gbRoot=/scratch/genbank
cd $gbRoot
. $gbRoot/lib/gbCommon.sh


verb=""
verb="-verbose=1"

# allow 250mb core dumps
ulimit -c 256000

# workdir is a local dir, allowing gbRoot, including, var to be shared on NFS
workdir=/scratch/tmp/genbank

# data files and dirs
dbloadVar=var/dbload/`hostname`
copyTime=var/copy/copy.time
lastCopyTime=$dbloadVar/copy.time
lastCopyTimeTmp=$lastCopyTime.tmp
dbloadTime=$dbloadVar/dbload.time

# Checking for an existing lock file, Silently exits if lock file exists
# and is less than one day old,  error if older.
gbCheckLock $dbloadVar/run/dbload.lock

# check if the build is newer that what was last loaded
if ! gbCmpTimeFiles $copyTime $lastCopyTime ; then
    exit 0
fi

# save build time before load
cp -f $copyTime $lastCopyTimeTmp

# update databases
gbDbLoadStep $verb -workdir=$workdir \
    -buildAllMgc=hg15 \
    -buildAllMgc=mm3 \
     hg15 mm3

# on success, save time load completely and build time we started with
mv -f $lastCopyTimeTmp $lastCopyTime
gbMkTimeFile $dbloadTime

echo "genbank-mgc-load complete on `hostname`"
