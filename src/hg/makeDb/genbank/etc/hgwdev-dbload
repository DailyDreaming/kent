#!/bin/bash -e

# dbload for hgwdev server.
#   - separate script since hgwdev is updated before rr

# errors terminate with message
set -e
trap "echo Error: `hostname` dbload failed >&2; exit 1" ERR
exec </dev/null

# databases to update
databases="rn3 hg16"

# gbRoot on hgnfs1
gbRoot=/cluster/data/genbank
cd $gbRoot
. $gbRoot/lib/gbCommon.sh

verb=""
verb="-verbose=1"

# allow 250mb core dumps
ulimit -c 256000

# workdir is a local dir
workdir=/scratch/tmp/genbank

# data files and dirs
dbloadVar=var/dbload/`hostname`
buildTime=var/build/build.time
lastBuildTime=$dbloadVar/build.time
lastBuildTimeTmp=$lastBuildTime.tmp
dbloadTime=$dbloadVar/dbload.time

mkdir -p $dbloadVar

# Checking for an existing lock file, Silently exits if lock file exists
# and is less than one day old,  error if older.
gbCheckLock $dbloadVar/run/dbload.lock

# check if the build is newer that what was last loaded
if ! gbCmpTimeFiles $buildTime $lastBuildTime ; then
    exit 0
fi

# save build time before load
cp -f $buildTime $lastBuildTimeTmp

# update databases
# FIXME:  -downloadUpdate
nice gbDbLoadStep $verb -workdir=$workdir -downloadDump=7 $databases

# on success, save time load completely and build time we started with
mv -f $lastBuildTimeTmp $lastBuildTime
gbMkTimeFile $dbloadTime

echo "`hostname`: dbload completed"

