#!/bin/bash -e

# dbload for hgwdev server.
#   - separate script since hgwbeta is updated before rr
#   - does weekly dump of tables, which are picked up by other rr nodes

# errors terminate with message
set -e
trap "echo Error: `hostname` dbload failed >&2; exit 1" ERR

# gbRoot on hgnfs1
gbRoot=/genbank
cd $gbRoot
. $gbRoot/lib/gbCommon.sh

verb=""
verb="-verbose=1"

# allow 250mb core dumps
ulimit -c 256000

# workdir is a local dir
workdir=/scratch/tmp/genbank

# data files and dirs
dbloadVar=var/dbload/`hostname`
copyTime=var/copy/copy.time
lastCopyTime=$dbloadVar/copy.time
lastCopyTimeTmp=$lastCopyTime.tmp
dbloadTime=$dbloadVar/dbload.time

mkdir -p $dbloadVar

# Checking for an existing lock file, Silently exits if lock file exists
# and is less than one day old,  error if older.
gbCheckLock $dbloadVar/run/dbload.lock

# check if the build is newer that what was last loaded
if ! gbCmpTimeFiles $copyTime $lastCopyTime ; then
    exit 0
fi

# save build time before load
cp -f $copyTime $lastCopyTimeTmp

# update databases
gbDbLoadStep $verb -workdir=$workdir -downloadDump=7 rn3

# on success, save time load completely and build time we started with
mv -f $lastCopyTimeTmp $lastCopyTime
gbMkTimeFile $dbloadTime

echo "`hostname`: dbload completed"

