#!/bin/bash -e

# genbank-align [-finish] [-workdir dir]

# Script to do alignment part of build.  This is normally called by
# genbank-build, however it can be run by hand if the alignment needs to
# be manuall completed.  Edit this file to add new genomes and assemblies.
# 
# -finish - Finish processing an alignment that was completed by hand.
# -workdir dir - set the workdir, need with -finish if the date has
#  changed since the alignment was started.
#

# IMPORTANT: set omitIServers to a list of -omit-iserver=host options
# if one or more iservers are down
omitIServers=""
omitIServers="-omit-iserver=kkr5u00"

# errors terminate with message
set -e
trap "echo Error: genbank-align failed on `hostname` >&2; exit 1" ERR

# initialize
gbRoot=/cluster/store5/genbank
cd $gbRoot
. $gbRoot/lib/gbCommon.sh

buildTime=var/build/build.time

finish=""
while [[ $1 == -* ]] ; do
    opt=$1
    shift
    case "$opt" in
        -finish) 
            finish="-continue=finish" ;;
        -workdir)
            workdir="$1"
            shift ;;
        -*) echo "Error: invalid option $opt" >&2
            exit 1 ;;
    esac
done

# allow 250mb core dumps
ulimit -c 256000

# setup workdir unless specified on command line
if [ "x$workdir" = "x" ] ; then
    date=`date +"%Y.%m.%d"`
    workdir="work/daily/align.$date"
fi

# align on large cluster, rsyncing to iservers
clusterdir=/iscratch/genbank

hg15nibs='/scratch/hg/gs.16/build33/chromTrfMixedNib/chr*.nib'
hg15lift=/cluster/store5/gs.16/build33/jkStuff/liftAll.lft

mm3nibs='/scratch/hg/mm3/chromTrfMixedNib/chr*.nib'
mm3lift=/cluster/store2/mm.2003.02/mm3/jkStuff/liftAll.lft

gbAlignStep $finish $omitIServers \
    -workdir=$workdir \
    -clusterdir=$clusterdir \
    hg15 "$hg15nibs" $hg15lift \
    mm3  "$mm3nibs"  $mm3lift

gbMkTimeFile $buildTime

echo "genbank build complete on `hostname`"
