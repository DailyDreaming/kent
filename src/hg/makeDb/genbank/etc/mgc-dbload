#!/bin/bash -e

# dbload for mgc server.
#   - loads all MGC tables (in conf file)
#   - has different databases than other rr.

# errors terminate with message
set -e
trap "echo Error: `hostname` dbload failed >&2; exit 1" ERR

# databases to update
databases="hg15 mm3 rn2"

# gbRoot on hgnfs1
gbRoot=/genbank
cd $gbRoot
. $gbRoot/lib/gbCommon.sh

verb=""
verb="-verbose=1"

# allow 250mb core dumps
ulimit -c 256000

# workdir is a local dir
workdir=/var/tmp/genbank

# data files and dirs
dbloadVar=var/dbload/`hostname`
copyTime=var/copy/copy.time
lastCopyTime=$dbloadVar/copy.time
lastCopyTimeTmp=$lastCopyTime.tmp
dbloadTime=$dbloadVar/dbload.time

mkdir -p $dbloadVar

# Checking for an existing lock file, Silently exits if lock file exists
# and is less than one day old,  error if older.
gbCheckLock $dbloadVar/run/dbload.lock

# check if the build is newer that what was last loaded
if ! gbCmpTimeFiles $copyTime $lastCopyTime ; then
    exit 0
fi

# save build time before load
cp -f $copyTime $lastCopyTimeTmp

# update databases
gbDbLoadStep $verb -workdir=$workdir -downloadUpdate $databases

# on success, save time load completely and build time we started with
mv -f $lastCopyTimeTmp $lastCopyTime
gbMkTimeFile $dbloadTime

echo "`hostname`: dbload completed"

