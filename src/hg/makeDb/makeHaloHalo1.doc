#!/bin/csh -f # set emacs mode
exit; # don't actually run this like a script :)
 
# This file describes building the browser database for the archaeal
# species Methanosarcina acetivorans.
#
# if this is the first time you are making your own hgwdev browser, need to do 
# cd ~/kent/src/, then a make

# DOWNLOAD SEQUENCE FROM GENBANK (DONE)

    ssh eieio
    mkdir /cluster/store5/archae/haloHalo1
    ln -s /cluster/store5/archae/haloHalo1 /cluster/data/haloHalo1
    cd /cluster/data/haloHalo1
    cp /projects/lowelab/db/Bacteria/Halobacterium_sp/Halo_sp* .
    mv Halo_sp.fa haloHalo1.fa
    # Edit header of *.fa to '>chr >plasmid_pNRC100 >plasmid_pNRC200'
   
    faToTwoBit haloHalo1.fa haloHalo1.2bit 

    mkdir /gbdb/haloHalo1
    ln -s /cluster/data/haloHalo1/haloHalo1.2bit /gbdb/haloHalo1/haloHalo1.2bit

# CREATE DATABASES AND A BUNCH OF INITIAL STUFF (DONE)

    ssh hgwdev
    echo 'create database haloHalo1' | hgsql ''
    cd /cluster/data/haloHalo1

    faSize -detailed haloHalo1.fa > chrom.sizes
    echo "create table grp (PRIMARY KEY(NAME)) select * from hg16.grp" \
	    | hgsql haloHalo1
    echo 'INSERT INTO dbDb \
        (name, description, nibPath, organism, \
                defaultPos, active, orderKey, genome, scientificName, \
                htmlPath, hgNearOk) values \
        ("haloHalo1", "August 1996", "/gbdb/haloHalo1", "Halobacterium sp.", \
               "chr1:500000-550000", 1, 233, "Halobacterium sp.", \
                "Halobacterium sp. NRC-1", "/gbdb/haloHalo1/html/description.html", \
                0);' \
      | hgsql hgcentraltest
    echo 'INSERT INTO defaultDb (genome, name) values ("Halobacterium sp.", "haloHalo1");' \
      | hgsql hgcentraltest
    echo 'INSERT INTO genomeClade (genome, clade, priority) values ("Halobacterium sp.", "archaea",85);'  \
      | hgsql hgcentraltest

# CREATE CHROMINFO TABLE (DONE)
  ssh hgwdev
  cd /cluster/data/haloHalo1

   cp ~baertsch/kent/src/hg/lib/chromInfo.sql .
   hgsql haloHalo1 < chromInfo.sql
   echo "load data local infile 'chrom.sizes' into table chromInfo" | hgsql haloHalo1
   echo "update chromInfo set fileName = '/gbdb/haloHalo1/haloHalo1.2bit'" | hgsql haloHalo1

    cd ~/kent/src/hg/makeDb/trackDb

    # add the trackDb directories
    mkdir -p archae/haloHalo1
    cvs add archae/haloHalo1
    cvs commit archae/haloHalo1

    make DBS=haloHalo1


# GC20BASE (DONE)
    mkdir -p /cluster/data/haloHalo1/bed/gc20Base
    cd /cluster/data/haloHalo1/bed/gc20Base
    hgGcPercent -wigOut -doGaps -file=stdout -win=20 haloHalo1 \
        /cluster/data/haloHalo1/ | wigEncode stdin gc20Base.wig gc20Base.wib

    cd /cluster/data/haloHalo1/bed/gc20Base
    mkdir /gbdb/haloHalo1/wib
    ln -s `pwd`/gc20Base.wib /gbdb/haloHalo1/wib
    hgLoadWiggle -pathPrefix=/gbdb/haloHalo1/wib haloHalo1 gc20Base gc20Base.wig
    #	verify index is correct:
    hgsql haloHalo1 -e "show index from gc20Base;"
    #	should see good numbers in Cardinality column


# TANDEM REPEAT MASKER (DONE)

    ssh hgwdev
    mkdir -p /cluster/data/haloHalo1/bed/simpleRepeat
    cd /cluster/data/haloHalo1
    trfBig haloHalo1.fa /dev/null -bedAt=/cluster/data/haloHalo1/bed/simpleRepeat/chr.bed
    cd /cluster/data/haloHalo1/bed/simpleRepeat
    hgLoadBed haloHalo1 simpleRepeat *.bed -sqlTable=/cluster/home/lowe/kent/sr/hg/lib/simpleRepeat.sql

# Chains with halMar1

    cd /cluster/data/haloHalo1/bed/
    mkdir conservation
    cd conservation
    cp /cluster/data/pyrFur2/bed/conservation/HoxD55.q .
    cp ../../haloHalo1.fa haloHalo1.chr
    cat /cluster/data/halMar1/*.fa > halMar1.chr
    #fix headers
    sed s/\>plasmid/\>haloHalo1.plasmid/ haloHalo1.chr | gawk '{if(/haloHalo1.plasmid/){print $1;} else{print $0;}}' > temp
    sed s/\>chr/\>haloHalo1.chr/ temp | gawk '{if(/haloHalo1.chr/){print $1;} else{print $0;}}' > haloHalo1.chr
    sed s/\>Haloarcula_marismortui_ATCC_43049_/\>halMar1./ halMar1.chr | gawk '{if(/halMar1./){print $1;} else{print $0;}}' > temp
    sed s/II/2/ temp > temp2
    sed s/I/1/ temp2 > temp
    sed s/_pNG// temp > temp2
    sed s/00// temp2 > halMar1.chr
    rm temp temp2
    faToTwoBit haloHalo1.chr haloHalo1.2bit
    faToTwoBit halMar1.chr halMar1.2bit
    faSize -detailed *.chr > chrom.sizes

    #blastz 
    blastz haloHalo1.chr halMar1.chr Q=HoxD55.q > haloHalo1-halMar1.lav
    lavToAxt haloHalo1-halMar1.lav haloHalo1.2bit halMar1.2bit haloHalo1-halMar1.axt

    #chain
    # Reuse gap penalties from chicken run.
    cat << '_EOF_' > temp.gap
tablesize       11
smallSize       111
position        1       2       3       11      111     2111    12111   32111   
72111   152111  252111
qGap    325     360     400     450     600     1100    3600    7600    15600   
31600   56600
tGap    325     360     400     450     600     1100    3600    7600    15600   
31600   56600
bothGap 625     660     700     750     900     1400    4000    8000    16000   
32000   57000
'_EOF_'
    sed 's/  */\t/g' temp.gap > chicken.gap
    rm temp.gap
    axtChain -scoreScheme=HoxD55.q \
                      -linearGap=chicken.gap \
                      -minScore=5000 haloHalo1-halMar1.axt \
                       haloHalo1.2bit halMar1.2bit \
                       haloHalo1-halMar1.chain
    
    #load 
    ln -s /cluster/data/haloHalo1/bed/conservation/haloHalo1-halMar1.chain /gbdb/haloHalo1/chainHalMar1
    hgLoadChain haloHalo1 chainHalMar1 haloHalo1-halMar1.chain

    #trackDb
    cd ~/kent/src/hg/makeDb/trackDb/archae/
    mkdir haloHalo1
    cvs add haloHalo1
    cd haloHalo1
    # track chainHalMar1
    # shortLabel HalMar1 Chain    
    # longLabel Haloarcula marismortui Chained Alignments                
    # group compGeno
    # priority 150.1
    # visibility hide
    # color 100,50,0
    # altColor 255,240,200
    # spectrum on
    # type chain    
    cvs add trackDb.ra
    cvs commit -m "halMar1 chains" trackDb.ra
    cvs add chainHalMar1.html
    cvs commit -m "added malMar1 chains" chainMalMar1.html

# DESCRIPTION PAGE ()

    ssh hgwdev
    # Write ~/kent/src/hg/makeDb/trackDb/archae/haloHalo1/description.html
    chmod a+r ~/kent/src/hg/makeDb/trackDb/archae/haloHalo1/description.html
    # Check it in.
    mkdir /gbdb/haloHalo1/html
    ln -s /cluster/data/haloHalo1/html/description.html /gbdb/haloHalo1/html/

# GENBANK PROTEIN-CODING GENES ()

    ssh hgwdev
    mkdir /cluster/data/haloHalo1/genbank
    cd /cluster/data/haloHalo1/genbank
    cp /projects/lowelab/db/Bacteria/Halobacterium_sp/ .
    
    mv NC_003552.gbk haloHalo1.gbk
    # Create 3 files to assist parsing of the genbank
    # 1. for a bed file
    echo 'chr
start
end
gene
1000
strand' > haloHalo1-params-bed.txt
    # 2. for the peptide parts
    echo 'gene
translation' > haloHalo1-params-pep.txt
    # 3. for the other gene information
    echo 'gene
product
note' > haloHalo1-params-xra.txt
    # Now extract the genes and information:
    gbArchaeGenome haloHalo1.gbk haloHalo1-params-bed.txt haloHalo1-genbank-cds.bed
    gbArchaeGenome haloHalo1.gbk haloHalo1-params-pep.txt haloHalo1-genbank-cds.pep
    gbArchaeGenome haloHalo1.gbk haloHalo1-params-xra.txt haloHalo1-genbank-cds.xra
    hgLoadBed haloHalo1 gbProtCode haloHalo1-genbank-cds.bed
    hgsql haloHalo1 < ~/kent/src/hg/lib/pepPred.sql
    hgsql haloHalo1 < ~/kent/src/hg/lib/minGeneInfo.sql
    echo rename table pepPred to gbProtCodePep | hgsql haloHalo1
    echo rename table minGeneInfo to gbProtCodeXra | hgsql haloHalo1
    echo load data local infile \'haloHalo1-genbank-cds.pep\' into table gbProtCodePep | hgsql haloHalo1
    echo load data local infile \'haloHalo1-genbank-cds.xra\' into table gbProtCodeXra | hgsql haloHalo1

#genbank to genePred

csh
tawk '{print $1,$2,$3,$4,$5,$6,$2,$3,0,1,$3-$2,0}' haloHalo1-genbank-cds.bed | bedToGenePred stdin tmp.gp
tawk '{print $1,$2,$3,$4,$5,$6,$7,$8,$9,$10,substr($1,3,4),name2,"cmpl","cmpl",0}' tmp.gp  > tmp2.gp
join -t "     " -o 1.1,1.2 1.3 1.4 1.5 1.6 1.7 1.8 1.9 1.10 1.11 2.3 1.13 1.14 1.15  tmp2.gp haloHalo1-genbank-cds.xra > haloHalo1.gp

# GENBANK rRNA GENES ()
    ssh hgdev
    cd /cluster/data/haloHalo1/genbank
    gbArchaeGenome -kind=rRNA haloHalo1.gbk haloHalo1-params-bed.txt haloHalo1-rrnas.bed
    echo 'gene product NA' > haloHalo1-params-rrna-xra.txt
    gbArchaeGenome -kind=rRNA haloHalo1.gbk haloHalo1-params-rrna-xra.txt haloHalo1-rrnas-xra.txt
    hgLoadBed haloHalo1 gbRRNA haloHalo1-rrnas.bed
    hgsql haloHalo1 < ~/kent/src/hg/lib/minGeneInfo.sql
    echo rename table minGeneInfo to gbRRNAXra | hgsql haloHalo1
    echo load data local infile \'haloHalo1-rrnas-xra.txt\' into table gbRRNAXra | hgsql haloHalo1

# COG STUFF ()
    # Cut and paste http://www.ncbi.nlm.nih.gov/cgi-bin/COG/palox into emacs (COG list)
    # and save as cogpage.txt
    awk '{printf("%s\t%s\n",$6,$5)}' < cogpage.txt | sed -e 's/\[//' -e 's/\]//' > cogs.txt
    rm cogpage.txt
    # Now we have the basic list of cogs and the letter code for each one.
    

# TODD LOWE tRNA GENES ()

    # This one is a bed 6+ file created by hand of 46 tRNAs and 1 pseudo tRNA by Todd
    # Lowe.  See ~/kent/src/hg/lib/loweTrnaGene.as for a description of the fields.
    # **Showing the tRNAScanSE instructions would be nice in the future.  
    ssh hgwdev
    mkdir /cluster/data/haloHalo1/bed/loweTrnaGene
    cd /cluster/data/haloHalo1/bed/loweTrnaGene
    hgLoadBed -tab haloHalo1 loweTrnaGene haloHalo1-lowe-trnas.bed -sqlTable=~/kent/src/hg/lib/loweTrnaGene.sql

# TODD LOWE snoRNA GENES ()
    # This is a bed 6 file created by hand.
    ssh hgwdev
    mkdir /cluster/data/haloHalo1/bed/loweSnoGene
    cd /cluster/data/haloHalo1/bed/loweSnoGene
    hgLoadBed -tab haloHalo1 loweSnoGene haloHalo1-snos.bed

# TIGR GENES ()
    # First go to http://www.tigr.org/tigr-scripts/CMR2/gene_attribute_form.dbi
    # and fill out the web form as follows:
    #   - Pick "Retrieve attributes for the specified DNA feature within a specific 
    #     organism and/or a specific role category".
    #       * Pick "Pyrobaculum aerophilum IM2", and "Primary and TIGR annotation ORFs" 
    #         from the 1st and 3rd box.
    #       * Select everything from "Choose TIGR Annotation Gene Attributes"
    #       * Select "Primary Locus Name" from "Choose Primary Annotation Gene Attributes"
    #       * Select everything from "Choose Other Gene Attributes"
    #   - Click submit, and click save as tab-delimited file.
    ssh hgwdev
    mkdir /cluster/data/haloHalo1/bed/tigrCmrORFs
    cp haloHalo1-tigr.tab /cluster/data/haloHalo1/bed/tigrCmrORFs
    cd /cluster/data/haloHalo1/bed/tigrCmrORFs
    /projects/lowelab/users/aamp/bin/i386/tigrCmrToBed haloHalo1-tigr.tab haloHalo1-tigr.bed
    hgLoadBed -tab haloHalo1 tigrCmrORFs haloHalo1-tigr.bed -sqlTable=~/kent/src/hg/lib/tigrCmrGene.sql
