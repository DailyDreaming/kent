# Make your private trackDb with 
#	make update
# Make it for genome-test with
#	make alpha

# Browser supports multiple trackDb's so that individual developers
# can change things rapidly without stepping on other people's toes. 
# Usually when updating it is best to update your own trackDb and
# test it to make sure it works and that you have cvs updated all
# of trackDb/ before doing a make alpha. Note that you
# must specify which trackDb you are using in your .hg.conf file
# or in the cgi-bin-$(USER)/hg.conf file. Something like: 
# db.trackDb=trackDb_YourUserName

DBS = 	hg13 hg15 hg16 hg17 \
	panTro1 \
	mm2 mm3 mm4 \
	rn2 rn3 \
	galGal2 \
	fr1 \
	dm1 \
	dp1 \
	ci1 \
	ce1 ce2 \
	cb1 \
	falciparum \
	sacCer1 \
	pyrAer1 \
	pyrFur2 \
	sc1 \
	aquAeo1 \
	bucBuc1 \
        metMar1 \
        borBro1 \
	salTyp1 \
	metKan1 \
	aerPer1 \
	escColH7 \
	theAci1 \
	sulTok1 \
	pyrHor1 \
	geoSul1 \
	deiRad1 \
	haloSp1 \
	synSp1 \
	vibCho1

MGC_DBS = \
	hg15 hg16 hg17 \
	mm3 mm4

update:
	@for DB in $(DBS) x; do \
	    if test "$$DB" != "x" ; then \
		dbpath=`ls -1 -d */$$DB 2> /dev/null` ; \
		if test -n "$$dbpath" ; then \
		    org=`echo $$dbpath | sed -e 's/\/.*//'` ; \
		    if test -f $$dbpath/visibility.ra ; then \
			vis="-visibility=$$dbpath/visibility.ra" ; \
		    else if test -f $$org/visibility.ra ; then \
			vis="-visibility=$$org/visibility.ra" ; \
		    else \
			vis="" ; \
		fi ; fi ; fi; \
		cmd="hgTrackDb $$vis $$org $$DB trackDb_${USER} ../../lib/trackDb.sql ." ; \
		echo $$cmd ;  $$cmd ; \
		cmd="hgFindSpec $$org $$DB hgFindSpec_${USER} ../../lib/hgFindSpec.sql ." ; \
		echo $$cmd ;  $$cmd ; \
	    fi ; \
	done
	cd zoo; make update; cd ..


alpha:
	cvs up -d -P .
	@for DB in $(DBS) x; do \
	    if test "$$DB" != "x" ; then \
		dbpath=`ls -1 -d */$$DB 2> /dev/null` ; \
		if test -n "$$dbpath" ; then \
		    org=`echo $$dbpath | sed -e 's/\/.*//'` ; \
		    if test -f $$dbpath/visibility.ra ; then \
			vis="-visibility=$$dbpath/visibility.ra" ; \
		    else if test -f $$org/visibility.ra ; then \
			vis="-visibility=$$org/visibility.ra" ; \
		    else \
			vis="" ; \
		fi ; fi ; fi; \
		cmd="hgTrackDb $$vis $$org $$DB trackDb ../../lib/trackDb.sql ." ; \
		echo $$cmd ;  $$cmd ; \
		cmd="hgFindSpec $$org $$DB hgFindSpec ../../lib/hgFindSpec.sql ." ; \
		echo $$cmd ;  $$cmd ; \
		if test -f $$dbpath/description.html ; then \
		    cp $$dbpath/description.html /gbdb/$$DB/html ; \
		fi ; \
	    fi ; \
	done
	cd zoo; make alpha; cd ..

strict:
	cvs up -d -P .
	@for DB in $(DBS) x; do \
	    if test "$$DB" != "x" ; then \
		dbpath=`ls -1 -d */$$DB 2> /dev/null` ; \
		if test -n "$$dbpath" ; then \
		    org=`echo $$dbpath | sed -e 's/\/.*//'` ; \
		    if test -f $$dbpath/visibility.ra ; then \
			vis="-visibility=$$dbpath/visibility.ra" ; \
		    else if test -f $$org/visibility.ra ; then \
			vis="-visibility=$$org/visibility.ra" ; \
		    else \
			vis="" ; \
		fi ; fi ; fi; \
		cmd="hgTrackDb -strict=yes $$vis $$org $$DB trackDb ../../lib/trackDb.sql ." ; \
		echo $$cmd ;  $$cmd ; \
		cmd="hgFindSpec -strict $$org $$DB hgFindSpec ../../lib/hgFindSpec.sql ." ; \
		echo $$cmd ;  $$cmd ; \
	    fi ; \
	done
	cd zoo; make strict; cd ..

# this will fail if we are not in a beta checkout:
checkbeta:
	cvs status trackDb.ra | egrep 'v[0-9]+_branch' > /dev/null

beta: checkbeta strict

# This target adds trackDbLocal to the mgc-specific server.  
mgc:
	@for DB in $(MGC_DBS) x; do \
	    if test "$$DB" != "x" ; then \
		dbpath=`ls -1 -d */$$DB 2> /dev/null` ; \
		if test -n "$$dbpath" ; then \
		    org=`echo $$dbpath | sed -e 's/\/.*//'` ; \
		    vis="" ; \
		    cmd="hgTrackDb -strict=yes -raName=trackDbMgc.ra $$vis $$org $$DB trackDbLocal ../../lib/trackDb.sql ." ; \
		    echo $$cmd ;  $$cmd ; \
		    cmd="hgFindSpec -strict $$org $$DB hgFindSpec ../../lib/hgFindSpec.sql ." ; \
		    echo $$cmd ;  $$cmd ; \
		fi ; \
	    fi ; \
	done

