#!/bin/bash -e

# create/recreate tableList (cache of "SHOW TABLES") for given assembly

dbs="$@"
for db in $dbs ; do
    tmpFile=`mktemp`
    hgsql $db -e 'SHOW TABLES' | tail -n +2 > $tmpFile
    hgsql $db -e "CREATE TABLE tableList$$ (name varchar(255) not null, PRIMARY KEY(name))"
    hgsql $db -e "LOAD DATA LOCAL INFILE '$tmpFile' INTO TABLE tableList$$"

    # written so that tableList always exists (i.e. we use a temporary file and rename (which is hopefully atomic))

    set +e
    hgsql $db -e 'desc tableList' 2>1 > /dev/null
    err=$?
    set -e

    if [ $err -eq 0 ] ; then
        hgsql $db -e "RENAME TABLE tableList to tableListOld, tableList$$ TO tableList"
        hgsql $db -e "DROP TABLE tableListOld"
    else
        hgsql $db -e "RENAME TABLE tableList$$ TO tableList"
    fi

    rm $tmpFile
done
