#!/bin/csh -f # set emacs mode
exit; # don't actually run this like a script :)

# Macaca Mulatta  (rheMac2)
# Venter Institute final split merge assembly using washU and baylor

# DOWNLOAD SEQUENCE (DONE jan27  2006 Robert)
    ssh kkstore01
    mkdir /cluster/store2/rheMac2
    mkdir /cluster/store2/rheMac2/final
    cd /cluster/data
    ln -s /cluster/store2/rheMac2/final rheMac2
    cd /cluster/data/rheMac2
    mkdir downloads
    cd downloads


The macaque genome assembly (v. 1.0, Mmul051212) has been posted to the macaque genome ftp site:
ftp://macftp@ftp.macaquegenome.hgsc.bcm.tmc.edu/

The pw is analysis .


mkdir final
cd final
mkdir download
cd download

# A.  The assembly itself is represented in three groups, 1) the main assembly, 2) the Chr#_random and ChrU set, and 3) the ChrUr set (a late addition to the ChrU set).

#AGP and Fasta chromosome files for these three sets are:
#   1) Main Assembly - these are scaffolds, not chromosomes.
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1-edit4.trimNoContam.agp.bz2
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1_edit4.scf.fasta.bz2
#   2) Mapped to chromosomes but unplaced Chr#_random, and unmapped contigs ChrU
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.random.ctgs.agp.bz2 
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.random.scfs.agp.bz2 
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1_edit4.random.chrm.fasta.bz2
#   3) Late addition of 353 contigs to ChrU
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.ChrUr.chrm.fasta.bz2  
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.ChrUr.ctgs.agp.bz2     
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.ChrUr.scfs.agp.bz2 

# B.  The contigs fasta and quality files that go into these are in two sets, the bulk of the files (those in parts 1 and 2 of the assembly above) and the few that were added back at the last minute (part 3 above).  
#    1)
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/NewMergeSplit/v1.edit3.noContam.ctg.fasta.bz2
#    2)
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/NewMergeSplit/v1.edit3.noContam.ctg.qv.bz2
#    3) The 353 contigs that were added back at the last minute are included in the following files (other contigs in these files are not included in the assembly)
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/NewMergeSplit/v1.edit3.degen.noContam.fasta.bz2
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/NewMergeSplit/v1.edit3.degen.noContam.qv.bz2


# C.  The final assembly file in the VI internal assembly format is:
wget ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.asm.bz2

#D.  The chromosome files are below, note, all gaps are listed as "fragment yes" in the agp files, although some are spanned by clones and others are not (making use of human synteny or macaque map information instead).  These files will be corrected to list the uncaptured gaps as "clone no", but the intervals and other information will not change, so use these for other information now.

wget -q ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.chrm.fasta.corr.bz2
wget -q ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.chrome.ctgs.agp.corr.bz2
wget -q ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu/Assemblies/VI/FinalMergeSplit/v1.edit4.chrome.scfs.agp.corr.bz2

bunzip2 *.bz2
#wrap extra long lines in fasta
fold v1_edit4.random.chrm.fasta |sed -e 's/ChrUr/chrUr/' > rheMac2_random.fa
fold v1.edit4.chrm.fasta.corr |sed -e 's/ChrUr/chrUr/' >rheMac2.fa
fold v1_edit4.scf.fasta |sed -e 's/ChrUr/chrUr/' > rheMac2.scf.fa
mkdir ../Ur
fold v1.edit4.ChrUr.chrm.fasta |sed -e 's/ChrUr/chrUr/' > ../Ur/chrUr.fa
mv v1.edit4.chrome.ctgs.agp.corr v1.edit4.chrome.ctgs.corr.agp
mv v1.edit4.chrome.scfs.agp.corr v1.edit4.chrome.scfs.corr.agp


# Check that IDs in .fa match IDs in .qual

  ssh kkstore01
  cd /cluster/data/rheMac2/downloads
  # foreach Bin0 contigs linearScaffolds reads
  grep ">" *.fasta > id.fa
  grep ">" *.qv > id.qual
  diff id.fa id.qual

# change chromosomes to lower case

sed -e 's/Chr/chr/' v1.edit4.chrome.ctgs.agp.final > v1.edit4.chrome.ctgs.final.fix2.agp
cat v1.edit4.chrome.scfs.agp.final |sed -e 's/Chr/chr/' > v1.edit4.final.fix2.agp
hgGoldGapGl -noGl rheMac2 /cluster/data/rheMac2/downloads/v1.edit4.final.fix2.agp

  /cluster/bin/i386/checkAgpAndFa v1.edit4.final.fix.agp rheMac2.fa > check.out   

# SPLIT UP chromosome and make 500k chunks for RM


  ssh kkstore02
  cd /cluster/data/rheMac2

  faSplit byname downloads/rheMac2.fa chrom
  for i in `awk '{print $1}' chrom.sizes` ; do echo $i ; mkdir -p ${i##chr} ; mv $i.fa ${i##chr} ; pushd ${i##chr} ; faSplit -lift=$i.lft size $i.fa 500000 split ; popd; done 
  # generate list
  find scaffolds -print > scaffolds.list.0
  grep fa scaffolds.list.0 > scaffolds.list

#### MAKE 2BIT NIB FILE 

  ssh kkstore01
  nice /cluster/bin/i386/faToTwoBit rheMac2.fa rheMac2.2bit
  nice /cluster/bin/i386/twoBitToFa rheMac2.2bit check.fa
  mv rheMac2.2bit ..
  # could also use cmp
  # note: size match
  faSize -detailed=on rheMac2.fa >mac.len 
  faSize -detailed=on check.fa >check.len 
  diff mac.len check.len
  wc -l *.len

  ssh hgwdev
  mkdir /gbdb/rheMac2
  ln -s /cluster/data/rheMac2/rheMac2.2bit /gbdb/rheMac2/rheMac2.2bit


#### CREATE DATABASE (DONE Jan 27 , 2006 Robert)

  ssh hgwdev
  hgsql hg17
  create database rheMac2;
  use rheMac2;
  create table grp (PRIMARY KEY(NAME)) select * from hg17.grp;
  # add rows to hgcentraltest on hgwbeta in dbDb and defaultDb
  # set orderKey past dog, before chimp

# LOAD GAP & GOLD TABLES FROM AGP 
    ssh hgwdev
    hgGoldGapGl -noGl rheMac2 /cluster/data/rheMac2/downloads/v1.edit4.chrome.scfs.final.fix.agp
# CREATE GAP TABLE  from v1.edit4.chrome.ctgs.final.fix.agp to get gaps

  ssh hgwdev
  cd kent/src/hg/lib
  # remove bin column for now
  hgsql rheMac2 < gap2.sql
  cd /cluster/data/rheMac2/downloads
  grep fragment v1.edit4.chrome.ctgs.final.fix.agp > fragment.txt
  grep clone v1.edit4.chrome.ctgs.final.fix.agp >> fragment.txt 
  hgsql rheMac2
  load data local infile 'fragment.txt' into table gap
  # create trackDb/monkey/rheMac2/gap.html

# CREATE CONTIG TABLE  (DONE Feb 15,2006 Robert)

  ssh hgwdev
  cd kent/src/hg/lib
  cp ~/kent/src/hg/lib/ctgPos.sql .
  # edit ctgPos.sql to increase size of primary key to 20
  # this doesn't include strand or contig start/end
  hgsql rheMac2 < ctgPos.sql
  cd /cluster/data/rheMac2/downloads
  grep -v clone v1.edit4.chrome.ctgs.final.fix.agp |grep -v fragment > Contig.out

  ssh kkstore02
  cd /cluster/data/rheMac2/downloads
  getContig.pl < Contig.out > ctgPos
  ssh hgwdev
  load data local infile 'ctgPos' into table ctgPos
  #convert to half open and fix bug in agp file
  hgsql rheMac2 -e "update ctgPos set chromStart = chromStart -1 "
  hgsql rheMac2 -e "update ctgPos set size = size -1 "
# CREATE CHROMINFO TABLE 
# an improvement here would be to have getMaxCoord output the 2bit file name
  ssh hgwdev
  cd /cluster/data/rheMac2
  # get coordinates from agp and put in database table
  getcoords.pl < downloads/v1.edit4.chrome.scfs.final.fix.agp > scaffolds.coords
  hgsql rheMac2 < /cluster/data/bosTau1/coords.sql
  load data local infile 'scaffolds.coords' into table scaffoldCoords
  faSize rheMac2.fa -detailed=on > chrom.sizes

  # calculate maximum coords; check that start coord is always 1
##  /cluster/home/heather/bin/i386/GetMaxCoord > getMaxCoord.rheMac2

   edit chromInfo.sql; allow fileName to be null
   cp ~baertsch/kent/src/hg/lib/chromInfo.sql .
   hgsql rheMac2 < chromInfo.sql
   load data local infile 'chrom.sizes' into table chromInfo
   update chromInfo set fileName = "/gbdb/rheMac2/rheMac2.2bit"



# REPEATMASKER 
# using the split scaffold fa files generated earlier

# note the version of RepeatMasker in use; will want this for download README
  cat /cluster/bluearc/RepeatMasker/Libraries/version
# RM database version 20060120

# do a trial run
  ssh hgwdev
  cd /cluster/data/rheMac2/scaffolds/0/0/0
  /cluster/bluearc/RepeatMasker/RepeatMasker -ali -s -spec macaca Contig1000.fa
# configure
  cd /cluster/data/rheMac2
  mkdir jkStuff
  cp /cluster/data/anoGam1/jkStuff/RMAnopheles jkStuff/RMRhesus
  # change references anoGam1 --> rheMac2
  mkdir RMRun

  # /bin/csh makeJoblist-RM.csh

  # do the run  (DONE Jan 30, 2006 Robert)
  ssh pk
  cd /cluster/data/rheMac2/RMRun
  para create RMJobs.2
  para try
  para push

  # concatenate into one output file; took about 90 minutes
  ssh kkstore01
  cd /cluster/data/rheMac2
  mkdir repeats
  /bin/tcsh concatRM.csh
  cd repeats
  # use grep -v to get rid of all the headers
  # then, add back in an initial header
  # this is so hgLoadOut is happy
  grep chr repeats.all > repeats.clean
  cat repeats.header repeats.clean > repeats.final
  grep "There were no repetitive sequences " repeats.final > repeats.notfound
  grep -v "There were no repetitive sequences " repeats.final > repeat.out
  ssh hgwdev
  hgLoadOut rheMac2 repeat.out 2>errors 
  # Strange perc. fields:

Processing repeats.out
Strange perc. field -6.4 line 652513 of repeat.out
Strange perc. field -2236.0 line 749163 of repeat.out
Strange perc. field -2637.9 line 749163 of repeat.out
Strange perc. field -99.3 line 749163 of repeat.out
Strange perc. field -0.3 line 1386112 of repeat.out
Strange perc. field -0.2 line 2045133 of repeat.out
Strange perc. field -0.4 line 2429164 of repeat.out
Strange perc. field -4.8 line 2778536 of repeat.out
Strange perc. field -0.4 line 2912076 of repeat.out
Strange perc. field -5.5 line 3498109 of repeat.out
Strange perc. field -1.0 line 3642974 of repeat.out
Strange perc. field -2.7 line 3642974 of repeat.out
Strange perc. field -263.9 line 3711627 of repeat.out
Strange perc. field -187.0 line 3711627 of repeat.out
Strange perc. field -3.4 line 3795344 of repeat.out
Strange perc. field -0.1 line 3932239 of repeat.out
Strange perc. field -0.2 line 4092279 of repeat.out
Strange perc. field -0.1 line 4240026 of repeat.out
Strange perc. field -0.1 line 4440809 of repeat.out
Strange perc. field -7915.8 line 4506386 of repeat.out
Strange perc. field -0.1 line 4514494 of repeat.out
Strange perc. field -4361.2 line 4667281 of repeat.out
Strange perc. field -840.4 line 4667281 of repeat.out

Loading up table repeats_rmsk
note: 997 records dropped due to repStart > repEnd

  hgsql rheMac2
  rename table repeats_rmsk to rmsk

  # select count(*) from rmsk;

# SIMPLE REPEATS (DONE Jan 30, 2006 Robert)
# put the results throughout the scaffold 0/0/0 directories,
# same as RepeatMasker, to avoid too many files in the same directory
  ssh kkstore01
  cd /cluster/data/rheMac2
  mkdir bed
  cd bed
  mkdir simpleRepeat
  cd simpleRepeat

  /bin/csh makeJoblist-trf.csh
  tcsh trf-run.csh > & ! trf.log &

  # concatenate into one output file; took about an hour
    cat chr*.bed > simpleRepeat.bed


  # load
  /cluster/bin/i386/hgLoadBed rheMac2 simpleRepeat simpleRepeat.bed \
    -sqlTable = /cluster/home/heather/kent/src/hg/lib/simpleRepeat.sql

#Reading trf.bed
#Loaded 628275 elements of size 16
#Sorted
#Saving bed.tab
#Loading rheMac2

  create index chrom_2 on simpleRepeat (chrom(16), chromStart);
  create index chrom_3 on simpleRepeat (chrom(16), chromEnd);


# CREATE MASKED FA USING REPEATMASKER AND FILTERED TRF FILES 

  ssh kkstore02
  cd /cluster/data/rheMac2
  /cluster/bin/i386/maskOutFa -soft downloads/rheMac2.fa repeats/repeat.out rheMac2.softmask.fa

WARNING: negative rEnd: -11 chr1:17040504-17040634 MLT2B4
WARNING: negative rEnd: -15 chr1:39400221-39400370 MLT2B4
WARNING: negative rEnd: -28 chr1:75866521-75866637 MLT2B4
WARNING: negative rEnd: -104 chr1:102866722-102866763 MLT2B4
WARNING: negative rEnd: -52 chr1:132930605-132930673 MLT2B4
WARNING: negative rEnd: -686 chr1:133186227-133186372 L1MCc
WARNING: negative rEnd: -203 chr1:133186415-133186749 L1MCc
WARNING: negative rEnd: -455 chr1:171379505-171379760 L1M3e
WARNING: negative rEnd: -17 chr1:216018086-216018189 L1MCb
WARNING: negative rEnd: -198 chr1:226920721-226920777 L1M4
WARNING: negative rEnd: -131 chr1:226921141-226921200 L1M4
WARNING: negative rEnd: -3 chr1:226921979-226922094 L1M4
WARNING: negative rEnd: -335 chr1:227071405-227071650 L1MCc
WARNING: negative rEnd: -278 chr2:16216076-16216253 L1P4b
WARNING: negative rEnd: -72 chr2:18621605-18622180 L1PBa
WARNING: negative rEnd: -285 chr2:24878971-24879214 L1MCc
WARNING: negative rEnd: -419 chr2:25206834-25207017 L1MCc
WARNING: negative rEnd: -183 chr2:25207033-25207203 L1MCc
WARNING: negative rEnd: -3 chr2:48529930-48529991 MER6
WARNING: negative rEnd: -426 chr2:80341345-80341639 L1M2c
WARNING: negative rEnd: -314 chr2:82400541-82400763 L1MDa
WARNING: negative rEnd: -1015 chr2:82731009-82731348 L1ME1
WARNING: negative rEnd: -282 chr2:82731554-82731973 L1ME1
WARNING: negative rEnd: -129 chr2:113802567-113802946 L1MCc
WARNING: negative rEnd: -528 chr2:129549508-129549693 L1M3e
WARNING: negative rEnd: -437 chr2:160075806-160076108 L1M2
WARNING: negative rEnd: -21 chr3:39033062-39033110 MER6
WARNING: negative rEnd: -271 chr3:58615645-58615852 L1MEb
WARNING: negative rEnd: -202 chr3:70911642-70911963 L1M5
WARNING: negative rEnd: -33 chr3:71817441-71818111 L1M3e
WARNING: negative rEnd: -316 chr3:112797698-112798023 L1PB3
WARNING: negative rEnd: -17 chr3:113476319-113476407 FRAM
WARNING: negative rEnd: -27 chr3:116802770-116802992 L1MB7
WARNING: negative rEnd: -4 chr3:126585635-126585722 FRAM
WARNING: negative rEnd: -632 chr3:183268961-183269045 L1M3b
WARNING: negative rEnd: -1132 chr4:16324742-16324819 L1MEb
WARNING: negative rEnd: -930 chr4:38188841-38189000 L1MEd
WARNING: negative rEnd: -448 chr4:122440460-122440750 L1M3e
WARNING: negative rEnd: -39 chr5:7580689-7581026 L1MEe
WARNING: negative rEnd: -1956 chr5:27414234-27414442 L1MB8
WARNING: negative rEnd: -1682 chr5:27414453-27414671 L1MB8
WARNING: negative rEnd: -513 chr5:66093155-66093311 L1M4b
WARNING: negative rEnd: -35 chr5:97364737-97364827 L1MCa
WARNING: negative rEnd: -1077 chr5:109355971-109356130 L1MEb
WARNING: negative rEnd: -20 chr5:109357351-109357727 L1MEb
WARNING: negative rEnd: -102 chr5:119072794-119072945 L1MB4
WARNING: negative rEnd: -9 chr5:144123391-144123455 L1M3de
WARNING: negative rEnd: -59 chr5:150681576-150681827 L1M4c
WARNING: negative rEnd: -461 chr5:170348753-170349060 L1M3e
WARNING: negative rEnd: -138 chr5:170614438-170615156 L1M1
WARNING: negative rEnd: -103 chr5:180911655-180912016 L1MEd
WARNING: negative rEnd: -38 chr5:181275921-181276086 L1M4
WARNING: negative rEnd: -219 chr6:326885-327048 L1MCc
WARNING: negative rEnd: -243 chr6:18237822-18238057 L1MC
WARNING: negative rEnd: -458 chr6:24563135-24563511 L1M4b
WARNING: negative rEnd: -14 chr6:27838867-27838984 MLT2B4
WARNING: negative rEnd: -92 chr6:33082868-33082962 L1M4
WARNING: negative rEnd: -505 chr6:60951240-60951389 L1PB3
WARNING: negative rEnd: -9 chr6:76795983-76796095 MLT2B4
WARNING: negative rEnd: -1039 chr6:153171051-153171255 L1MEb
WARNING: negative rEnd: -448 chr6:156038512-156038675 L1M4b
WARNING: negative rEnd: -1797 chr6:172500974-172501240 L1M4b
WARNING: negative rEnd: -717 chr7:6530435-6530561 L1M4b
WARNING: negative rEnd: -180 chr7:6530567-6530816 L1M4b
WARNING: negative rEnd: -395 chr7:17573119-17573355 L1M4b
WARNING: negative rEnd: -713 chr7:34841140-34841243 L1PA12
WARNING: negative rEnd: -917 chr7:36602478-36602794 L1MEd
WARNING: negative rEnd: -993 chr7:49724690-49725009 L1MEc
WARNING: negative rEnd: -519 chr7:64924143-64924287 L1PA15-16
WARNING: negative rEnd: -170 chr7:64924684-64924986 L1PA15-16
WARNING: negative rEnd: -1526 chr7:130257854-130258027 L1MDa
WARNING: negative rEnd: -78 chr8:18037533-18037781 L1M3e
WARNING: negative rEnd: -643 chr8:25868692-25868877 L1MCc
WARNING: negative rEnd: -5 chr8:37458013-37458057 FRAM
WARNING: negative rEnd: -420 chr8:40430422-40430587 L1MCc
WARNING: negative rEnd: -73 chr8:53713425-53713503 MLT2B4
WARNING: negative rEnd: -38 chr8:58045714-58046896 L1MEd
WARNING: negative rEnd: -46 chr8:70060490-70060930 L1M4
WARNING: negative rEnd: -3 chr8:71535410-71535460 FRAM
WARNING: negative rEnd: -781 chr8:71840470-71840637 L1MCc
WARNING: negative rEnd: -613 chr8:71841566-71841717 L1MCc
WARNING: negative rEnd: -17 chr9:17870182-17870240 FRAM
WARNING: negative rEnd: -1077 chr9:36754551-36754681 L1MEb
WARNING: negative rEnd: -354 chr9:36754801-36755003 L1MEb
WARNING: negative rEnd: -189 chr9:53706555-53706958 L1MCc
WARNING: negative rEnd: -28 chr9:55631220-55631257 MER6
WARNING: negative rEnd: -259 chr9:83699632-83700159 L1MA4A
WARNING: negative rEnd: -412 chr10:93305328-93305380 L1MDb
WARNING: negative rEnd: -290 chr10:93305684-93305806 L1MDb
WARNING: negative rEnd: -232 chr11:93725539-93725691 L1MCc
WARNING: negative rEnd: -3 chr11:102814963-102815011 FRAM
WARNING: negative rEnd: -614 chr12:24319914-24321380 L1M4b
WARNING: negative rEnd: -557 chr12:24323027-24323094 L1M4b
WARNING: negative rEnd: -259 chr12:100959333-100959494 L1M1
WARNING: negative rEnd: -529 chr12:102350218-102350466 L1M2
WARNING: negative rEnd: -654 chr13:53814747-53815048 L1M4b
WARNING: negative rEnd: -7 chr13:58060931-58061578 L1M4c
WARNING: negative rEnd: -1125 chr13:72166501-72166711 L1ME1
WARNING: negative rEnd: -6 chr13:72540001-72540050 FRAM
WARNING: negative rEnd: -397 chr13:82523197-82523664 L1M3e
WARNING: negative rEnd: -119 chr13:120528068-120528107 MLT2B3
WARNING: negative rEnd: -1934 chr14:27100172-27100323 L1MCc
WARNING: negative rEnd: -158 chr14:27101192-27101535 L1MCc
WARNING: negative rEnd: -281 chr14:60812899-60813046 L1MDa
WARNING: negative rEnd: -376 chr15:22274805-22275047 L1M4b
WARNING: negative rEnd: -669 chr15:23733251-23733307 L1M3e
WARNING: negative rEnd: -422 chr15:24246692-24246910 L1MCc
WARNING: negative rEnd: -290 chr15:24247095-24247225 L1MCc
WARNING: negative rEnd: -252 chr15:24247564-24247617 L1MCc
WARNING: negative rEnd: -11 chr15:24247667-24247964 L1MCc
WARNING: negative rEnd: -261 chr15:77304256-77304526 L1M4c
WARNING: negative rEnd: -121 chr15:80339141-80339347 L1M4b
WARNING: negative rEnd: -488 chr15:83773572-83773877 L1MEd
WARNING: negative rEnd: -101 chr15:83773914-83774074 L1MEd
WARNING: negative rEnd: -92 chr16:40096072-40096144 MLT2B4
WARNING: negative rEnd: -76 chr17:44749449-44749518 MLT2B4
WARNING: negative rEnd: -97 chr17:85835577-85836019 L1MCc
WARNING: negative rEnd: -112 chr18:12965293-12965685 L1MCc
WARNING: negative rEnd: -879 chr18:41292895-41293389 L1MEc
WARNING: negative rEnd: -322 chr18:41294544-41295033 L1MEc
WARNING: negative rEnd: -1137 chr18:59335523-59335630 L1MEb
WARNING: negative rEnd: -102 chr19:5934741-5934887 L1M4
WARNING: negative rEnd: -6 chr19:11007926-11008075 FRAM
WARNING: negative rEnd: -24 chr19:44501149-44501305 L1M3b
WARNING: negative rEnd: -145 chr20:45957350-45957401 L1MDa
WARNING: negative rEnd: -1106 chr20:74584188-74584318 L1ME1
WARNING: negative rEnd: -348 chr20:74584451-74584806 L1ME1
WARNING: negative rEnd: -711 chr20:80285832-80285915 L1MCc
WARNING: negative rEnd: -37 chrX:4743643-4743679 MER6
WARNING: negative rEnd: -1941 chrX:48147060-48147184 L1M4b
WARNING: negative rEnd: -99 chrX:54535186-54535349 L1M4
WARNING: negative rEnd: -606 chrX:80315181-80315657 L1P4b
WARNING: negative rEnd: -65 chrX:97720783-97720963 L1M4
WARNING: negative rEnd: -24 chrX:120523759-120523982 L1ME1
WARNING: negative rEnd: -13 chrX:121193467-121193615 MLT2B4
WARNING: negative rEnd: -939 chrX:153527918-153528288 L1M4

  # matches select count(*) from rmsk where repEnd < 0;
+----------+
| count(*) |
+----------+
|      131 |
+----------+

  /cluster/bin/i386/maskOutFa -softAdd rheMac2.softmask.fa bed/simpleRepeat/simpleRepeat.bed rheMac2.softmask2.fa

  # hard masking (Ns instead of lower case) for download files
  # split for use by genscan
  /cluster/bin/i386/maskOutFa rheMac2.softmask2.fa hard rheMac2.hardmask.fa
  mkdir hardmask-split
  /cluster/bin/i386/faSplit about rheMac2.hardmask.fa 2000000 hardmask-split

# DOWNLOAD FILES

  ssh hgwdev
  cd /cluster/data/rheMac2
  cp rheMac2.softmask.fa /usr/local/apache/htdocs/goldenPath/rheMac2/bigZips
  cp rheMac2.softmask2.fa /usr/local/apache/htdocs/goldenPath/rheMac2/bigZips
  cp rheMac2.hardmask.fa /usr/local/apache/htdocs/goldenPath/rheMac2/bigZips

  cd /usr/local/apache/htdocs/goldenPath/rheMac2/bigZips
  nice gzip rheMac2.softmask.fa
  nice gzip rheMac2.softmask2.fa
  nice gzip rheMac2.hardmask.fa

# REGENERATE 2BIT NIB (DONE Jan 30, 2006 Robert)
  ssh kkstore02
  cd /cluster/data/rheMac2
  /cluster/bin/i386/faToTwoBit rheMac2.softmask2.fa rheMac2.softmask.2bit
  /cluster/bin/i386/twoBitToFa rheMac2.softmask.2bit check.softmask.fa
  diff -q rheMac2.softmask2.fa check.softmask.fa
  mv rheMac2.2bit rheMac2.2bit.unmasked
  mv rheMac2.softmask.2bit rheMac2.2bit
  # note: size match

# GENERATE 2bit for blastz 
  mkdir -p /san/sanvol1/scratch/rheMac2/ 
  cd /cluster/data/rheMac2
  cp rheMac2.2bit /san/sanvol1/scratch/rheMac2/ -p


ssh kkstore02
cd /cluster/data/hg17/bed/blastz.rheMac2
# edit doBlastzChainNet.pl to add lines for hg17 glitch
# in function getDbFromPath
#  if ($db eq "hg") {
#      $db = "hg17";
#  }
#doBlastzChainNet.pl DEF -blastzOutRoot /san/sanvol1/scratch/rheMac2/rheMacOut/ >& do.log &

############################################################################
##  BLASTZ swap from mm8 alignments (DONE - 2006-02-18 - Hiram)
    ssh pk
    cd /cluster/data/mm8/bed/blastz.rheMac2.2006-02-17
    time /cluster/bin/scripts/doBlastzChainNet.pl -verbose=2 \
        -swap -bigClusterHub=pk -chainMinScore=3000 -chainLinearGap=medium \
        `pwd`/DEF > swap.out 2>&1 &
    time /cluster/bin/scripts/doBlastzChainNet.pl -verbose=2 \
        -bigClusterHub=pk -chainMinScore=3000 -chainLinearGap=medium \
        -swap -continue=net `pwd`/DEF > swap.net.out 2>&1 &
    #   failed during a san hiccup,  finish that off, then:
    time /cluster/bin/scripts/doBlastzChainNet.pl -verbose=2 \
        -bigClusterHub=pk -chainMinScore=3000 -chainLinearGap=medium \
        -swap -continue=load `pwd`/DEF > swap.load.out 2>&1 &

    time nice -n +19 featureBits rheMac2 chainMm8Link
    #   877906099 bases of 2646704109 (33.170%) in intersection

    #	This was done before the loadUp script was improved to load
    #	empty tables on chroms that have no chains, so sometime later:
    ssh hgwdev
    hgLoadChain rheMac2 chrUr_chainMm8 /dev/null
    #	Loading 0 chains into rheMac2.chrUr_chainMm8
    #	2006-04-24

############################################################################
# QUALITY SCORES (Done March 9, 2006 Robert)
    ssh kkstore01
    wget -q ftp://macftp:analysis@ftp.macaquegenome.hgsc.bcm.tmc.edu:21/Assemblies/VI/FinalMergeSplit/v1.edit4.chrm.qv.bz2
    cd /cluster/data/rheMac2/downloads/
    bunzip2 v1.edit4.chrm.qv.bz2 &
    bunzip2 v1.edit4.chrUr.bz2 &
    nice fold --spaces v1.edit4.chrm.qv | sed -e 's/Chr/chr/' > rheMac2.chrm.qual.qv 
    nice fold --spaces v1.edit4.chrUr.qv | sed -e 's/Chr/chr/' > rheMac2.chrUr.qv 
    cat rheMac2.chrm.qual.qv rheMac2.chrUr.qv > rheMac2.qual.qv
    qaToQac rheMac2.qual.qv temp.qac 
    gzip rheMac2.qual.qv
    qacToWig -fixed temp.qac rheMac2.wig 
    rm temp.qac
    wigEncode rheMac2.wig rheMac2.qual.wig rheMac2.qual.wib 
    mv all.qv rheMac2.qual.qv
    qaToQac rheMac2.qual.qv temp.qac
    qacToWig -fixed temp.qac rheMac2.wig
    wigEncode rheMac2.wig rheMac2.qual.wig rheMac2.qual.wib
    ssh hgwdev
    hgLoadWiggle rheMac2 quality rheMac2.qual.wig
    cp -p rheMac2.qual.qv.gz /usr/local/apache/htdocs/rheMac2/bigZips


# RUN DATEREPEATS TO GET LINEAGE-SPECIFIC (DONE 3/22/06 angie)
    ssh kkstore01
    cd /cluster/data/rheMac2

    # First make per-chrom .fa.out files as should have been done:
    tail +4 repeats/repeat.out \
    | perl -we '$prevChr = ""; \
                while (<>) { \
                  @w = split; $chr = $w[4]; $c = $chr; $c =~ s/^chr//; \
                  if ($chr ne $prevChr) { \
                    print "creating $c/$chr.fa.out\n"; \
                    system("cat repeats/repeats.header > $c/$chr.fa.out"); \
                    close(OUT);  open(OUT, ">>$c/$chr.fa.out") || die; \
                  } \
                  print OUT; \
                  $prevChr = $chr; \
                }'

    # Run DateRepeats to get outputs on rodent, non-rodent mammal:
    mkdir linSpecRep
    cd linSpecRep
    ln -s ../*/chr*.fa.out .
    foreach f (*.fa.out)
      echo $f:r:r
      /cluster/bluearc/RepeatMasker/DateRepeats $f -query human \
        -comp mouse -comp dog
    end
    mkdir /cluster/bluearc/rheMac2/linSpecRep
    mkdir /cluster/bluearc/rheMac2/linSpecRep/notIn{Rodent,NonRodentMammal}
    foreach f (*.out_mus*)
      set chr = $f:r:r
      echo $chr
      /cluster/bin/scripts/extractRepeats 1 $f \
       > /cluster/bluearc/rheMac2/linSpecRep/notInRodent/$chr.out.spec
      /cluster/bin/scripts/extractRepeats 2 $f \
       > /cluster/bluearc/rheMac2/linSpecRep/notInNonRodentMammal/$chr.out.spec
    end


# BLASTZ SWAP FOR HUMAN (hg17) (DONE, 2006-03-22, hartera)
# CREATE CHAIN AND NET TRACKS, AXTNET, MAFNET, LIFTOVER AND ALIGNMENT DOWNLOADS
    # Documented in makeHg17.doc in the section:
    # SWAP CHAIN AND NET ALIGNMENTS OVER TO RHESUS (rheMac2)
    # alignments are in: /cluster/data/rheMac2/bed/blastz.hg17.swap


# SWAP CHAINS/NET RN4 (DONE 3/23/06 angie)
    ssh kkstore01
    mkdir /cluster/data/rheMac2/bed/blastz.rn4.swap
    cd /cluster/data/rheMac2/bed/blastz.rn4.swap
    doBlastzChainNet.pl -swap /cluster/data/rn4/bed/blastz.rheMac2/DEF \
      >& do.log & tail -f do.log
    ln -s blastz.rn4.swap /cluster/data/rheMac2/bed/blastz.rn4


