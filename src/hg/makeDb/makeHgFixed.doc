#This describes how at least some of the tables in
#hgFixed were created.  This is a database containing
#primarily expression data.  There are two main formats:
#  expRecord.as - This describes the mRNA sources for
#     a series of microarray experiments 
#  expData.as - This describes the measured value 
#     in either absolute or relative ratio terms of
#     each gene/probe/target in a series of microarray
#     experiments.  Each expData is associated with
#     an expRecord, thogh expDatas sometimes share
#     the same expRecord.

#The Human Affy GNF Expression Atlas 2003 Version:
# Create the main expRecord table and the expData table for
# the absolute measurements as so:
hgGnfMicroarray gnfHumanU95AllExps gnfHumanU95All /projects/compbio/data/microarray/affyGnfHuman/data_public_U95
# Convert these to ratios using the median of medians of non-cancerous
# cell types as the denominator as so:
cd ~/src/hg/makDb/hgRatioMicroarray
hgRatioMicroarray gnfHumanU95All gnfHumanU95AllRatio -clump=gnfClump.ra
# Take the median value over multiple replicants and put in this table:
cd ../hgMedianMicroarray
hgMedianMicroarray hgFixed gnfHumanU95AllRatio gnfHumanU95AllExps gnfU95Median.ra gnfHumanU95MedianRatio gnfHumanU95MedianExps -minExps=1
# Also make a median version of the absolute measurements
hgMedianMicroarray hgFixed gnfHumanU95All gnfHumanU95AllExps gnfU95Median.ra gnfHumanU95Median gnfHumanU95MedianExps -minExps=1

# The Mouse Affy GNF Expression Atlas:
# Create the expRecord tables for U74 a/b/c and the expData table for
# the absolute measurements:
hgGnfMicroarray gnfMouseU74aAllExps gnfMouseU74aAll /projects/compbio/data/microarray/affyGnfMouse/data/data_public_U74
hgGnfMicroarray gnfMouseU74bAllExps gnfMouseU74bAll /projects/compbio/data/microarray/affyGnfMouse/data/U74B_b.txt
hgGnfMicroarray gnfMouseU74cAllExps gnfMouseU74cAll /projects/compbio/data/microarray/affyGnfMouse/data/U74C_b.txt
# Convert these to ratios using the median of medians of 
# cell types as the denominator as so:

cd ~/src/hg/makeDb/hgRatioMicroarray
hgRatioMicroarray gnfMouseU74aAll gnfMouseU74aAllRatio -clump=gnfMouseU74aClump.ra
hgRatioMicroarray gnfMouseU74bAll gnfMouseU74bAllRatio -clump=gnfMouseU74bClump.ra
hgRatioMicroarray gnfMouseU74cAll gnfMouseU74cAllRatio -clump=gnfMouseU74cClump.ra
# Take the median value over multiple replicants and put in this table:
cd ../hgMedianMicroarray
hgMedianMicroarray hgFixed gnfMouseU74aAllRatio gnfMouseU74aAllExps gnfMouseU74aMedian.ra gnfMouseU74aMedianRatio gnfMouseU74aMedianExps -minExps=1
hgMedianMicroarray hgFixed gnfMouseU74bAllRatio gnfMouseU74bAllExps gnfMouseU74bMedian.ra gnfMouseU74bMedianRatio gnfMouseU74bMedianExps -minExps=1
hgMedianMicroarray hgFixed gnfMouseU74cAllRatio gnfMouseU74cAllExps gnfMouseU74cMedian.ra gnfMouseU74cMedianRatio gnfMouseU74cMedianExps -minExps=1
# Also make a median version of the absolute measurements
hgMedianMicroarray hgFixed gnfMouseU74aAll gnfMouseU74aAllExps gnfMouseU74aMedian.ra gnfMouseU74aMedian gnfMouseU74aMedianExps -minExps=1
hgMedianMicroarray hgFixed gnfMouseU74bAll gnfMouseU74bAllExps gnfMouseU74bMedian.ra gnfMouseU74bMedian gnfMouseU74bMedianExps -minExps=1
hgMedianMicroarray hgFixed gnfMouseU74cAll gnfMouseU74cAllExps gnfMouseU74cMedian.ra gnfMouseU74cMedian gnfMouseU74cMedianExps -minExps=1


#The Human GNF Expression Atlas 2 (2004)
#
# Create the main expRecord table and the expData table for
# the absolute measurements as so:
hgGnfMicroarray gnfHumanAtlas2AllExps gnfHumanAtlas2All /projects/compbio/data/microarray/geneAtlas2/human/U133A+GNF1B_101402.AD.txt -chip=U133A+GNF1B
# Convert these to ratios using the median of medians of non-cancerous
# cell types as the denominator as so:
cd ~/src/hg/makeDb/hgRatioMicroarray
hgRatioMicroarray gnfHumanAtlas2All gnfHumanAtlas2AllRatio -clump=gnfHumanAtlas2Clumps.ra
# Take the median value over multiple replicants and put in this table:
cd ../hgMedianMicroarray
hgMedianMicroarray hgFixed gnfHumanAtlas2AllRatio gnfHumanAtlas2AllExps gnfHumanAtlas2.ra gnfHumanAtlas2MedianRatio gnfHumanAtlas2MedianExps -minExps=1
# Also make a median version of the absolute measurements
hgMedianMicroarray hgFixed gnfHumanAtlas2All gnfHumanAtlas2AllExps gnfHumanAtlas2.ra gnfHumanAtlas2Median gnfHumanAtlas2MedianExps -minExps=1

#The Mouse GNF Expression Atlas 2 (2004)
# Create the main expRecord table and the expData table for
# the absolute measurements as so:
hgGnfMicroarray gnfMouseAtlas2AllExps gnfMouseAtlas2All /projects/compbio/data/microarray/geneAtlas2/mouse/GNF1M_20030403.AD.txt -chip=GNF1M
# Convert these to ratios using the median of medians of non-cancerous
# cell types as the denominator as so:
cd ~/src/hg/makeDb/hgRatioMicroarray
hgRatioMicroarray gnfMouseAtlas2All gnfMouseAtlas2AllRatio -clump=../hgMedianMicroarray/gnfMouseAtlas2.ra
# Take the median value over multiple replicants and put in this table:
cd ../hgMedianMicroarray
hgMedianMicroarray hgFixed gnfMouseAtlas2AllRatio gnfMouseAtlas2AllExps gnfMouseAtlas2.ra gnfMouseAtlas2MedianRatio gnfMouseAtlas2MedianExps -minExps=1
# Also make a median version of the absolute measurements
hgMedianMicroarray hgFixed gnfMouseAtlas2All gnfMouseAtlas2AllExps gnfMouseAtlas2.ra gnfMouseAtlas2Median gnfMouseAtlas2MedianExps -minExps=1

#The Rat GNF Expression Atlas 2 (2004)
# Create the main expRecord table and the expData table for
# the absolute measurements as so:
hgGnfMicroarray gnfRatAtlas2AllExps gnfRatAtlas2All /projects/compbio/data/microarray/geneAtlas2/rat/PivotNoApwithTissues.txt -chip=RG-U34A -ref=http://expression.gnf.org/ratlas
# Convert these to ratios using the median of medians of non-cancerous
# tissues or cell types (in this case, this is all the tissues) as the 
# denominator as so:
cd ~/src/hg/makeDb/hgRatioMicroarray
hgRatioMicroarray gnfRatAtlas2All gnfRatAtlas2AllRatio -clump=gnfRatAtlas2Clumps.ra
# Take the median value over multiple replicants and put in this table.
# Use Clumps.ra file renamed as gnfRatAtlas2.ra as this contains all the 
# tissues since there are no cancer tissues in this expression data set:
cd ../hgMedianMicroarray
hgMedianMicroarray hgFixed gnfRatAtlas2AllRatio gnfRatAtlas2AllExps gnfRatAtlas2.ra gnfRatAtlas2MedianRatio gnfRatAtlas2MedianExps -minExps=1
# Also make a median version of the absolute measurements
hgMedianMicroarray hgFixed gnfRatAtlas2All gnfRatAtlas2AllExps gnfRatAtlas2.ra gnfRatAtlas2Median gnfRatAtlas2MedianExps -minExps=1

# C. elegans life cycle data from the Kim Lab via the Stanford Microarray Database.
cd ~/kent/src/hg/makeDb/hgStanfordMicroarray
hgStanfordMicroarray hgFixed kimWormLifeAllRatio kimWormLifeAllExps /projects/compbio/data/microarray/wormLifeCycle/spots -swap '-trimName=(green)' -suppress=green '-trimTissue=(repeat #?)'
cd ../hgMedianMicroarray
hgMedianMicroarray hgFixed kimWormLifeAllRatio kimWormLifeAllExps kimMed.ra kimWormLifeMedianRatio kimWormLifeMedianExps

# D. melanogaster life cycle data from Arbeitman et al 2002 
# via the Stanford Microarray Database.
cd ~/kent/src/hg/makeDb/hgStanfordMicroarray
# absolute:
hgStanfordMicroarray -geneField="Systematic name" -dataField=CH2I_MEDIAN \
  hgFixed arbFlyLifeAll arbFlyLifeAllExps \
  /projects/compbio/data/microarray/flyLifeCycle/spots
# ratios:
hgStanfordMicroarray -geneField="Systematic name" \
  hgFixed arbFlyLifeAllRatio arbFlyLifeAllExps \
  /projects/compbio/data/microarray/flyLifeCycle/spots
cd ../hgMedianMicroarray
echo "select name,id from arbFlyLifeAllExps" | hgsql -N hgFixed  \
  | sort > arbMed.ra
# edit arbMed.ra to collapse the N=1, N=2 lines.
# median absolute:
hgMedianMicroarray hgFixed arbFlyLifeAll arbFlyLifeAllExps arbMed.ra \
  arbFlyLifeMedian arbFlyLifeMedianExps
# median ratios:
hgMedianMicroarray hgFixed arbFlyLifeAllRatio arbFlyLifeAllExps arbMed.ra \
  arbFlyLifeMedianRatio arbFlyLifeMedianExps
# cvs add and check in arbMed.ra

# The scopDes table, which is used by the SuperFamily column in hgNear.
mkdir /cluster/store1/scop
cd /cluster/store1/scop
wget http://scop.mrc-lmb.cam.ac.uk/scop/parse/dir.des.scop.txt_1.63
grep -v '^#' dir.des.scop.txt* > scopDes.txt
hgsql hgFixed < ~/kent/src/hg/lib/scopDes.sql
echo "load data local infile 'scopDes.txt' into table scopDes;" | hgsql hgFixed

# The Yeast Cell Cycle Time Course from Cho RJ et al 1998
cd /cluster/data/sacCer1/download/systematic_results/expression_data
hgGnfMicroarray yeastChoCellCycleExps yeastChoCellCycle  \
	Cho_et_al_full_data.txt -chip=affyYeast \
	-chopName=/ \
	-url=http://yscdp.stanford.edu/yeast_cell_cycle/cellcycle.html \
	-ref=http://www.pnas.org/cgi/content/abstract/95/7/3752 \
	-credit=http://yscdp.stanford.edu/yeast_cell_cycle/cellcycle.html
cd ~/src/hg/makeDb/hgRatioMicroarray
hgRatioMicroarray yeastChoCellCycle yeastChoCellCycleRatio

# Mouse expression data by sex on Affy MOE430A arrays from
# John Rinn (john.rinn@yale.edu) et al.
cd /projects/compbio/data/microarray/rinnEtAl
hgGnfMicroarray mouseRinnSexExps mouseRinnSex rinnEtAlSpots.txt \
    -chip=MOE430A \
    -url=n/a \
    -ref=n/a \
    -credit=n/a
cd ~/kent/src/hg/makeDb/hgRatioMicroarray 
hgRatioMicroarray mouseRinnSex mouseRinnSexRatio
cd ~/kent/src/hg/makeDb/hgMedianMicroarray 
hgMedianMicroarray hgFixed mouseRinnSex mouseRinnSexExps mouseRinnSex.ra mouseRinnSexMedian mouseRinnSexMedianExps
hgMedianMicroarray hgFixed mouseRinnSexRatio mouseRinnSexExps mouseRinnSex.ra mouseRinnSexMedianRatio mouseRinnSexMedianExps

# D. melanogaster full euchromatic expression profile (FEEP) -- 
# Stolc et al. 2004.  
1# Loaded up absolute tables directly from files downloaded from 
# http://genome.med.yale.edu/FEEP/FEEP.html --
# see /projects/compbio/data/microarray/flyFEEP/README .
# Extract ratio from absolute:
hgRatioMicroarray flyFeepAll flyFeepAllRatio
cd ~/kent/src/hg/makeDb/hgMedianMicroarray
echo "select description,id from flyFeepAllExps" | hgsql -N hgFixed  \
  | sort > flyFeepMed.ra
# edit flyFeepMed.ra to collapse lines with the same initial character.
# median absolute:
hgMedianMicroarray hgFixed flyFeepAll flyFeepAllExps flyFeepMed.ra \
  flyFeepMedian flyFeepMedianExps
# median ratios:
hgMedianMicroarray hgFixed flyFeepAllRatio flyFeepAllExps flyFeepMed.ra \
  flyFeepMedianRatio flyFeepMedianExps
# cvs add and check in flyFeepMed.ra

# Human data from Shyamsundar R, et al. (2005) Genome Biol 6(3):R22
mkdir -p /projects/compbio/data/microarray/shyamsundarEtAl
cd /projects/compbio/data/microarray/shyamsundarEtAl
wget ftp://smd-ftp.stanford.edu/smd/publications/426/3130/exptsetno_3130.tar.gz
wget ftp://smd-ftp.stanford.edu/smd/publications/426/3130/exptset_3130.meta
tar xfz exptsetno_3130.tar.gz
rm exptsetno_3130.tar.gz
mkdir spots
cat << _EOF_ > cleanXls.awk
{ 
  if (/^!/) 
     {
     line = \$0
     gsub(/\"|,/, "", line)
     print line
     }
   else
     print
}
_EOF_
for file in *.xls; do
   awk -f cleanXls.awk $file > spots/$file
done
cd ~/kent/src/hg/makeDb/hgMedianMicroarray
# The hgFixed.history doesn't have the errata column
echo alter table history add column errata varchar(255) | hgsql hgFixed
hgStanfordMicroarray -dataField="Normalized Ch2 Intensity (Median)" \
  hgFixed humanNormal humanNormalExps /projects/compbio/data/microarray/shyamsundarEtAl/spots
hgStanfordMicroarray -dataField="Log(base2) of R/G Normalized Ratio (Mean)" \
  hgFixed humanNormalRatio humanNormalExps /projects/compbio/data/microarray/shyamsundarEtAl/spots
echo "select name from humanNormalExps" | hgsql -N hgFixed | awk "{print \"\'\"\$0\"\'\"}" > col1
echo "select id from humanNormalExps" | hgsql -N hgFixed > col2
n=`wc -l < col1`
for i in `seq 1 $n`; do echo "n/a" >> col1.5; done
paste col1 col1.5 col2 | sort | tr '\t' ' ' > humanNormal.ra
rm col1 col1.5 col2
# EDIT humanNormal.ra by hand and combine the like tissues
hgMedianMicroarray -minExps=1 hgFixed humanNormal humanNormalExps humanNormal.ra \
  humanNormalMedian humanNormalMedianExps
hgMedianMicroarray -minExps=1 hgFixed humanNormalRatio humanNormalExps humanNormal.ra \
  humanNormalMedianRatio humanNormalMedianExps

# (copy/paste this into columnDb.ra)

# Mouse data from Zhang, et. al The functional landscape of mouse gene expression" J Biol. 
# http://hugheslab.med.utoronto.ca/Zhang/
mkdir -p /cluster/store2/microarray
ln -s /cluster/store2/microarray /cluster/data/microarray
mkdir -p /cluster/data/microarray/zhangEtAl
cd /cluster/data/microarray/zhangEtAl
wget http://hugheslab.med.utoronto.ca/Zhang/expression_39309_normalized.txt
sed 's/\(XM_[0-9]\+\)\.1/\1/' expression_39309_normalized.txt > arrays.txt
hgGenericMicroarray hgFixed mouseLandscape arrays.txt
wget http://hugheslab.med.utoronto.ca/Zhang/mouse_XM_mRNA_NCBI_2.fa
sed 's/^>.*|\(XM.*\)\.1|.*$/>\1/' mouse_XM_mRNA_NCBI_2.fa > xm.fa
ssh kk9
cd /santest/scratch
mkdir andy
cd andy/
cp /cluster/data/microarray/zhangEtAl/xm.fa .
ls -1 /panasas/store/mm6/nib/* | grep -v random > chroms.lst
cat << _EOF_ > gsub
#LOOP
blat -ooc=/scratch/hg/h/mouse11.ooc -fine -q=rna -noHead \$(path1) xm.fa xm.\$(root1).psl
#ENDLOOP
_EOF_
gensub2 chroms.lst single gsub spec
para create spec
para push
para time
#Completed: 22 of 22 jobs
#CPU time in finished jobs:      36298s     604.96m    10.08h    0.42d  0.001 y
#IO & Wait Time:                    91s       1.52m     0.03h    0.00d  0.000 y
#Average job time:                1654s      27.57m     0.46h    0.02d
#Longest running job:                0s       0.00m     0.00h    0.00d
#Longest finished job:            2955s      49.25m     0.82h    0.03d
#Submission to last job:          2957s      49.28m     0.82h    0.03d
cat *.psl > xm.psl
ssh hgwdev
cd /cluster/data/microarray/zhangEtAl
cp /santest/scratch/andy/xm.psl .
hgLoadPsl -table=xmMrna mm6 xm.psl
hgMapToGene -type=psl -cds mm6 xmMrna knownGene knownToXM
echo drop table xmMrna | hgsql mm6 
