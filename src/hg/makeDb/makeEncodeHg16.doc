#!/bin/csh -f
exit

# NHGRI DNASE I HYPERSENSITIVE SITES (2004-10-15 kate)
    # Data from Greg Crawford <crawford@mail.nih.gov> at the Collins Lab

    cd /cluster/data/encode/NHGRI

    set data = lab/DNaseI_HS_NHGRI_ENCODE2.txt
    sed '/^track/d' $data > DNAseHS.bed
    hgLoadBed hg16 encode_NHGRI_DNAseHS DNAseHS.bed


    # Stanford Promoters from Rick Myers lab (2004-10-17 kate)

    /cluster/data/encode/StanfordPromoters
    mkdir StanfordPromoters_20040825
    ln -s latest StanfordPromoters_20040825
    cd latest

    csh makePromoterFiles.csh > promoterExps.tab
    wc -l promoterExps.exp
        # 14

    # currently hgTracks only looks in hgFixed for the experiment table
    #  (add a trackDb option)
    hgExperiment hgFixed encode_Stanford_Promoters \
                    promoterExps.tab promoterPos.bed promoterData.tab
    hgLoadBed hg16 encode_Stanford_Promoters encode_Stanford_Promoters.tab


# UVA DNA REPLICATION TEMPORAL PROFILING (2004-10-22 kate)
    # Dutta lab (Univ. Virginia) replication data (2004-10-22 kate)
    #       Submitted as custom track, coords on hg15

    cd /cluster/data/encode/UVa
    # data (was MS-WORD)
    dos2unix lab/Dutta_Rep_profile.txt
    # documentation (ditto)
    dos2unix lab/UCSC-_data_release.txt

    # split file of customtracks into multiple files
    ./splitCustomTracks.pl lab/Dutta_Rep_profile.txt repl
    wc -l *.?-?{,?}
        # 163 repl.0-2
        # 301 repl.2-4
        # 296 repl.4-6
        # 523 repl.6-8
        # 421 repl.8-10
        # 1704 total

    wc -l lab/Dutta_Rep_profile.txt
      # 1704 lab/Dutta_Rep_profile.txt

    cat > checkEncodeTable.csh << 'EOF'
    hgsql hg16 -N -s -e "SELECT er.name, count(*) FROM encodeRegions er, $1 hs WHERE er.chrom=hs.chrom AND hs.chromStart between er.chromStart AND er.chromEnd group by er.name"
    'EOF'

    # load w/o binning to maintain ordering by chromStart
    foreach f (repl.?-?{,?})
        liftOver $f /cluster/data/hg15/bed/liftOver/hg15ToHg16.over.chain \
                    $f.hg16.bed $f.unmapped
        set time = `echo $f:e | sed 's/-/_/'`
        hgLoadBed -noBin hg16 encode_UVA_DNARep_$time $f.hg16.bed
        csh checkEncodeTable.csh encode_UVA_DNARep_$time > $time.ct
    end
    wc -l *.hg16.bed
        # 160 repl.0-2.hg16.bed
        # 298 repl.2-4.hg16.bed
        # 294 repl.4-6.hg16.bed
        # 520 repl.6-8.hg16.bed
        # 416 repl.8-10.hg16.bed
       # 1688 total
    wc -l *.unmapped
          # 0 repl.0-2.unmapped
          # 0 repl.2-4.unmapped
          # 0 repl.4-6.unmapped
          # 0 repl.6-8.unmapped
          # 0 repl.8-10.unmapped
          # 0 total
    cut -f 1 *.ct | sort | uniq > regions
    wc -l regions
     # 43 regions (1 missing)
    hgsql  hg16 -N -s -e "SELECT name from encodeRegions" | sort | diff - regions 


# UCSD CHIP/CHIP (2004-09-30 kate)
    # Bing Ren's Lab
    # Provided by Chunxu Qu [mailto:qchunxu@ucsd.edu] on Oct. 1, 2004

    # Unpack data and rename files 

    ssh kksilo
    cd /cluster/data/encode
    mkdir -p UCSD/project1
    cd UCSD/project1
    gunzip project1.tar.gz
    foreach f (*.wig)
        mv $f $f.bed
    end

    # consists of 8 custom track wiggle BED files

    ssh hgwdev
    mkdir /gbdb/hg16/encode/UCSD_ChIP/wib
    cd /cluster/data/encode/UCSD/project1
    mkdir wig
    cd wig
    cat > makeWig.csh << 'EOF'
    foreach f (../*.bed)
        # get base name
        set b = $f:t:r:r
        # strip non-informative parts of name
        set n = `echo $b | sed -e 's/ave_//' -e 's/_p//' | tr '[a-z]' '[A-Z]'`
        echo $n
        # create wiggle data files from BED
        # NOTE: wigBedToBinary has been replaced by wigEncode
        sed -e '/^browser/d' -e '/^track/d' $f | \
            wigBedToBinary stdin $n.wig $n.wib
        ln -s `pwd`/$n.wib /gbdb/hg16/encode/UCSD_ChIP/wib
        # load into database
        hgLoadWiggle hg16 encode_UCSD_ChIP_$n $n.wig \
                    -pathPrefix=/gbdb/hg16/encode/UCSD_ChIP/wib
    end
    'EOF'
    # << for emacs

    csh makeWig.csh >&! makeWig.log &
    # Converted stdin, upper limit 16.00, lower limit 0.00, etc.

    hgsql hg16 -s -e "select count(*) from encode_UCSD_ChIP_RNAP_HELA"
        # 19571

    # create entries in trackDb, default height 16 pixels
    # Use Jim's suggestion to associate a color with a cell line
         # Pol2 Hela (black)
         # Pol2 THP1 (darkish blue)
         # Pol2 IMR90 (darkish red)
         # Pol2 HCT116 (darkish green)
         # TAF1 Hela (black)
         # TAF1 THP1 (darkish blue)
         # TAF1 IMR90 (darkish red)
         # TAF1 HCT116 (darkish green)


# STANFORD MLAGAN MSA OF FREEZE2 (2004-11-17 kate)
#       From George Asimenos, Batzoglou lab (asimenos@stanford.edu)
    
    cd /cluster/data/encode
    cd MLAGAN/freeze2
    mkdir lab out tmp
    set tmpDir = /cluster/data/encode/MLAGAN/freeze2/tmp
    set outDir = /cluster/data/encode/MLAGAN/freeze2/out
    cd lab
    wget -r http://ai.stanford.edu/~asimenos/beta_encode_Nov_2004/
    mv ai.stanford.edu/*asimenos/beta* .
    rm -fr ai.stanford.edu
    cd beta_encode_Nov_2004/data
cat > makeMaf.csh << 'EOF'
    set tmpDir = /cluster/data/encode/MLAGAN/freeze2/tmp
    set outDir = /cluster/data/encode/MLAGAN/freeze2/out
    foreach r (EN*)
        echo $r
        set c = `echo "SELECT chrom from encodeRegions WHERE name='$r'" | \
                        hgsql -N hg16`
        set start =  \
                `echo "SELECT chromStart from encodeRegions WHERE name='$r'" | \
                        hgsql -N hg16`
        set size = \
                `echo "SELECT size from chromInfo WHERE chrom='$c'" | \
                        hgsql -N hg16`
        bunzip2 -c $r/$r.maf.bz2 | \
          /cluster/data/encode/MLAGAN/mafCoord.pl human hg16.$c $start $size |\
            sed 's/^a$/a score=0.0/' > $tmpDir/$r.db.maf
        /cluster/bin/penn/maf_project $tmpDir/$r.db.maf hg16.$c \
                        > $outDir/$r.human.maf
    end
'EOF'
    csh makeMaf.csh >&! makeMaf.log &

    mkdir /gbdb/hg16/encode_MSA2_MLAGAN
    ln -s $outDir/*.human.maf /gbdb/hg16/encode_MSA2_MLAGAN
    hgLoadMaf -WARN hg16 encode_MSA2_MLAGAN

    # create description page from lab/index.html


# AFFY TRANSCRIPTION AND CHIP/CHIP TEMPORAL PROFILING (WORKING 2004-11-18 kate)

    # HL60 cells stimulated with Retinoic Acid
    # Transcription and PolII ChIP/Chip at 4 timepoints (8 experiments)
    # wig & bed for each experiment 
    # filenames: EC_HL60_RA_RNA_00hr_AS.hs.NCBIv34.{bed,wig}
    #            EC_HL60_RA_RNApol2_00hr_AS_b.hs.NCBIv34.{bed,wig}
    # Use these to construct 16 tracks:
    # track encode_Affy_RNA_RA_HL60_{0,2,8,32}
    # track encode_Affy_ChIP_RNAP_RA_HL60_{0,2,8,32}
    # RNA/Affy HL60 0hr
    # ChIP/Affy Pol2 0hr

    cd /cluster/data/encode
    mkdir -p Affy/Nov08_2004
    mkdir -p /gbdb/hg16/encode/Affy_Nov04/wib
    cd Affy/Nov08_2004
    wget http://transcriptome.affymetrix.com/download/ENCODE/ucsc_formats.tar.bz2
    bunzip2 ucsc_formats.tar.bz2
    tar xvf ucsc_formats.tar
    cd ucsc_formats
cat > load.csh << 'EOF'
    foreach f (bed/*.bed)
        set base = $f:t:r
        set info = `echo $f:t | sed 's/EC_HL60_RA_\([^_][^_]*\)_\([0-9][0-9]*\)hr.*/\1.\2/'`
        set hrs = `expr $info:e + 0`
        set exp = `echo $info:r |  \
                        sed -e 's/RNApol2/ChIP_RNAP/'`
        set track = encode_Affy_${exp}_RA_HL60_$hrs
        sed '1d' $f | \
            hgLoadBed -noBin hg16 $track stdin
        set ct = `hgsql -N -s -e "select count(*) from $track" hg16`
        echo "track $track"
        echo "$f:t	$ct"
        sed '/^track/d' wig/$base.wig | wigEncode stdin $track.wig $track.wib
        ln -s `pwd`/$track.wib /gbdb/hg16/encode/Affy_Nov04/wib
        # load into database
        hgLoadWiggle hg16 ${track}_wig $track.wig \
                    -pathPrefix=/gbdb/hg16/encode/Affy_Nov04/wib
    end
'EOF'
    # << for emacs
    csh load.csh >&! load.log &
    grep EC_HL60 | grep -v wig load.log > loaded.txt
    # email loaded.txt to contributor
    awk '{print $1}' *.bed | sort | uniq > chroms.txt
    # use in trackDb chromosomes setting
    grep encode_Affy load.log > trackDb.ra
    # use as basis of hg16 trackDb entries


# AFFY TRANSCRIPTION AND CHIP/CHIP TEMPORAL PROFILING (2004-12-08 kate)

    # HL60 cells stimulated with Retinoic Acid
    # Transcription and PolII ChIP/Chip at 4 timepoints (8 experiments)
    # wig & bed for each experiment 
    # filenames: EC_HL60_RA_RNA_00hr_AS.hs.NCBIv34.{bed,wig}
    #            EC_HL60_RA_RNApol2_00hr_AS_b.hs.NCBIv34.{bed,wig}
    # Use these to construct 16 tracks:
    # track encodeAffyRnaHl60Hr{00,02,08,32}
    # track encodeAffyChIpRnapHl60Hr{00,02,08,32}
    # RNA/Affy HL60 0hr
    # ChIP/Affy Pol2 0hr

    mkdir -p /gbdb/hg16/encode/Affy/2004-12-03/wib
    cd /cluster/data/encode
    mkdir -p Affy/Dec03_2004
    cd Affy/Dec03_2004
    wget http://transcriptome.affymetrix.com/download/ENCODE/ucsc_formats.tar.bz2
    bunzip2 ucsc_formats.tar.bz2
        # trailing garbage after EOF ignored
    tar xvf ucsc_formats.tar
    # NOTE: the script below creates $hrs as 0,2,8,32
    # and tables were renamed to 00,02,08,32, so change script
    # next time it's loaded.
    cd ucsc_formats
cat > load.csh << 'EOF'
    foreach f (bed/*.bed)
        set base = $f:t:r
        set info = `echo $f:t | sed 's/EC_HL60_RA_\([^_][^_]*\)_\([0-9][0-9]*\)hr.*/\1.\2/'`
        set hrs = `expr $info:e + 0`
        set exp = `echo $info:r |  \
                        sed -e 's/RNApol2/ChIpRnap/' -e 's/RNA/Rna/'`
        if ($exp == "Rna") then
            set meas = "Sig"
        else
            set meas = "Pval"
        endif
        set track = encodeAffy${exp}Hl60SitesHr$hrs
        sed '1d' $f | \
            hgLoadBed -noBin hg16 $track stdin
        set ct = `hgsql -N -s -e "select count(*) from $track" hg16`
        echo "track $track"
        echo "$f:t	$ct"
        set track = encodeAffy${exp}Hl60${meas}Hr$hrs
        sed '/^track/d' wig/$base.wig | wigEncode stdin $track.wig $track.wib
        ln -s `pwd`/$track.wib /gbdb/hg16/encode/Affy/2004-12-03/wib
        # load into database
        hgLoadWiggle hg16 ${track} $track.wig \
                    -pathPrefix=/gbdb/hg16/encode/Affy/2004-12-03/wib
    end
'EOF'
    # << for emacs
    csh load.csh >&! load.log &
    grep EC_HL60 load.log | grep -v wig > loaded.txt
    # email loaded.txt to contributor
    awk '{print $1}' bed/*.bed | sort | uniq > chroms.txt
    # use in trackDb chromosomes setting
    grep encodeAffy load.log > trackDb.ra
    # use as basis of hg16 trackDb entries
    # (create 4 composite tracks)

    cd description
    # edit
    cp EC_HL60_RA_RNA_00hr_AS_hs.NCBIv34.bed.dsc encodeAffyRnaHl60Sites.html
    cp EC_HL60_RA_RNA_00hr_AS_hs.NCBIv34.wig.dsc encodeAffyRnaHl60Sig.html
    cp EC_HL60_RA_RNApol2_00hr_AS_hs.NCBIv34.bed.dsc encodeAffyChIpRnapHl60Sites.html
    cp EC_HL60_RA_RNApol2_00hr_AS_hs.NCBIv34.wig.dsc encodeAffyChIpRnapHl60Pval.html


# TODO: Remove Nov08 data

# GENCODE Sanger Havana annotations
    ssh hgwdev
    mkdir -p /cluster/data/encode/sanger/havana
    cd /cluster/data/encode/sanger/havana
    wget --timestamping --force-directories --directory-prefix=. \
	--dont-remove-listing --recursive --level=3 --no-parent \
	--no-host-directories --cut-dirs=5 \
	"ftp://genome.imim.es/pub/other/gencode/data/havana-encode/*"
#  This fetches the directories:
#	drwxrwxr-x  2 4096 Mar  7 16:01 CHR_coord
#	drwxrwxr-x  2 4096 Mar  7 16:02 ENCODE_coord
#	-rw-r--r--  1 2874 Feb 10 13:44 README.txt
#	drwxrwxr-x  4 4096 Mar  7 16:02 old

    ldHgGene -gtf hg16 encodeSangerGencode CHR_coord/EN????_CHR_coord.gtf
    #	Read 777 transcripts in 11213 lines in 12 files
    #	777 groups 8 seqs 16 sources 3 feature types
    # trackDb entry placed into human/trackDb.ra
track encodeSangerGencode
shortLabel Gene/Havana
longLabel Gencode annotations - Sanger Havana group predictions
group encode
priority 113
visibility hide
color 170,100,0
type genePred
