#These are instructions for building the
#neighborhood browser.

# Set up some variables and make working directory
ssh hgwdev
set db = hg16
set dbDir = /cluster/data/$db
mkdir -p $dbDir/bed/near
cd $dbDir/bed/near

# Extract peptides from knownGenes into fasta file
# and create a blast database out of them.
cd $dbDir/bed/near
pepPredToFa $db knownGenePep known.faa
mkdir blastDb
cd blastDb
formatdb -i ../known.faa -p T -t known -n known
cd ..

# Copy over database to iscratch/i
ssh kkr1u00
if (-e /iscratch/i/$db/known) then
   rm -r /iscratch/i/$db/known
endif
mkdir -p /iscratch/i/$db/known
cp $dbDir/bed/near/blastDb/known.* /iscratch/i/$db/known

# Load up iscratch/i with blastp and related files
# if necessary
if (! -e /iscratch/i/blast/blastall) then
    mkdir -p /iscratch/i/blast
    cp /projects/compbio/bin/i686/blastall /iscratch/i/blast
    mkdir -p /iscratch/i/blast/data
    cp /projects/compbio/bin/i686/data/* /iscratch/i/blast/data
endif
iSync

# Split up fasta file into bite sized chunks for cluster
cd $dbDir/bed/near
mkdir split
faSplit sequence known.faa 6000 split/split

# Make parasol run directory 
ssh kk
cd $dbDir/bed/near
mkdir run
cd run
mkdir out

# Make blast script
cat > blastSome <<end
#!/bin/csh
setenv BLASTMAT /iscratch/i/blast/data
/iscratch/i/blast/blastall -p blastp -d /iscratch/i/hg15/known/known -i \$1 -o \$2 -e 0.01 -m 8 -b 1000
end
chmod a+x blastSome

# Make gensub2 file
cat > gsub <<end
#LOOP
blastSome {check in line+ \$(path1)} {check out line out/\$(root1).tab}
#ENDLOOP
end

# Create parasol batch
ls -1 ../split/*.fa > split.lst
gensub2 split.lst single gsub spec
para create spec
para try

# Wait a couple of minutes, and do a para check,  if all is good
# then do a
para push
# This should finish in 5-10 minutes if the cluster is free.

#Completed: 5815 of 5815 jobs
#CPU time in finished jobs:     125571s    2092.84m    34.88h    1.45d  0.004 y
#IO & Wait Time:                 24734s     412.24m     6.87h    0.29d  0.001 y
#Average job time:                  26s       0.43m     0.01h    0.00d
#Longest job:                      259s       4.32m     0.07h    0.00d
#Submission to last job:           438s       7.30m     0.12h    0.01d

# Load into database.  This takes about an hour.
ssh hgwdev
cd $dbDir/bed/near/run/out
hgLoadBlastTab $db knownBlastTab *.tab
#### DONE TO HERE FOR HG16 ####

# Create a table that maps between known genes and 
# the nice affyUcla expression data.
hgMapBedToGene $db knownGene affyUcla knownToAffyUcla

# Create expression distance table.  This will take about an hour.
cd ~/src/hg/near/hgExpDistance
hgExpDistance $db affyUcla affyUclaExp knownExpDistance -weights=affyUcla.weight -lookup=knownToAffyUcla

# New Column domains
# Add the domain structure of SWISSPROT and TrEMBL proteins according to Pfam
mkdir -p ~/hg15/bed/nearDomain
cd ~/hg15/bed/nearDomain

wget ftp://ftp.genetics.wustl.edu/pub/Pfam/swisspfam.gz
