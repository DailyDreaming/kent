#These are instructions for building the
#neighborhood browser.

# Set up some variables and make working directory
ssh hgwdev
set db = hg15
set dbDir = /cluster/store5/gs.16/build33
mkdir $dbDir/bed/near
cd $dbDir/bed/near

# Extract peptides from knownGenes into fasta file
# and create a blast database out of them.
cd $dbDir/bed/near
pepPredToFa $db knownGenePep known.faa
mkdir blastDb
cd blastDb
formatdb -i ../known.faa -p T -t known -n known
cd ..

# Copy over database to iscratch/i
ssh kkr1u00
if (-e /iscratch/i/$db/known) then
   rm -r /iscratch/i/$db/known
endif
mkdir -p /iscratch/i/$db/known
cp $dbDir/bed/near/blastDb/known.* /iscratch/i/$db/known

# Load up iscratch/i with blastp and related files
mkdir -p /iscratch/i/blast
cp /projects/compbio/bin/i686/blastall /iscratch/i/blast
mkdir -p /iscratch/i/blast/data
cp /projects/compbio/bin/i686/data/* /iscratch/i/blast/data
iSync


# Split up fasta file into bite sized chunks for cluster
cd $dbDir/bed/near
mkdir split
faSplit sequence known.faa 6000 split

# Make parasol run directory 
mkdir run
cd run
mkdir out

# Make blast script
cat > blastSome <<end
setenv BLASTMAT /iscratch/i/blast/data
/iscratch/i/blast/blastall -p blastp -d /iscratch/i/hg15/known/known -i $1 -o $2 -e 0.01 -m 8 -b 1000
end
chmod a+x blastSome

# Make gensub2 file
cat > gsub <<end
#LOOP
blastSome {check in line+ $(path1)} {check out line $(path2)}
#ENDLOOP
end

# Create parasol batch
ls -1 ../split/*.fa > split.lst
gensub2 split.lst single gsub spec
para create spec
para try

# Wait a couple of minutes, and do a para check,  if all is good
# then do a
para push
# This should finish in 5-10 minutes if the cluster is free.

# Load into database
ssh hgwdev
mkdir $dbDir/bed/near/run/out
hgLoadBlastTab $db knownBlastTab *.tab

# Create a table that maps between known genes and 
# the nice affyUcla expression data.
hgMapBedToGene $db knownGene affyUcla knownToAffyUcla

# Create expression distance table.  This will take about an hour.
cd ~/src/hg/near/hgExpDistance
hgExpDistance $db affyUcla affyUclaExp knownExpDistance -weights=affyUcla.weight -lookup=knownToAffyUcla
